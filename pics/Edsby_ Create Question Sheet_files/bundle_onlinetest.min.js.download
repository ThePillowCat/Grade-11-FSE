/**
 * Version: baf4caef7b0dd7471dd76c3dc5db25e58fe75145ce31e12f9f3da02c27b2a1fb
 * Bundle: onlinetest
 **/

cf.resources.confirm('bundle_onlinetest', function() {

/* resources: OnlineTestCreate */

"use strict";cf.resource("OnlineTestCreate",function(e,t,a,n){var s,i=e.get("gradebook");if(i)var r=i.standardsSchemes;else r=["gs_standards_glo","gs_standards","gs_standards_strand"];function o(e,t){for(var a=e.length-1;a>0;a--){var n=Math.floor(t*(a+1)),s=e[a];e[a]=e[n],e[n]=s}return e}function d(t,a){var n,s,i=t.state.get("sections");for(var r in i){var o=i[r];if(a.thread==o.thread){n=o,s=r;break}}if(n&&!n._new){var d={url:{xds:t.global("xdsQuestionSave"),nid:n.nid},data:{index:s,nquestions:n.questions.length}};e.post(d)}}function l(e){var t=arguments.length>1&&arguments[1]!==n&&arguments[1],a=arguments.length>2&&arguments[2]!==n&&arguments[2],s=e.state.get("masterQuestions"),i=c(e.state.get("sections"));s.map(function(s){var r=i[s.thread];if(r||(r=i[Object.keys(i)[0]],s.thread=r.thread),r){var o=s.index;s.idxOrig===n&&(s.idxOrig=s.index),s.index=r.questions.length,!1!==a&&s.index>=a&&(s.index+=1),s.pnid=e.nid(),r.questions.push(s),(o!=s.index||s.idxOrig!=s.index||t)&&e.newEvent("OnlineTestCreate.questionSave",{nid:s.nid,cnid:"".concat(e.state.top().get("nid"),"/").concat(s.rid,"/").concat(s.nid)})}})}function c(e){var t={};return e.map(function(e){t[e.thread||"-1"]=e,e.questions=[]}),t}function u(t,a,n,s){var i={url:{nid:a,xds:t.arg("xdscopy"),command:"copy",_dest:t.state.top().get("nid"),_new:!0,secnid:t.state.get("nid"),qindex:n},data:{secnid:t.state.get("nid"),qindex:n},xdo:t,callback:s};e.post(i)}function g(e,t,a){l(e,!0,a);var n={qsnid:t.nid,qstitle:e.state.top().get("testName"),nid:e.get_xdo("*settings").cnid()};if(18==e.state.top().get("rt")){var s=e.get_xdo("*settings").cnid(),i=s.split("/")[0],r=e.get_setting("url");r=(r=r.replace(i,s)).replace("create","node"),e.set_setting("url",r),n.url=r}e.get_xdo("*settings").newEvent("reload",n)}function p(e){return e=(e=""+e).replace("%",""),e=+(e=(e/=100).toFixed(2))}function f(e,t,a){var s=new RegExp(t,"g"),i=e.matchAll(s),r=!0,o=!1,d=n;try{for(var l,c=i[Symbol.iterator]();!(r=(l=c.next()).done);r=!0){var u=l.value,g=u[0].split("/");g.splice(2,g.length-3,a),g.join("/"),g=g.join("/"),e=e.replaceAll(u[0],g)}}catch(e){o=!0,d=e}finally{try{r||null==c.return||c.return()}finally{if(o)throw d}}return e}var h={defaultQuestion:{type:1,outof:1,answers:[{}],nodetype:e.nt.Document.OnlineTestQuestion()},defaultSection:{quantity:-1,index:0,nodetype:e.nt.Document.OnlineTestSection()},selectScheme:function(t){var a=e.user.gradeSchemes,n=[{display:e.lang("Out Of"),value:"gs_outof"}];for(var s in a)"points"!==a[s].mapping||a[s].disabled||n.push({display:a[s].title,value:s,group:a[s].group});t.state.setnx("scheme","gs_outof"),t.inherit("dd.select",{list:n,defaultValue:"gs_outof"})},onSchemeSelect:function(e){i.standardsSchemes.includes(e.val())?e.get_xdo("*standardsWidget").xds.validate="required":e.get_xdo("*standardsWidget").xds.validate="",e.get_xdo("*standardsWidget").update()},studentCol:function(t){if("0"==t.data)t.exitBlank();else try{var a,n=e.user.gradeSchemes[t.state.top().get("scheme")];if(n&&(r.includes(n.name)||r.includes(n.group)))var s=t.state.get("standards"),o=i.gradebook.prototype.convertStrandsToCols(i.gradebook.prototype.convertStandardsToStrands(s));else if("gs_strands"===n.name||"gs_strands"===n.group)o=i.gradebook.prototype.convertStrandsToCols(t.state.get("strands"));else o=JSON.parse(e.user.gradeSchemes[t.state.top().get("scheme")].cols);o.map(function(e){t.data===e.name&&(a=e.title)}),a&&(t.displayVal=a)}catch(e){t.exitBlank()}},col:function(t){delete t.xds._children,delete t.xds.fields,t.showTitle=!0;try{var a=e.user.gradeSchemes[t.state.top().get("scheme")];if(a&&(r.includes(a.name)||r.includes(a.group))){t.ready("hide",{target:"*addStandards"}),t.state.data.addStandards=!1;var n=t.state.top().get("standards"),s=i.gradebook.prototype.convertStrandsToCols(i.gradebook.prototype.convertStandardsToStrands(n,i.standardsLevelMap[a.group]));t.on("xds-picker-picked",function(e){var t=e.val();e.state.set("standards",t),e.rnode.standards=t})}else if("gs_strands"===a.name||"gs_strands"===a.group){if(t.state.get("strandsObject"))s=i.gradebook.prototype.convertStrandsToCols(t.state.get("strandsObject"))}else s=JSON.parse(a.cols);var o=[];s.map(function(e){o.push({value:e.name,display:e.title})})}catch(e){return t.data="0",t.inherit("f_hidden"),void(t.showTitle=!1)}t.inherit("dd.select",{list:o})},initialize:function(t,a){var n=e.clone(h.defaultSection),s=e.clone(h.defaultQuestion),i=[n],r=!0,o=t.state.get("masterQuestions");o.length||(o=[s],r=!1),n.nquestions=o.length||1,e.post({url:{xds:"OnlineTestQuestionCreate",nid:t.nid(),command:"create",section:!0},data:n,success:function(d){n.nid=d.nid,n.rid=d.rid,n.thread=d.nid,r?o.map(function(a){a.thread=n.nid,e.post({url:{xds:"OnlineTestQuestionCreate",nid:e.nodePath([t.nid(),a.rid,a.nid])},data:a})}):(s.thread=n.nid,e.post({url:{xds:"OnlineTestQuestionCreate",nid:t.nid(),command:"create"},data:s,success:function(e){s.nid=e.nid,s.rid=e.rid,s.index=0,t.state.set("masterQuestions",o),t.state.set("sections",i),a()}}))}})},addQuestion:function(t){var a=t.state.get("masterQuestions"),n=e.clone(h.defaultQuestion);n.index=a.length,n.thread=t.nid(),e.post({url:{xds:t.get_arg("xds"),nid:t.nid("node"),command:"create"},data:n,success:function(e){n.rid=e.rid,n.nid=e.nid,a.push(n),t.get_xdo("*body").update(),d(t,n)}})},doQuestionCopy:function(t){var a=e.get("copier").clipboard(t),s=a.from,i=a.command;if(a.from&&a.command){var r=t.get_arg("offset")!==n?t.get_arg("offset"):1,o=Math.max(t.state.get("index")+r,0);t.arg("xdscopy",t.get_arg("xdscopy"));u(t,s,o,function(a){var r=t.state.get("questions"),d=0,l=!0,c=!1,u=n;try{for(var p,f=r[Symbol.iterator]();!(l=(p=f.next()).done);l=!0){var h=p.value;if(d+=1,h.nid==s)break}}catch(e){c=!0,u=e}finally{try{l||null==f.return||f.return()}finally{if(c)throw u}}r.splice(d,1),"cut"===i?(e.get("copier")._utils.clearBuffer(t),e.post({url:{command:"delete",nid:"".concat(t.state.top().get("nid"),"/").concat(s),xds:t.global("xdsQuestionSave")},callback:function(){var e=t.state.get("masterQuestions");e=e.filter(function(e){return e.nid!=s}),t.state.set("masterQuestions",e),g(t,a,o)},errorDialog:!0})):g(t,a,o)})}},openQuestionBankPicker:function(t){t.newEvent("lightbox",{nid:e.gbl.user.nid,xds:t.get_arg("xds")}).then(function(e){var a=t.state.get("questions").length,s=0;if(e.altprops&&e.altprops.selections){var i=!0,r=!1,o=n;try{for(var d,l=function(){var n=d.value;u(t,n,a+s,function(s){n==e.altprops.selections[e.altprops.selections.length-1]&&g(t,s,a)}),s+=1},c=e.altprops.selections[Symbol.iterator]();!(i=(d=c.next()).done);i=!0)l()}catch(e){r=!0,o=e}finally{try{i||null==c.return||c.return()}finally{if(r)throw o}}}})},addSection:function(t){var a=t.state.get("sections"),n=(t.state.get("masterQuestions"),e.clone(h.defaultSection));n.index=a.length,n.name="Section "+(a.length+1);var s=t.get_arg("xds");e.post({url:{xds:s,nid:t.nid(),command:"create",section:!0},data:n,success:function(e){n.nid=e.nid,n.thread=e.nid,n.rid=e.rid,a.push(n),t.get_xdo("*body").update();var s=t.find(".OnlineTestCreate-body-section-wrap-addQuestion",!0),i=s[s.length-1].id,r=t.get_target("#"+i,!0).xdo;r.args={xds:t.global("xdsQuestionSave")},h.addQuestion(r)}})},addSheetStandards:function(e){var t=e.state.top().get("standards")||"",a=e.val();t=t.split(","),a=a.split(","),t=t.concat(a),(t=new Set(t)).delete(""),t=Array.from(t).join(","),e.state.top().set("standards",t),e.get_xdo("*settings").get_xdo("*standards").set(t),e.get_xdo("*settings").get_xdo("*standards").update()},init:function(t){t.global("OnlineTestSubmitted")&&0==t.get_val("published")&&t.exit(!0),t.global("xdsQuestionSave",t.arg("xdsQuestionSave"));var a=t.global("TestBook");t.state.get("feedbackView");s=e.constant.OnlineTestQuestionTypes;var i=t.state.get("masterQuestions")||t.get_val("qList");i&&(i=e.sort({sortBy:"index",sortType:"float"},e.obj_to_arr(i)));var r=i;r||((r=[]).time=Date.now()),t.state.set("masterQuestions",r);var d=t.state.get("sections")||t.state.get("sList");if(!d){if(!a&&!t.global("readonlyForm"))return h.initialize(t,function(){t.update()}),void t.exitBlank();d=[e.clone(h.defaultSection)]}d=e.sort({sortBy:"index",sortType:"int"},e.obj_to_arr(d)),t.state.set("sections",d);var l=c(d);if(r.map(function(s){var i;(i=l[s.thread])||!a&&!t.global("readonlyForm")?i||(i=l[Object.keys(l)[0]],s.thread=i.thread):l[-1]?i=l[-1]:((i=e.clone(h.defaultSection)).thread=-1,l[-1]=i,i.questions=[],d.push(i));if(i&&(s.idxOrig===n&&(s.idxOrig=s.index),s.index=i.questions.length,s.pnid=t.nid(),i.questions.push(s)),e.is_rich(s.question)){s.question=f(s.question,/core\/nodedl\/[0-9]+\/[0-9]+\/[0-9]+(?=\?field=rtefile)/,s.nid)}if(s.answers)for(var r in s.answers)if(s.answers[r].answer&&(s.answers[r].answer=e.unescapeRichText(s.answers[r].answer),e.is_rich(s.answers[r].answer))){s.answers[r].answer=f(s.answers[r].answer,/core\/nodedl\/[0-9]+\/*([0-9]+)*\/[0-9]+(?=\?field=otanswerfile)/,s.nid)}}),a){var u=t.get_val("student-randomSeed");d.map(function(t){var n=t.questions;a.randomQ&&(n=o(n,u)),n.map(function(t){t.answers&&(t.answers.map(function(t,a){t.index=a,e.is_rich(t.answer)||(t.answer=e.mlescape(t.answer))}),a.randomA&&(t.answers=o(t.answers,u)))})})}},setupQuestions:function(e){},markChanged:function(e){e.rnode._changed=!0},instructions:function(e){if(e.state.top().get("studentView")||e.global("ScoreBook"))return!1;if(!e.rnode._changed&&!e.rnode._new)return!1;var t=e.state.get("type");t==s.likert()&&(t=s.trueFalse()),e.displayVal=e.arg("title"+t)},correctIndicator:function(e){var t=e.xds.cdid,a=e.state.get("type");if(e.state.top().get("studentView")&&!e.global("TestBook")&&(e.data=""),e.rnode.answered?a!=s.match()&&a!=s.gapfill()&&(e.data=1):e.global("ScoreBook")&&(e.data=""),a==s.multipleChoice()||a==s.trueFalse()||a==s.likert())e.inherit("f_radio",{"data-value":e.get_val("index"),checked:e.get_val(),legacy:!0});else{if(a==s.shortAnswer()||a==s.dragdrop()||a==s.numerical())return!1;if(a==s.match()){if(e.state.top().get("studentView")){if(!e.global("TestBook")&&!e.state.get("abank")){e.get_val("answer")||e.exit(!0);var n=e.state.get("answers").map(function(e){return{display:e.correct,value:e.correct}});e.state.set("abank",n)}var i=e.state.get("abank")||[{display:1,value:1}];e.inherit("dd.select",{list:i})}else{var r={message:e.arg("titleValidate"),type:function(e){return!(e.get_val("answer")&&!e.get_val("correct"))}};e.on("validate","validate",r),e.inherit("f_str",{placeholder:"Answer"})}e.addClass("match-answer")}else if(a==s.gapfill()){if(!e.state.top().get("studentView")||!e.global("TestBook"))return!1;e.addClass("gapfill-answertext"),2!=e.state.get("filldisplay")?e.inherit("dd.select",{list:e.state.get("abank")}):e.inherit("f_str"),e.rnode.answered&&2!=e.state.get("filldisplay")?e.addClass("xds-onlineTest-answered-gapfill"):e.rnode.answered&&e.addClass("xds-onlineTest-answered")}else e.inherit("f_checkbox")}if(e.global("readonlyForm"))a!=s.match()||e.state.get("answer")||e.exit();else{var o=a==s.match()||a==s.gapfill()&&2!=e.state.get("filldisplay")?"xds-picker-picked":"click change";e.on(o,function(e){if(!e.temp.saved){e.temp.saved=!0;var n=e.get_val("answers");a==s.multipleChoice()||a==s.trueFalse()||a==s.likert()?(n.map(function(n,i){a==s.multipleChoice()&&i!==e.get_index()&&n.correct&&(n.gprop="0.00%"),delete n[e.xds.id],delete n[t],delete n.matchIndicator}),a==s.multipleChoice()&&(n[e.get_index()].gprop="100.00%"),n[e.get_index()][t]=1,e.get_xdo("*question").update()):n[e.get_index()][t]=e.val(),e.newEvent("OnlineTestCreate.questionSave")}setTimeout(function(){delete e.temp.saved})})}e.title=1},gradeProportion:function(e){e.val()||(e.state.get("type")==s.multipleChoice()&&e.state.get("guid")&&(e.get_val("correct")?e.set("100.0%"):e.set("0.0%")),e.state.get("type")==s.shortAnswer()&&e.state.get("guid")&&e.set("100.0%")),e.on("input",function(e){var t=e.val().split(""),a=!1,n=0,s=1,i=[],r=0;"-"===t[0]&&(n=1,t.splice(0,1));var o=t.length;for(var d in t){var l=t[d];if("%"!==l||d==o-1){if(0==r&&1!=l?s=!1:1==r&&0!=l?s=!1:2==r&&0!=l&&(s=!1),"%"===l){if(!1===a)i.push("."),i.push("0");else for(;r-a<2;)i.push("0"),r++;i.push(l);break}if("."===l){if(a||1!=r&&2!=r&&(3!=r||!s))continue;a=r}isNaN(l)&&"%"!==l&&"."!==l||(r!=2+s||a||"."===l||(i.push("."),a=2+s,o++,r++),(1==a&&r>3||2==a&&r>4||3==a&&r>5)&&(l="%"),i.push(l),r++)}}n&&(i=["-"].concat(i)),i=i.join(""),e.val(i)}),e.on("change",function(e){var t=e.val().split("");if("%"!=t[t.length-1]){var a=t.indexOf(".");-1==a?(t.push("."),t.push("0")):t.length-1==a&&t.push("0"),t.push("%")}t=t.join(""),e.val(t)}),e.inherit("f_number",{min:-100,max:100})},sectionQuantity:function(e){for(var t=[{display:e.arg("titleAll"),value:-1}],a=e.caller().state.get("questions"),n=a[0].questionSettings.outof,s=a[0].questionSettings.col,i=1;i<a.length;i++){if(a[i].questionSettings.outof!=n||a[i].questionSettings.col!=s){t=[{display:e.arg("titleAll"),value:-1}];break}t.push({value:i,display:i})}e.inherit("dd.select",{list:t})},section:function(t){if(!t.data.name){var a=t.get_index()+1;t.state.set("name","Section "+a)}var n,s=t.state.get("questions").length,i=t.arg("qtemplate");1===s?n=t.arg("qsingular"):s>1?n=t.arg("qplural"):i="?";var r=e.tpl(i,{qt:n,numq:s});t.state.set("confirmText",r)},question:function(t){var a,i=t.get_val("answers")||[{}],o=t.state.get("type"),d=e.lookup("OnlineTestQuestionTypes",o).params,l=d.extendable===n||d.extendable;o!=s.trueFalse()||2==i.length&&i.length?o!=s.likert()||5==i.length&&i.length?o==s.numerical()&&(i.length>1||!i.length||isNaN(i[0].answer))?a=i=[{answer:i.length&&!isNaN(i[0].answer)?i[0].answer:"0",index:0,tolerance:0}]:o==s.gapfill()&&i.length&&(a=i=i.map(function(t){return e.is_rich(t.answer)&&(t.answer=""),t})):(a=i=[{answer:d.title1,index:0},{answer:d.title2,index:1},{answer:d.title3,index:2},{answer:d.title4,index:3},{answer:d.title5,index:4}],t.state.data.DefaultAnswers=!0):a=i=[{answer:d.titleTrue},{answer:d.titleFalse}],t.state.data.standards&&(t.state.data.addStandards=!0);var c=e.user.gradeSchemes[t.state.top().get("scheme")];c&&(r.includes(c.name)||r.includes(c.group))&&(t.state.data.addStandards=!0),a=i&&h.sanitizeAnswers(i,o,t.state.top().get("studentView"),"r"),l&&a&&!t.state.top().get("studentView")&&!t.global("TestBook")&&a.push({}),t.state.get("showRT_idx")&&(t.data.answers[t.state.get("showRT_idx")].showRT=!0,t.state.set("showRT_idx",n)),t.state.data.answers=t.data.answers=a,t.map(),t.get_setting("qsnid")==t.nid()&&t.newEvent("scrollTo")},comment:function(t){var a=t.get_val("student-nid"),n=t.nid(),i=t.global("ScoreBook");if(t.state.get("type")!=s.paragraph()||!i)return t.exit(!0);t.set(i.getAttr(a,n,"c")),t.xds_this.xdsSetAnswer&&t.has_write(t.xds_this.xdsSetAnswer)&&!t.has_role("Student")&&(t.inherit("f_textarea",{readonly:!1}),t.on("change",function(e){i.saveGrade({snid:a,anid:n,attr:"c",value:e.val(),xds:e.xds_this.xdsSetAnswer})}),t.on("keyup",e.noop,{stopPropagation:!0,keyCode:13}))},dropRegion:function(e){e.state.get("type")==s.dragdrop()&&e.state.top().get("studentView")?e.tag("ul"):e.exitBlank()},answers:function(e){var t=e.global("TestBook"),a=e.global("ScoreBook"),i=e.state.get("type");if(i){if(i==s.multipleChoice()||i==s.trueFalse()||i==s.likert())e.inherit("f_radioGroup",{legacy:!0});else if(i==s.paragraph())a&&e.addStyle({width:"100%",display:"inline-block","box-sizing":"border-box",margin:0}),e.state.top().get("studentView")?(t||(e.data=""),e.inherit("f_textarea"),e.exit()):(e.data=!1,e.inherit("f_textarea",{readonly:"readonly"}),e.exit());else if(i==s.shortAnswer()||i==s.numerical()){if(e.state.top().get("studentView")){var r=i==s.shortAnswer()?"f_textarea":"f_number";t||(e.data=""),e.inherit(r,{nopicker:!0}),i==s.shortAnswer()&&e.addClass("xds-OnlineTestCreate-answers-short"),e.exit();var o=e.global("ScoreBook")&&e.global("ScoreBook").getGrade(e.get_val("student-nid"),e.nid(),e.state.get("col")||"0");o!==n&&(o==e.rnode.outof?e.addClass("xds-OnlineTestCreate-answers-correct"):e.addClass("xds-OnlineTestCreate-answers-incorrect"))}}else i==s.dragdrop()?e.tag("ul"):i==s.gapfill()&&e.state.top().get("studentView")&&e.addClass("xds-OnlineTestCreate-answers-gapfill");var d;if(e.state.get("studentView")){d={message:e.arg("titleValidate"),type:function(){var a,i=e.nid(),r=e.get_val("student-nid");for(var o in t.assessments[i].columns){if((a=t.getGrade(r,i,o||"0"))===n||""===a)return!1;if(e.state.get("type")==s.match()){var d=(a+"").split("-"),l=!0,c=!1,u=n;try{for(var g,p=d[Symbol.iterator]();!(l=(g=p.next()).done);l=!0)if(!g.value.split(":")[1])return!1}catch(e){c=!0,u=e}finally{try{l||null==p.return||p.return()}finally{if(c)throw u}}}}return!0}}}else d={message:e.arg("titleValidate"),type:function(e){if(i==s.paragraph())return!0;if(i==s.gapfill()){var t=e.state.get("question");if(!new RegExp("\\[[^\\]]+\\]","g").test(t))return!1;if(2==e.state.get("filldisplay"))return!0}var a=e.rnode.answers;if(i==s.numerical()&&a[0].answer)return!0;if(a.length<=1)return!1;if(i==s.multipleChoice()||i==s.trueFalse()||i==s.likert()){var n=!1;for(var r in a)if(a[r].correct&&a[r].answer){n=!0;break}if(!n)return!1}else s.match();return!0}};e.on("validate","validate",d)}else e.exit()},responseIndicator:function(e){if(e.global("ScoreBook")&&e.global("ScoreBook").getGrade(e.get_val("student-nid"),e.nid(),e.state.get("col")||"0")!==n){var t,a=e.state.get("type");e.rnode.answered&&(e.rnode.correct||a==s.multipleChoice()&&e.rnode.gprop&&1==p(e.rnode.gprop))&&(t="check",e.addClass("xds-onlineTest-correctResponse")),a==s.multipleChoice()||a==s.trueFalse()||a==s.likert()?e.rnode.correct&&!e.rnode.answered?t="success-arrow":e.rnode.answered&&!e.rnode.correct&&(e.state.get("DefaultAnswers")||a==s.multipleChoice()&&e.rnode.gprop&&1==p(e.rnode.gprop)||(t="times",e.addClass("xds-onlineTest-incorrectResponse"))):a==s.chooseAll()?e.rnode.correct&&!e.rnode.answered?(t="times",e.addClass("xds-onlineTest-incorrectResponse")):!e.rnode.correct&&e.rnode.answered?(t="times",e.addClass("xds-onlineTest-incorrectResponse")):e.rnode.correct||e.rnode.answered||(t="check",e.addClass("xds-onlineTest-correctResponse")):a==s.shortAnswer()?(t="check",e.addClass("xds-onlineTest-correctResponse")):a==s.match()||a==s.gapfill()?e.rnode.answered==e.rnode.correct?(t="check",e.addClass("xds-onlineTest-correctResponse")):e.rnode.correct&&(t="times",e.addClass("xds-onlineTest-incorrectResponse")):a==s.dragdrop()&&(e.get_index()==e.rnode.index?(t="check",e.addClass("xds-onlineTest-correctResponse")):(t="times",e.addClass("xds-onlineTest-incorrectResponse"))),t&&e.inherit("fa.icon",{icon:t,fa_class:"fas"})}else e.state.get("type")==s.gapfill()&&e.exit(1)},answer:function(e){var t=e.state.get("type");if(e.rnode.answered&&t!=s.gapfill()&&e.addClass("xds-onlineTest-answered"),t==s.dragdrop()){if(e.state.get("studentSorted")&&e.addSubClass("studentSorted"),e.tag("li"),e.state.top().get("studentView"))return void e.addSubClass("dragdrop")}else t==s.match()?e.state.top().get("studentView")&&e.addClass("match-answer-container"):t==s.gapfill()&&e.state.top().get("studentView")&&e.addClass("gapfill-answer");e.state.get("answer")||t==s.match()&&e.state.get("correct")||e.addStyle("opacity",.7),e.on("input",function(e){clearTimeout(e.temp.timer),e.temp.timer=setTimeout(function(){var a=e.eventSource().xdo;"answer"==a.xds.cdid&&"editor"==a.xds.id?(e.rnode.guid||e.state.scope("parent").set("showRT_idx",e.get_index()),e.rnode.answer=e.state.get("answer")):e.rnode[a.xds.cdid]=a.val();var n=e.rnode.answer||t==s.match()&&e.rnode.correct;if(!e.global("TestBook")){var i=e.get_xdo("*question");clearTimeout(i.saveTimer),i.saveTimer=setTimeout(function(){i.newEvent("OnlineTestCreate.questionSave")},1e3),(!n||!e.rnode.guid)&&i.update()}},100)}),e.on("keyup",function(e){e.parent_xdo().dom().find(".xds-OnlineTestCreate-answerText",1).last().focus()},{keyCode:13})},score:function(t){if(t.state.top().get("studentView")&&(!t.global("ScoreBook")||t.has_role("Student")&&!1===t.data))return!1;var a=t.get_val("student-nid"),i=t.nid(),r=t.global("ScoreBook"),o=r&&r.getAttr(a,i,"l");if((t.state.get("type")==s.paragraph()||o)&&!t.has_role("Student")&&e.get("gradebook")[e.gbl.nid]!=n){var d=t.data;!1===d&&(t.state.set("unmarked",!0),d=""),t.tag("input"),t.addAttr("value",d),t.displayVal="",t.addStyle("width","20px"),t.on("keydown",function(e){e.stopPropagation()})}},studentOutOf:function(e){if(!e.state.top().get("studentView"))return!1},questionSettings:function(e){if(e.state.top().get("studentView"))return!1;var t=function(e){if(e.get_xdo("*cols")){var t=e.eventSource().xdo;if(t){var a=t.val();"outof"==t.xds.id&&(a=a>0?a:"1"),e.state.set(t.xds.id,a),e.rnode[t.xds.id]=a,e.newEvent("OnlineTestCreate.questionSave")}}};e.on("change xds-picker-picked",t),e.ready(t)},questionTitle:function(e){for(var t=e.get_index(),a=e.state.get("questions"),n=0,i=0;i<t;i++){a[i].type==s.label()&&(n+=1)}e.state.get("type")==s.label()?e.displayVal=e.arg("titlelabel")||"Instructions":e.displayVal="".concat(e.arg("titlequestion")||"Question"," ").concat(e.get_index()-n+1);var r=e.state.data.question;e.state.set("questiontitle",r),e.showTitle=!0,e.inherit("h2")},questionRichText:function(t){var a=t.state.get("question");if(!e.is_rich(a))return!1;t.state.top().get("studentView")||t.global("readonlyForm")||(t.addAttr("contentEditable",!0),t.addClass("input-imitator")),t.set(a),t.inherit("wysiwyg.draw",{sanitizeRule:"richtext",noFetchAttachList:!0})},prelabel:function(t){if(t.data){t.data=e.unescapeRichText(t.data+"</p>"),t.data=f(t.data,/core\/nodedl\/[0-9]+\/[0-9]+\/[0-9]+(?=\?field=rtefile)/,t.nid()),t.inherit("wysiwyg.draw",{sanitizeRule:"richtext",noFetchAttachList:!0})}},postlabel:function(t){if(t.data){t.data=e.unescapeRichText("<p>"+t.data),t.data=f(t.data,/core\/nodedl\/[0-9]+\/[0-9]+\/[0-9]+(?=\?field=rtefile)/,t.nid()),t.inherit("wysiwyg.draw",{sanitizeRule:"richtext",noFetchAttachList:!0})}},questionTextLoader:function(e){if(e.state.top().get("studentView"))e.exitBlank();else{var t={xds:e.arg("xds"),noPath:!0};e.global("readonlyForm")&&(t.readonlyForm=!0),e.on("OnlineTestCreate-loadEditor","loadxds",t),e.on("OnlineTestCreate-loadEditor","hide",{target:"*titleText"}),h.questionTextIsRich(e)||(e.addStyle("min-height","63px"),e.ready("loadxds",t),e.sparse=1)}},questionTextIsRich:function(t){return e.is_rich(t.state.get("question"))},reloadFiles:function(e){e.root_xdo().fetch(function(t){var a=e.rid();if(t&&t.OnlineTestCreate&&t.OnlineTestCreate.qList&&t.OnlineTestCreate.qList["r".concat(a)]){var n=t.OnlineTestCreate.qList["r".concat(a)];e.map({files:n.files}),e.update()}})},questionText:function(t){if(t.caller().state.top().get("studentView",t.path))return t.exitBlank();t.map({question:t.caller().state.data.question});var a=!1;t.on("input xds-addresources-upload-complete",function(){if(a){if(t.state.get("showRT")){var n=t.eventSource().xdo.get_xdo("*editor").val();e.is_rich(n)||(n=e.richCode+n)}else n=t.get_xdo("*simple").val();t.caller().state.data.question=t.caller().rnode.question=n,t.stale_form=!1,clearTimeout(t.temp.timer);var s="xds-addresources-upload-complete"===t.e.type;t.temp.timer=setTimeout(function(){if(s){var a=e.validate;e.validate=function(){return!0}}if(t.trigger("submit"),s){e.validate=a,t.on("ajax_post",function e(){t.off("ajax_post",e),t.target("caller").trigger("reloadFiles")})}},700)}else a=!0}),t.xds.suppressInitialFocus=!0,t.inherit("form"),e.is_rich(t.state.get("simple"))&&t.state.set("showRT",!0);var n=t.xds.fields;n.simple.__type||(n.simple.__type=n.simple.type,n.rich.__type=n.rich.type),9==t.caller().state.get("type")&&(n.simple.placeholder=t.arg("labelPlaceholder")||"Enter instructions"),t.state.get("showRT")?(n.simple.type="sys",n.rich.type=n.rich.__type):n.rich.type="sys"},answerText:function(t){var a=t.state.top().get("studentView"),n=t.state.get("type"),i=e.get("math").containsMath(t);a&&i&&t.ready(function(t){e.get("math").queueMathRender(t)});var r=e.is_rich(t.val());a&&n==s.dragdrop()||(a&&n==s.gapfill()?t.exit(!0):a&&n==s.numerical()?t.inherit("f_number"):a||n==s.trueFalse()?(t.on("click",function(e){e.parent_xdo().get_xdo("sibling:correctIndicator").trigger("click")}),r&&t.inherit("wysiwyg.draw",{sanitizeRule:"richtext"})):i&&t.global("readonlyForm")?(t.inherit("container"),t.ready(function(t){e.get("math").queueMathRender(t)})):r?(t.global("readonlyForm")||(t.addAttr("contentEditable",!0),t.addClass("input-imitator")),n==s.match()&&t.state.get("showRT")&&t.addClass("match-prompt-rich"),t.on("focusin",function(e){e.state.set("showRT",!0)}),t.inherit("wysiwyg.draw",{sanitizeRule:"richtext"})):n==s.gapfill()?t.inherit("f_str",{placeholder:"Distraction Answer"}):n==s.numerical()?t.inherit("f_number"):n==s.match()?(r||t.inherit("f_str",{placeholder:"Prompt"}),t.addClass("match-prompt")):t.inherit("f_str")),a&&!r&&(t.displayVal=e.mlescape(t.data))},answerTextRich:function(t){if(t.caller().state.top().get("studentView",t.path))return t.exitBlank();t.map({answer:t.caller().get_val("answer")});var a=!1;t.on("input",function(){a||(a=!0);var n=t.eventSource().xdo.get_xdo("*editor").val();e.is_rich(n)||(n=e.richCode+n),t.caller().state.data.answer=t.caller().rnode.answer=n}),t.xds.suppressInitialFocus=!0,t.inherit("form")},deleteAnswer:function(e){var t=e.state.get("type");if(t==s.trueFalse()||t==s.likert()||t==s.numerical())return!1;if(!e.state.top().get("studentView")&&(""!==e.get_val("answer")||t==s.match()&&e.get_val("correct")))e.on("click",function(e){e.rnode.answer="",t==s.match()&&(e.rnode.correct="",e.rnode.matchIndicator=""),e.trigger("input")}),e.inherit("icon");else{if(""!==e.get_val("answer"))return!1;e.inherit("icon"),e.addStyle("visibility","hidden")}},feedback:function(e){var t=e.state.get("type");if(e.get_val("submitted"))!e.data||!e.rnode.answered&&t!==s.dragdrop()?e.exit(!0):(e.addStyle("margin-left","40px"),e.addStyle("margin-top","5px"),e.inherit("f_textarea",{"min-height":"32px"}));else{var a=e.state.top().get("feedbackView");if(!e.state.top().get("studentView")&&a){if(!e.state.data.answer)return void e.exit(!0);e.inherit("f_str")}else e.get_val("submitted")||e.exit(!0)}},sanitizeAnswers:function(t,a,i){var r=arguments.length>3&&arguments[3]!==n?arguments[3]:"w",o=[];return t&&t.map(function(t){(t.answer||a==e.constant.OnlineTestQuestionTypes.match()&&t.correct||a==s.numerical()||a==s.gapfill()&&(t.prelabel!==n||t.postlabel!==n))&&(o.push(t),delete t._i,delete t._len,delete t.correctIndicator,delete t.matchIndicator,delete t.answerText,delete t.editor,delete t.showRT,delete t.numericaltolerance,t.guid||a==e.constant.OnlineTestQuestionTypes.match()&&i||(t.guid=e.get("guid").rfc4122().substr(0,8)),"w"===r&&t.gprop&&(t.gprop=p(t.gprop)),"r"===r&&t.gprop&&!isNaN(t.gprop)&&(t.gprop=(100*t.gprop).toFixed(2),t.gprop+="%"))}),o},collateColumns:function(e){var t,a={},i=e.state.get("masterQuestions"),r="",o=Object.values($.extend(!0,{},e.state.get("sections"))),d={};o=o.filter(function(e){return-1!=+e.quantity&&e.nquestions!=e.quantity}),t=c(o),o.map(function(e){d[e.thread||"-1"]=0}),i.map(function(e){if(e.type==s.paragraph())r=1;else if(e.type===s.label())return;var i=e.col||"0";if(a[i]||(a[i]=0),d[e.thread]!==n){if(d[e.thread]>=t[e.thread].quantity)return;d[e.thread]+=1}a[i]+=parseFloat(e.outof),a[i]=parseFloat(a[i].toFixed(2))}),e.get_xdo("*cols").val(JSON.stringify(a)),e.get_xdo("*manualGrade").val(r)},preSave:function(t){e.validate(t.get_xdo("*body"))&&(t.event("OnlineTestCreate.collateColumns"),18==t.state.get("rt")&&(t.build.buildMode="new"),t.event("ajax_post"))},deleteSection:function(t){var a=t.state.get("masterQuestions"),n=t.state.get("sections"),s=t.get_index(),i=n[s].questions.map(function(t){return e.post({url:{command:"delete",nid:"".concat(t.pnid,"/").concat(t.rid,"/").concat(t.nid),xds:"OnlineTestCreate"},errorDialog:!0}),t.nid});a=a.filter(function(e){return!i.includes(e.nid)}),t.state.top().set("masterQuestions",a),n.splice(s,1),n.map(function(e){delete e._i}),e.post({url:{command:"delete",nid:t.cnid(),xds:"OnlineTestCreate"},callback:function(){t.get_xdo("*body").update()},errorDialog:!0})},deleteQuestion:function(t){var a,n=t.state.get("masterQuestions"),s=t.nid();n.map(function(e,t){delete e._i,e.nid==s&&(a=t)});var i=n.splice(a,1)[0];"q"===(t.nid()+"").substr(0,1)?t.get_xdo("*body").update():e.post({url:{command:"delete",nid:t.cnid(),xds:t.global("xdsQuestionSave")},callback:function(){t.get_xdo("*body").update(),d(t,i)},errorDialog:!0}),l(t)},questionSave:function(t){if(!t.global("TestBook")){var a,n=t.state.get("masterQuestions"),i=t.get_arg("nid")||t.nid();n.map(function(t,n){t.nid==i&&(a=e.clone(t))}),a.type===s.label()&&(a.outof="0"),delete a.questionBody,delete a.questionSettings,delete a.question,a.nodetype=e.nt.Document.OnlineTestQuestion(),a.answers=a.answers&&JSON.stringify(h.sanitizeAnswers(a.answers,a.type,t.state.top().get("studentView"),"w")),e.post({url:{xds:t.global("xdsQuestionSave"),nid:t.get_arg("cnid")||t.cnid()},data:a,errorDialog:!0,callback:function(){var e=t.get_xdo("*settings");18==t.state.get("rt")&&(e.build.buildMode="new"),e.event("OnlineTestCreate.collateColumns")}})}},save:function(t){t.state.get("masterQuestions");var a=t.state.get("sections"),s=(t.get_arg("nid"),t.get_arg("xds")),i=0,r=0;function o(a){if(++r===i){t.set_setting("url",n),t.state.set("ssc",!0);var s=$(".xds-success");s.css({display:"inline-block",opacity:0,"margin-right":"3px"}),s.animate({opacity:1}),s.fadeOut(1e3),setTimeout(function(){!1!==t.arg("backOnSave")&&e.history.up()},1e3)}}t.state.set("saved",!0),a.map(function(t,a){var n={index:a,nquestions:t.questions.length};if(t.quantity!=t.questions.length&&t.questions.length)for(var r=t.questions[0].questionSettings.col,d=t.questions[0].questionSettings.outof,l=0;l<t.questions.length;l++){var c=t.questions[l];if(c.questionSettings.col!=r||c.questionSettings.outof!=d){n.quantity=-1;break}}t._new||(i++,e.post({url:{xds:s,nid:t.nid},data:n,success:o}))})},updateAnswers:function(e){e.get_xdo("*answers").update()}};return h});

/* resources: OnlineTestGrade */

"use strict";cf.resource("OnlineTestGrade",function(e,n,t,i){return{keydown:function(e){e.eventKeyIs([27,9,13,37,38,39,40])&&(e.preventDefault(),e.stopPropagation(),e.eventKeyIs(27)&&e.trigger("Rubric-close"))},OnlineTestGradeTestHeader:function(n){var t=e.get("gradebook"),i=n.caller();if(i&&t){i&&n.global("modelNid",i.global("modelNid")),n.global("nidpath",n.cnid());var o=e.links.pagenid();n.data=t[o].assessments[n.nid()],n.map()}},editAssessment:function(e){e.caller().newEvent("lightbox",{xds:e.get_arg("xds"),nid:e.cnid(),model:e.get_arg("model"),stopPropagation:!0})},print:function(e){setTimeout(function(){n.print()},1e3)}}});

/* resources: OnlineTestGradeBody */

"use strict";cf.resource("OnlineTestGradeBody",function(t,e,a,n){function r(t){return t%1?t.toFixed(2):t.toFixed(0)}return{init:function(e){e.get_val("submitted")?(e.inherit("OnlineTestCreate.init"),e.inherit("scroll")):e.exit(!0);var a=t.get("dataBookFeed");a&&a.clearUnread(e.get_val("student-nid"),e.nid("caller"))},maxHeight:function(t){return(t.get_target(".xds-bookGrades-types-rubricGrade",!0).length?t.get_target(".xds-bookGrades-types-rubricGrade",!0):t.caller().get_target("xds-cont").parent()).height()-t.target("*studentHeader").outerHeight()-t.caller().target("*graderhostheader").outerHeight()-30-(t.get_xdo("*result")&&t.get_xdo("*result").dom().outerHeight())},setScore:function(e){t.constant.OnlineTestQuestionTypes;var a=e.global("ScoreBook"),n=e.get_val("student-nid"),s=e.nid(),i=e.nid("caller"),o=e.state.get("col")||"0",d=e.get_val("qList"),l=0,g=0,c=e.val();a.setGrade(n,s,o,c);var u={};for(var p in d){var v=d[p].col||"0",m=a.normalizedCol(n,d[p].nid,v),x=parseFloat(a.getGrade(n,d[p].nid,v));!1!==m?(v==o&&(g+=x),l+=x):d[p].type!=t.constant.OnlineTestQuestionTypes.label()&&(u[v]=!0)}var f=t.get("OnlineTestTakeBody").numRemaining(e);l=r(l),g=r(g),a.saveGrade({col:o,anid:s,snid:n,value:c,xds:e.xds_this.xdsSetAnswer,aux:{unmarked:f,TestScore:l}}),e.get_xdo("*result")&&e.get_xdo("*result").map({TestScore:l}).update(),e.get_xdo("*question").update();var _=u[o]?"":g,b=e.caller().state.get("completedAttempts")||{},h=!0;if(b[n]&&b[n].length){var k=b[n][b[n].length-1].rid;e.get_setting("rid")&&k&&e.get_setting("rid")!=k&&(h=!1)}if(gradebook[t.gbl.nid]&&gradebook[t.gbl.nid].getGrade(n,i,o)!=_&&h){var G=bookGrades.current,y=bookGrades.current.global("matrix");y||(y=bookGrades.body.xdo.global("matrix")),bookGrades.current=y[i][o][n],bookGrades.events.setGrade(_),bookGrades.current=G}bookGrades.graderHost&&e.caller().trigger("oltpScoreSet",{grade:_&&l,rid:e.get_setting("rid")})},unlockGrade:function(e){if(e.get_val("type")==t.constant.OnlineTestQuestionTypes.paragraph())return!1;var a=e.get_val("student-nid"),r=e.nid(),s=e.global("ScoreBook"),i=s.getAttr(a,r,"l");e.on("click",function(){s.saveGrade({snid:a,anid:r,attr:"l",value:""===i||i===n?s.getGrade(a,r,e.state.get("col")||"0"):n,xds:e.xds_this.xdsSetAnswer}),""!==i&&i!==n&&e.get_xdo("*score").val(i).trigger("change"),e.get_xdo("*outof").update(),e.get_xdo("*score").focus(),e.get_xdo("*score").dom().select()}),e.inherit("fa.icon",{icon:i?"unlock":"lock"}),e.tooltip=e.arg(i?"tooltipUnlock":"tooltip")},studentAttemptsTaken:function(t){var e,a,r=t.caller().state.get("completedAttempts")||{},s=+t.get_val("student-nid");if(r[s]){e=r[s],a=1;var i=!0,o=!1,d=n;try{for(var l,g=e[Symbol.iterator]();!(i=(l=g.next()).done);i=!0){if(l.value.rid==t.rid())break;a++}}catch(t){o=!0,d=t}finally{try{i||null==g.return||g.return()}finally{if(o)throw d}}}else a="0";t.state.set("attempts",a),t.inherit("sys")},studentAttemptsTotal:function(t){var e=t.caller().state.get("studentAttempts")||{},a=+t.get_val("student-nid"),n=t.caller().state.get("totalAttempts"),r=e[a]?e[a]:n;+n!=+r&&t.state.set("attedited",!0),t.state.set("totalattempts",r),t.inherit("sys")},openAttemptsLB:function(e){var a=e.get_setting("classNid")||t.gbl.nid,n="".concat(a,"/").concat(e.nid("caller")),r=+e.get_val("student-nid"),s=e.state.get("name"),i=e.get_arg("xds")||"OnlineTestGradeEditAttempts";e.event("lightbox",{nid:n,xds:i,snid:r,sname:s,classNid:a})},initAttempts:function(t){var e=+t.get_setting("snid"),a=(t.state.get("studentattempts")||{})[e]||t.get_val("oltattempts");t.state.set("attempts",+a),t.inherit("f_section")},changeAttempts:function(t){var e=t.get_val("oltattempts");t.val()<e&&t.state.set("attempts",e)},timeRemaining:function(e){var a,n,r=e.val();a=Math.floor(r/3600),r%=3600,n=Math.floor(r/60),r%=60;var s=e.arg("tplbase");1==a?s+=e.arg("titleHour"):a&&(s+=e.arg("titleHours")),1==n?s+=e.arg("titleMinute"):n&&(s+=e.arg("titleMinutes")),1==r?s+=e.arg("titleSecond"):r&&(s+=e.arg("titleSeconds")),s!=e.arg("tplbase")?e.displayVal=t.tpl(s,{seconds:r,minutes:n,hours:a}):e.displayVal=""},saveAttempts:function(e){var a=e.get_setting("classNid")||t.gbl.nid,n=+e.get_setting("snid"),r=e.state.get("studentattempts")||{},s=e.state.get("attempts");r[n]=+s;var i={url:{nid:"".concat(a,"/").concat(e.nid()),rid:e.rid(),xds:"OnlineTestGradeEditAttempts"},xdo:e.get_xdo("*init"),data:{"init-studentattempts":JSON.stringify(r)},callback:function(t){e.caller().caller().newEvent("reload"),e.event("lightboxController.close")}};t.post(i)},scrollToUnmarked:function(t){var e=t.get_xdo("*questionSetup");e=e?e.find(".ungraded"):n;var a=t.find(".xds-scroll",!0).xdo.element,r=e.position().top+a.currentScrollTop();a.scrollTop(r)},loadSubmissions:function(t){var e=t.get_val("student-nid"),a=t.nid("caller");t.newEvent("loadxds",{xds:t.get_arg("xds")||"OnlineTestViewSubmissionsGradebook",preventDefault:1,snid:e,nid:a,target:"caller"})}}});

/* resources: OnlineTestTakeBody */

"use strict";cf.resource("OnlineTestTakeBody",function(e,t,a,r){var n;function s(e){return e===r?e:e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}var o={result:function(e){var t=o.numRemaining(e);0===t&&(t=r),e.map({unmarked:t})},numRemaining:function(e){var t=e.global("ScoreBook");if(t){var a=e.get_val("student-nid"),r=e.get_val("qList"),s=0;for(var o in r){if(r[o].type!=n.label())if(!1===t.normalizedCol(a,r[o].nid,r[o].col||"0")){var i=t.grades[a][r[o].nid].cols[r[o].col||"0"];if(i&&i<0)continue;s++}}return s}},timer:function(t){var a=parseInt(t.caller().get_val("duration"));if(a){if(t.get_val("submitted"))return-1===t.node.submitted&&t.addStyle("color","var(--ui-error-foreground-colour)"),void(t.displayVal=-1===t.node.submitted?t.arg("titleTimedOut"):t.arg("titleSubmitted"));t.state.data.TestStart||(t.state.data.TestStart=(new Date).getTime());var r=e.parseDate(t.get_val()).getTime(),n=e.parseDate(t.state.get("currentDate")).getTime(),s=function(){var e=(n+((new Date).getTime()-t.state.data.TestStart)-r)/1e3;return Math.round(a-e)};t.ready(function(e){!function t(){var a=s();if(a<300&&e.addStyle("color","var(--ui-error-standalone-colour)"),a<1){var r=o.inProgressAnswer;r&&r.val()&&e.global("TestBook").grades[r.get_val("student-nid")][r.nid()].cols[r.state.get("col")||"0"]!=r.val()&&o.setAnswer(o.inProgressAnswer)}if(s()<0)return e.node.submitted=-1,e.state.set("forcesubmit",!0),void e.get_xdo("*submit").trigger("click",{force:!0});e.state.set("timeRemaining",a);var n=Math.floor(a/3600)+"";a%=3600;var i=Math.floor(a/60)+"",l=a%60+"";1==n.length&&(n="0"+n),1==i.length&&(i="0"+i),1==l.length&&(l="0"+l),e.html(n+":"+i+":"+l),o.timerMark=setTimeout(t,1e3)}()})}else t.exit()},init:function(t){if(!t.get_val("submitted")||(!t.has_role("Teacher")&&t.global("OnlineTestSubmitted",1),t.global("readonlyForm",1),0!=t.get_val("published")||t.has_role("Teacher"))){t.get_setting("new")&&(t.set_setting("new",r),t.set_setting("url",r),t.set_setting("rid",t.get_val("student-rid"))),t.on("OnlineTestSubmitted","reload"),n=e.constant.OnlineTestQuestionTypes,t.state.set("studentView",1);var a=t.get_val("assessment");for(var s in a)t.data.assessment=a[s];a=t.data.assessment;var o=e.obj_to_arr(t.get_val("qList")),i=[],l=e.get("gradebook");o.map(function(t){var r={};r[t.col||"0"]=parseFloat(t.outof),i.push({nid:t.nid,scheme:a.scheme,summative:1,graded:1,columns:r,standards:t.standards,weighting:t.outof,nodetype:e.nt.Document(),nodesubtype:e.nt.Document.Assignment(!0)})});var d=l.gradebook,u=new d(t.nid(),{students:{student:t.get_val("student")},terms:e.clone(i)},{});u.randomQ=t.caller().get_val("randomQ"),u.randomA=t.caller().get_val("randomA");var c=e.clone(t.get_val("student"));c.grades=c.scores||{};var g=new d(t.nid(),{students:{student:c},terms:i},{});t.global("ScoreBook",g),t.global("TestBook",u),t.state.set("questions",o)}},studentOutOf:function(e){var t=e.global("ScoreBook").getGrade(e.get_val("student-nid"),e.nid(),e.state.get("col")||"0");t!==r&&(t+=""),e.map({score:t})},correctIndicator:function(e){e.inherit("OnlineTestCreate.correctIndicator")},setAnswer:function(t,a,s){var i,l=t.global("TestBook"),d=t.get_val("type");if(d==n.paragraph()||d==n.shortAnswer()||d==n.multipleChoice()||d==n.trueFalse()||d==n.likert()||d==n.numerical())i=t.val();else if(d==n.chooseAll()){var u=[];t.data.answer.map(function(e,t){e.answered&&u.push(e.index)}),i=u.join("-")}else if(d==n.dragdrop()){var c;c=s&&s.newOrder?s.newOrder:t.get_target("*answers").sortable("toArray");var g=[];c.map(function(t){var a=e.get_obj(t);g.push(a.state.get("guid"))}),i=g.join("-")}else if(d==n.match()){var v=t.data.answer,f=[],m=!0,p=!1,h=r;try{for(var _,b=v[Symbol.iterator]();!(m=(_=b.next()).done);m=!0){var w=_.value;f.push("".concat(w.guid,":").concat(w.answered||""))}}catch(e){p=!0,h=e}finally{try{m||null==b.return||b.return()}finally{if(p)throw h}}i=f.join("-")}else if(d==n.gapfill()){var y=t.data.answer,T=[],x=!0,k=!1,A=r;try{for(var S,O=y[Symbol.iterator]();!(x=(S=O.next()).done);x=!0){var B=S.value.answered||"";B=B.replaceAll("-","//~"),T.push(B)}}catch(e){k=!0,A=e}finally{try{x||null==O.return||O.return()}finally{if(k)throw A}}i=T.join("-")}o.saving=!0,o.inProgressAnswer=r,t._active_timeout&&(clearTimeout(t._active_timeout),t._active_timeout=r),t._deltas=r,l.saveGrade({col:t.state.get("col")||0,anid:t.nid(),snid:t.get_val("student-nid"),value:i,xds:t.xds_this.xdsSetAnswer,success:function(){delete o.saving}})},answers:function(e){var t=e.global("TestBook"),a=e.get_val("type"),o=t.getGrade(e.get_val("student-nid"),e.nid(),e.state.get("col")||"0");if(a==n.paragraph()||a==n.shortAnswer()||a==n.numerical())e.data=o;else if(a==n.multipleChoice()||a==n.trueFalse()||a==n.likert())o===r||isNaN(parseInt(o))||e.data.answer.map(function(e){e.index==o&&(e.answered=1)});else if(a==n.chooseAll()){if(o!==r)for(var i,l=(o=(o+"").split("-")).length;l--;)i=o[l],e.data.answer.map(function(e){e.index==i&&""!==i&&(e.answered=1)})}else if(a==n.match()){if(o!==r){var d={},u=e.data.answer,c=u.map(function(e){return e.guid}),g="($|(?=-(".concat(c.join("|"),")))");for(var v in o+="",u){var f=u[v],m=s(f.correct),p=new RegExp("(?!:)(".concat(m,")").concat(g),"g");o=o.replaceAll(p,f.guid),d[f.guid]=f}if(!e.global("readonlyForm")&&e.state.get("abank")){var h=!0,_=!1,b=r;try{for(var w,y=e.state.get("abank")[Symbol.iterator]();!(h=(w=y.next()).done);h=!0){var T=w.value;T=T.value;var x=new RegExp("(?!:)(".concat(s(T),")").concat(g),"g");T=T.replaceAll("-","//~"),o=o.replaceAll(x,T)}}catch(e){_=!0,b=e}finally{try{h||null==y.return||y.return()}finally{if(_)throw b}}}o=o.split("-");var k=!0,A=!1,S=r;try{for(var O,B=o[Symbol.iterator]();!(k=(O=B.next()).done);k=!0){var F=O.value,R=(F=F.replaceAll("//~","-")).split(":"),D=R[0],j=R.length>1?R[1]:"";d[D].answered=d[j]&&d[j].correct||j}}catch(e){A=!0,S=e}finally{try{k||null==B.return||B.return()}finally{if(A)throw S}}}}else if(a==n.dragdrop()){if(o){var C=e.data.answer,E={},P={},q=[];C.map(function(e,t){E[e.guid]=e}),o.split("-").map(function(e){q.push(E[e]),E[e].studentSorted=!0,P[e]=1}),C.map(function(e,t){P[e.guid]||q.push(e)}),e.data.answer=q}e.global("readonlyForm")||(e.arg("sortableRequiresWrite",!1),e.arg("sortableNoWrite",!0),e.arg("axis","y"),e.arg("containment","parent"),e.arg("tolerance","pointer"),e.arg("dropPlaceholder","xds-OnlineTestTakeBody-dragplaceholder"),e.on("xds-dragdrop-sortable-sortChanged onload",function(e,t,a){"onload"==e.e.type&&e.global("TestBook").getGrade(e.get_val("student-nid"),e.nid(),e.state.get("col")||0)||e.event("OnlineTestTakeBody.setAnswer")}),e.inherit("dragdrop.sortable"))}else if(a==n.gapfill()&&o!==r){var G=e.data.answer,I=e.state.get("abank")||[];o+="";var M=!0,N=!1,Q=r;try{for(var $,L=I[Symbol.iterator]();!(M=($=L.next()).done);M=!0){var V=$.value,W=V.value.replaceAll("-","//~");o=o.replaceAll(V.value,W)}}catch(e){N=!0,Q=e}finally{try{M||null==L.return||L.return()}finally{if(N)throw Q}}for(var z in o=o.split("-"))G[z].answered=o[z].replaceAll("//~","-")}e.inherit("OnlineTestCreate.answers")},setFocussedAnswer:function(e){if(o.inProgressAnswer=e,(2==e.state.get("type")||4==e.state.get("type"))&&e.e.originalEvent&&e.e.originalEvent.data){var t=e._active_timeout,a=e._deltas||0;clearTimeout(t),a>500?(e.newEvent("OnlineTestTakeBody.setAnswer"),a=-1):a>64&&(t=setTimeout(function(){e.newEvent("OnlineTestTakeBody.setAnswer"),e._deltas=0},3e3)),e._active_timeout=t,e._deltas=a+1}},submit:function(a){clearTimeout(o.timerMark);var n,s=a.global("TestBook"),i=a.get_val("student-nid"),l=!1;for(var d in s.assessments){for(var u in s.assessments[d].columns)if((n=s.getGrade(i,d,u||"0"))===r||""===n){l=!0,d;break}if(l)break}var c=a.get_arg("xds"),g=0;function v(){a.hide(),g++,o.saving&&g<50?setTimeout(v,100):e.post({url:{nid:a.cnid(),xds:c,arid:a.get_val("student-rid")},data:{forceSubmit:a.state.get("forcesubmit"),timeRemaining:a.state.get("timeRemaining"),FailThreshold:e.user.FailThreshold},success:function(){a.node.submitted||(a.node.submitted=!0),a.get_xdo("*timer")&&a.get_xdo("*timer").update(),a.caller().get_xdo("*info").show(),a.caller().get_xdo("*testHeader").state.set("testInProgress",!1),a.state.get("published")||a.state.get("forcesubmit")?(t.scroll(0,0),a.caller().get_xdo("*info").state.set("forcesubmit",a.state.get("forcesubmit")),a.caller().get_xdo("*info").state.set("showSubmittedText",!0),a.trigger("OnlineTestSubmitted")):a.trigger("OnlineTestSubmitted")},errorDialog:!0})}if(l&&!a.get_arg("force")){e.validate(a.get_xdo("*body"));var f=a.get_xdo("*body").find(".xds-validate-msg-error");f&&f.xdo&&f.xdo.get_xdo("*title").event("scrollTo"),e.confirm({message:e.lang("You have unanswered questions. Are you sure you want to hand in your test?"),confirm:v,cancel:function(){a.get_xdo("*timer").update()},cancelButton:e.lang("Resume taking test"),continueButton:e.lang("Submit unfinished test")})}else v()}};return o});
});
