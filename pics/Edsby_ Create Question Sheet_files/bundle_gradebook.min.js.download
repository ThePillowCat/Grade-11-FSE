/**
 * Version: baf4caef7b0dd7471dd76c3dc5db25e58fe75145ce31e12f9f3da02c27b2a1fb
 * Bundle: gradebook
 **/

cf.resources.confirm('bundle_gradebook', function() {

/* modules: gradebook */

"use strict";function _objectSpread(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{},r=Object.keys(s);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(s).filter(function(e){return Object.getOwnPropertyDescriptor(s,e).enumerable}))),r.forEach(function(t){_defineProperty(e,t,s[t])})}return e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}cf.module("gradebook",function(e,t,s,r){var i,n=["gs_standards","gs_standards_glo","gs_standards_strand"],a={gs_standards_glo:2,gs_standards_strand:1},o={1:1,2:2,2.1:2.1,3:3,4:4,5:5,6:6,mean:1,mode:2,latest:3,highest:4,count:5,median:6,Mean:1,Mode:2,Latest:3,Highest:4,summaryMode:2.1,Count:5,Median:6},l=["overall","Overall","any","Any"],u=(_defineProperty(i={1:1,2:2,3:5,4:6,5:7,6:8,7:3,12:4},"1",1),_defineProperty(i,"2",2),_defineProperty(i,"3",5),_defineProperty(i,"4",6),_defineProperty(i,"5",7),_defineProperty(i,"6",8),_defineProperty(i,"7",3),_defineProperty(i,"12",4),{schemes:function(t){e.user.grading||(e.user.grading={});var s,i,n,a,o,l,u=e.clone(e.user.grading),c=function(e,t){for(var s in u){var r=u[s];if(r.name==t){for(var i=["title","disabled","mapping","formativeOnly","nototal","noconfig"],n=0;n<i.length;n++){var a=i[n];r[a]&&(e[a]=r[a])}return e}}return e};if(this.mappingSchemes={},t)for(M in t=t.fields)if(this.gradeSchemes[M]=s={},"rubric"===(M=t[M]).id&&(M.fields={mapping:!1}),e.is_obj(M)&&M.fields){if(M.fields.cols&&(s.weightingOnly=M.fields.cols.weightingOnly),s.disabled=M.disabled,s.mapping=M.fields.mapping.value||M.fields.mapping.fields||"points",b=s.cols=!!M.fields.cols&&M.fields.cols.fields,"object"===_typeof(s.mapping)){s.omap=M.fields.mapping._children;var d={};for(var h in s.mapping)s.mapping.hasOwnProperty(h)&&(s.mapping[h]["data-value"]!==r?(d[(s.mapping[h]["data-value"]+"").toUpperCase()]=s.mapping[h],s.mapping[h].id=s.mapping[h]["data-value"]):d[h]=s.mapping[h]);s.mapping=d}if(e.is_obj(b)){for(var g,m={},p=Object.keys(b);i=p.pop();)(g=b[i]).id=g.name,m[g.name]=g;for(s.cols=b=m,n=[],a=(l=M.fields.cols._children).length,o=0;o<a;o++)n.push(l[o]);for(i in s.order=n,b)this.gradeSchemeTitles[i]=b[i].title}s.group=M.group,s.title=M._title,s.noweighting=M.noweighting,s.nototal=M.nototal,s.formativeOnly=M.formativeOnly,s=c(s,M.name)}if(e.user.mapping&&e.user.gradeMapping){var f=e.clone(e.user.gradeMapping);for(var v in f){var y=f[v];this.mappingSchemes[y.name]=y}}if(this.strands){var b=[],S=this.strands;if(!e.is_arr(S))try{S=JSON.parse(S)}catch(e){S=!1}if(S&&S.length){var k=this.gradeSchemes.gs_strands,A={cols:this.convertStrandsToCols(S),id:"gs_strands",name:"gs_strands",mapping:"points",title:k?k.title:e.lang("Strands")};for(var w in A=c(A,A.name),u.gs_strands=A,this.stranded=!0,this.strandKey={},S)this.strandKey[S[w].key]=S[w].name}}try{if(this.glo){var _=this.glo;if(_&&_.length)for(var N in this.gloed=!0,this.gloKey={},_)this.gloKey[_[N].key]=_[N];var C={cols:this.convertGLOsToCols(_),id:"gs_standards_glo",name:"gs_standards_glo",mapping:"points",title:e.lang("GLO")};C=c(C,C.name),u.gs_standards_glo=C}}catch(e){this.gloKey={}}for(var P in u){var M=u[P];this.addScheme(M,!1)}this.normalizeSchemes(),this.gradeSchemes.gs_outof||this.addScheme({name:"gs_outof",mapping:"points",cols:[{name:"0"}]})},student:function(e){if(!this.students[e.nid]){if(this.students[e.nid]=e,e){var t=parseFloat(e.average);isNaN(t)||(e.average=t/100)}e.normalized={},e.ia_normalized={},e.reporting={},e.units={},"string"==typeof e.grades&&(e.grades={}),e.grades||(e.grades={}),e.nEvidence=this.Evidence&&this.Evidence[e.nid]?this.Evidence[e.nid].length:0,this.grades[e.nid]=e.grades}},students:function(e){for(var t in e)t=e[t],u.student.call(this,t)},reporting:function(t){var s,r,i,n,a,o={},l=(e.nt&&e.nt.Document,new Date);for(r in t)if(24==(s=t[r]).nodesubtype){if(s.noavg||o[s.nid])continue;s.termName=s.name,o[s.nid]=s,s.assessments=[],s.amap={},s.start=e.parseDate(s.rpstart),s.end=new Date(e.parseDate(s.rpend).getTime()+864e5),s.amap={},s.start<=l&&s.end>l?(s.active=!0,(!i||s.start>i.start)&&(i=s)):s.start>=l?(!n||s.start<n.start)&&(n=s):s.start<=l&&(!a||s.start>a.start)&&(a=s)}this.previousReportingPeriod=a,(i=i||a||n)&&(this.currentReportingPeriod=i,i.current=!0),this.reporting=o},terms:function(t){var s,r,i={};e.nt&&e.nt.Document;for(r in t)6==(s=t[r]).nodesubtype&&(s.termName=s.name,i[s.nid]=s,s.assessments=[],s.units=[]);this.terms=i},units:function(t){var s,r,i={},n=[];e.nt&&e.nt.Document;for(r in t)4==(s=t[r]).nodesubtype&&(s.unitName=s.name,n.push(s),i[s.nid]=s,s.assessments=[],s.amap={},this.terms[s.thread]&&this.terms[s.thread].units.push(s),s.sdate&&(s.minDate=s.sdate,s.undated=2));this.unitList=n,this.units=i},sortUnits:function(){for(var t,s,i=this.assessmentList,n=this.unitList,a=i.length,o=this.units;a--;)(s=o[(t=i[a]).thread])&&(s.minDate||(s.undated=1),t.date&&(!s.minDate||t.date<s.minDate)&&(s.minDate=t.date,s.undated=2));for(a=n.length;a--;)n[a].minDate===r&&(n[a].undated=1);e.sort&&(n=e.sort({sortType:"int,date,int",sortBy:"undated,minDate,nid",sortDirection:"forward,forward,forward"},n)),a=n.length;for(var l=0;l<a;l++)n[l]._index=l,n[l].unitNumber=l+1,n[l]._number=l%6,n[l].unitName=this.unitName(n[l])},assessments:function(t){var s,i,a,o,l,u={},c=this.units,d=this.terms,h=this.reporting,g=e.nt&&e.nt.Document,m=0,p=0;for(i in t){if(0,(s=t[i]).nodesubtype==g.Discussion(!0)&&(s.isDiscussion=!0,s.nodesubtype=g.Assignment(!0)),s.nodesubtype==g.IndividualAssessment(!0)){s.nodesubtype=g.Assignment(!0),s.individualAssessment=!0;var f=(s.students||"").split(",");s.studentAssigned={};var v=!0,y=!1,b=r;try{for(var S,k=f[Symbol.iterator]();!(v=(S=k.next()).done);v=!0){var A=S.value;s.studentAssigned[+A]=!0}}catch(e){y=!0,b=e}finally{try{v||null==k.return||k.return()}finally{if(y)throw b}}}if(3==s.nodesubtype){s.averageType=s.summative===r?1:s.summative,s.summative===r?s.summative=1:3==s.summative&&(s.summative=0),s.assessmentName=s.name,s.unitName=this.unitName(s.thread),s.display=s.name,s.value=s.nid,u[s.nid]=s,s.standards?s.standards=(s.standards+"").split(","):s.standards=[],c[s.thread]&&(c[s.thread]&&(c[s.thread].assessments.push(s),c[s.thread].amap[s.nid]=1),d[c[s.thread].thread]&&d[c[s.thread].thread].assessments.push(s)),this.assessmentList.push(s),s.numCols=0,"rubric"===s.scheme&&(s.rubric=!0,s.scheme=s.rubricScheme,s.readonly=!0);var w=(a=this.gradeSchemes[s.scheme])&&a.group;if(!s.strands||"gs_strands"!==w||a&&a.order&&a.order.length?n.includes(w)&&(s.standards&&s.standards.length?(this.registerFakeScheme({standards:s.standards.join(","),nid:s.nid,scheme:s.scheme,cols:s.weighting}),s.scheme=s.nid):s.scheme="gs_none"):(this.registerFakeScheme({strands:s.strands,nid:s.nid,scheme:s.scheme,cols:s.weighting}),s.scheme=s.nid),2==s.esubmit&&(s.readonly=!0),s.scheme!==r||(s.scheme=this.noneScheme),s.adate=s.date,s.compDate=e.parseDate(s.date),s.compDate<=new Date&&(s._completed=!0),s.reporting=[],s.rmap={},!e.is_obj(s.columns))try{s.columns=!!s.columns&&JSON.parse(s.columns)}catch(e){s.columns=!1}if(s.columns||s.weighting||0==s.summative||(s.scheme="gs_none"),!(a=s.gs=this.gradeSchemes[s.scheme])){this.addWarning(s,"schemes"),this.assessmentList.pop(),delete u[s.nid];continue}a&&a.formativeOnly&&(s.summative=0);var _=function(){var e=s.columns;for(o in s.columns={},a.cols){var t=a.cols[o];t.mapping&&"points"===t.mapping||!t.mapping&&"points"===a.mapping?s.columns[o]=e[o]:s.columns[o]=1}};if(!a||!a.customMapping&&(!e.is_obj(a.mapping)&&"percent"!==a.mapping||s.columns&&Object.keys(s.columns).length)||_(),a&&!a.cols&&(a.cols={0:{}}),"points"!==a.mapping&&"percent"!==a.mapping&&!e.is_obj(a.mapping)){this.addWarning(s,"mapping"),this.assessmentList.pop(),delete u[s.nid];continue}a&&a.cols&&(e.is_obj(a.mapping)||"percent"===a.mapping)&&_(),this.colWeights(s);var N=!1;if(a&&(e.is_obj(a.mapping)||"percent"===a.mapping)&&a.cols&&a.cols[0]===r)for(o in a.cols)0==s.summative?(s.weighting||(N=!0,s.weighting=0),N&&s.weighting++,s.colweights[o]=s.columns[o]=s.colweights[o]||1):s.colweights[o]||(s.columns[o]=0);if(m+=s.weighting,p+=1,s.columns&&a){var C={};for(o in s.columns)1!==C[o]&&(C[o]=1,a.cols[o]?0!=s.columns[o]&&null!==s.columns[o]&&s.numCols++:delete s.columns[o])}for(l in 0===s.numCols&&(s.scheme="gs_none"),s.type!==r&&e.lookup&&!e.lookup("assessmentTypes",s.type).str()&&e.constant("assessmentTypes",s.type,s.type),h)l=h[l],(s.date&&s.compDate>=l.start&&s.compDate<l.end||s.rperiod&&-1!==$.inArray(l.nid,s.rperiod))&&(s.xrperiod&&-1===$.inArray(l.nid,s.xrperiod)||!s.xrperiod)&&(l.amap[s.nid]=!0,l.assessments.push(s),s.reporting.push(l),s.rmap[l.nid]=!0);if("string"==typeof s.overdue){s.overdue=s.overdue.split(",");for(var P=s.overdue,M=P.length;M--;){var z=this.students[P[M]];z&&(z.grades[s.nid]&&z.grades[s.nid].r!==r||s.individualAssessment&&!s.studentAssigned[z.nid]||(z.grades[s.nid]||(z.grades[s.nid]={}),z.grades[s.nid].calendarOverdue=!0,z.grades[s.nid].r=2))}}}}this.busted||(this.averageWeighting=p>0?m/p:1,this.assessments=u)}}),c=function(t,s,i,n){if(e.extend(this,{gradeSchemes:{},students:{},grades:{},terms:{},units:{},assessments:{},assessmentList:[],preDefinedSelectors:{},customSelectors:{},selectors:{},buckets:{},bucketed:{},outOfSync:{},selectorLen:0}),t===r&&s===r&&i===r&&n===r)return this;this.nid=t,s.nodesubtype==e.nt.Container.Course(!0)?(this.AverageType=1,this.isCourseModel=!0):this.AverageType=e.user&&e.user.AverageType,i||(i=s.slices[0].xds,s=s.slices[0].data),n!==r&&!0!==n||e.cook(i,s),i.fields||(i.fields={}),this.CourseID=s.CourseID,this.GBNoAverages=1==s.GBAverages,this.GBMapScheme="0"!==s.GBMapScheme?s.GBMapScheme:r,this.strands=s.strands,this.glo=s.glo,this.RestrictSchemes=s.RestrictSchemes||!1,this.setupSummaryCols(s.SummaryCols),this.setupEvidence(s.evidence),u.schemes.call(this,i.fields.gradeschemes),u.students.call(this,s.students),u.reporting.call(this,s.terms),this.processBuckets(s),u.terms.call(this,s.terms),u.units.call(this,s.terms),u.assessments.call(this,s.terms),u.sortUnits.call(this),this.selectors=this.handlePreDefinedSelectors(i.fields.preDefinedBuckets),this.calculateWeightings(),this.buckets[this.nid]=this.processDefaults(s.buckets,s.custom);var a,o=this.reporting;for(var l in o)a=2==this.AverageType&&o[l].bucketsRaw||s.buckets,this.buckets[l]=o[l].buckets=this.processDefaults(a);this.bucketed=this.bucketAll(),this.normalizeAll(),s.nodesubtype!=e.nt.Container.Course(!0)&&this.buildStandardsTree(this,s),this.calculatePercentages(this.bucketed[this.currentReportingPeriod&&this.currentReportingPeriod.nid||this.nid],this.buckets[this.currentReportingPeriod&&this.currentReportingPeriod.nid||this.nid]),this.activeNid=d.activeNid,this.setActiveAssessments(),this.annotations={},this.annotationsFMap={},this.initialized=!0};c.prototype={noneScheme:"gs_none",register:u,FailThreshold:(e.user&&e.user.FailThreshold)/100,SigFigs:1,valid:{upper:120,lower:0},percentages:{},gradeSchemeTitles:{0:e.lang("Uncategorized")},setupSummaryCols:function(t){if(this.SummaryCols=t,this.SummaryCols)for(var s=0;s<this.SummaryCols.length;s++)e.is_str(this.SummaryCols[s].type)&&"4_"===this.SummaryCols[s].type.substr(0,2)?(this.SummaryCols[s].subCol=this.SummaryCols[s].type.substr(2),this.SummaryCols[s].type=4):e.is_str(this.SummaryCols[s].type)&&"glo_"===this.SummaryCols[s].type.substr(0,4)?(this.SummaryCols[s].subCol=this.SummaryCols[s].type.substr(4),this.SummaryCols[s].type=4):e.is_str(this.SummaryCols[s].type)&&"vglo_"===this.SummaryCols[s].type.substr(0,5)&&(this.SummaryCols[s].subCol=this.SummaryCols[s].type.substr(5),this.SummaryCols[s].type=5);else this.SummaryCols=[{type:1,summary:1}]},setupEvidence:function(e){if(this.syntheticAssessments={},this.Evidence={},this.evidenceData={},e)for(var t in e){var s=e[t].snids.split(",");for(var r in s){var i=s[r].trim();this.Evidence[i]?this.Evidence[i].push(e[t].nid):this.Evidence[i]=[e[t].nid]}this.evidenceData[e[t].nid]=e[t]}},getStandardsStrandLevel:function(e){try{return(e=e.split(":"))[1].split(".").length}catch(e){return!1}},convertStandardToStrand:function(e){var t=arguments.length>1&&arguments[1]!==r&&arguments[1];try{var s=e,i=(e=s.split(":"))[1].split(".");return"number"==typeof t&&i.length>t&&(e[1]=i.splice(0,t).join("."),s=e.join(":")),[s,e]}catch(e){return!1}},convertStandardsToStrands:function(e){for(var t,s=arguments.length>1&&arguments[1]!==r&&arguments[1],i=e.split(","),n=[],a={},o=0;o<i.length;o++){var l=this.convertStandardToStrand(i[o],s);!1!==l&&(t=l[1],l=l[0],t=t[0]===this.CourseID?t.pop():l,a[l]||(n.push({name:t,key:l}),a[l]=!0))}return n},convertStrandsToCols:function(e){for(var t=[],s=e.length,r=0;r<s;r++)t.push({title:e[r].name,shortName:e[r].key,name:e[r].key,id:e[r].key});return t},convertGLOsToCols:function(e){return e.map(function(e){return{title:e.display,shortName:e.name,name:e.key,id:e.key}})},registerFakeScheme:function(t){try{var s=this,r=s.gradeSchemes[t.scheme||"gs_outof"],i=e.clone(r);i.name=t.nid+"",i.disabled=!0,i.cols=[];var o=t.cols;if(n.includes(i.group)){if(!t.standards)return void e.dialog(e.lang("No standards were found for this assessment."));t.strands=s.convertStandardsToStrands(t.standards,a[i.group]||!1),1===t.strands.length&&(i.title=t.strands[0].name),"gs_standards_glo"==i.group&&s.glo&&s.gloKey&&(t.strands=t.strands.map(function(e){return s.gloKey[e.key]&&(e.name=s.gloKey[e.key].name),e}))}if(n.concat(["gs_strands"]).includes(i.group)){var l=t.strands;if(!l)return void e.dialog(e.lang("No strands were found for this Stranded Rubric."));for(var u=[],c=0;c<l.length;c++)(n.includes(i.group)||o[l[c].key])&&u.push(l[c]);i.cols=s.convertStrandsToCols(u)}else r.order.map(function(t){o[t.id]&&i.cols.push(e.clone(t))});i.origScheme=t.scheme,s.addScheme(i)}catch(e){return!1}},getRealScheme:function(e){if(e.origScheme&&this.gradeSchemes[e.origScheme])return this.gradeSchemes[e.origScheme];if(e.nid!==r&&!isNaN(e.name))for(var t in this.gradeSchemes){var s=this.gradeSchemes[t];if((isNaN(t)||!s.disabled)&&e.nid==s.nid)return s}return e},addScheme:function(t){var s=!(arguments.length>1&&arguments[1]!==r)||arguments[1];if("points"!==t.mapping&&"percent"!==t.mapping&&this.mappingSchemes[t.mapping]&&(t.omap=this.mappingSchemes[t.mapping].omap,t.mapping=this.mappingSchemes[t.mapping].mapping),t.cols)if(e.is_arr(t.cols))t.order=t.cols;else try{t.order=JSON.parse(t.cols)}catch(e){return}if(t.order&&t.order.length){t.order.length;t.cols={};var i=!0,a=!1,o=r;try{for(var l,u=t.order[Symbol.iterator]();!(i=(l=u.next()).done);i=!0){var c=l.value;c.id=c.name,c.shortName||(c.shortName=c.name),t.cols[c.id]=c,c.mapping&&(t.customMapping=!0)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}}else delete t.order;n.includes(t.name)&&(t.group=t.name),this.gradeSchemes[t.name]=t,s&&this.normalizeSchemes()},normalizeSchemes:function(){for(var e in this.gradeSchemes){var t=this.gradeSchemes[e];if(this.stranded||"gs_strands"!==t.group||(this.gradeSchemes[e].disabled=!0),t.group&&!t.order){var s=this.gradeSchemes[t.group];s&&(t.cols=s.cols,t.order=s.order)}}},symbolicMap:function(t,s,i){var n,a=t,o=(a=e.is_obj(a)?a:this.gradeSchemes[a])&&a.mapping;if(o||(a=this.mappingSchemes[t])&&(o=a.mapping),isNaN(s)||!1===s||null===s){for(var l in o){var u=o[l];if(null===u.percentage&&null===u.max&&null===u.min&&""===u.fail)return u.color&&i?{grade:l,color:u.color}:l}return"-"}for(var c in s=parseFloat(s).toFixed(2),o)if(s>=(n=o[c]).min&&(n.max===r||s<n.max))return n.color&&i?{grade:c,color:n.color}:c;return s},calculateStudentWeighting:function(e,t){t=t||(this.currentReportingPeriod&&2===this.AverageType?this.currentReportingPeriod.nid:this.nid);var s=this.bucketed[t||this.nid],r=this.buckets[t||this.nid],i=this.students[e],n=i.normalized,a=i.grades,o={};for(var l in s)if(l>=-1){var u=s[l]&&s[l].length;for(o[l]=[];u--;){n[(d=s[l][u]).nid]&&!1!==n[d.nid].average&&a[d.nid]&&!a[d.nid].d&&o[l].push({summative:d.summative,columns:d.columns,colweights:d.colweights,points:d.points,numCols:d.numCols,weighting:d.weighting,nid:d.nid,unitBucket:r[l].unitBucket,thread:d.thread})}}this.calculatePercentages(o,r);var c={};for(var l in o)if(l>=-1)for(u=o[l]&&o[l].length;u--;){var d;c[(d=o[l][u]).nid]=d}return c},setActiveAssessments:function(e){if(2!==this.AverageType)return this.activeAssessmentList=this.assessmentList,void(this.activeAssessments=this.assessments);e!==r&&(this.activeNid=e),this.activeAssessmentList=this.activeNid&&this.reporting[this.activeNid]?this.reporting[this.activeNid].assessments:this.assessmentList;for(var t=this.activeAssessmentList.length,s={};t--;)s[this.activeAssessmentList[t].nid]=this.activeAssessmentList[t];this.activeAssessments=s},calculateWeightings:function(){var e,t=this.assessments,s=0;for(var r in t)"1"==(r=t[r]).summative&&r.weighting&&(s+=e=parseFloat(r.weighting));for(r in t)"1"==(r=t[r]).summative&&r.weighting?(e=parseFloat(r.weighting),r.calculatedWeighting=e/s):r.calculatedWeighting=0},processPercent:function(e,t){var s=t&&"2"==t.summative,r=this.normalizePercent(e);return(isNaN(r)||0===r)&&(r="-")||(r+="%"),s&&(r="-"===r?"(-)":"(+"+r+")"),r},calculatePercentages:function(t,s){var i,n,a,o,l,u=!1;for(var c in s.totalBucketPoints=0,s[-1]={points:0},s)if(e.is_obj(s[c])){if(s[c].points=parseFloat(s[c].points)||0,u=!1,"-1"!==c){for(i=s[c].selectors.length,n=0;n<i;){if(o=s[c].selectors[n],(a=this.selectors[o])&&a.fields)for(l in u=!0,h=s[c].subBuckets||(s[c].subBuckets={}),a.fields)h[l]||(h[l]={}),h[l].points=parseFloat(h[l].points)||0,h[l].title=a.fields[l].title,h[l].id=a.fields[l].id,h[l].assessmentPoints=0,h[l].numa=0,s.totalBucketPoints+=h[l].points;n++}u||(s.totalBucketPoints+=s[c].points)}if((p=t[c])&&p.length)for(m=p.length,s[c].assessmentPoints=0,n=0;n<m;){if(p[n].percent=0,p[n].percentActual=0,p[n].points=parseFloat(p[n].weighting)||0,u){if(p[n].subBuckets=[],s[c].unitBucket){for(l in s[c].subBuckets)if(s[c].subBuckets[l].id==p[n].thread&&"1"==p[n].summative){s[c].subBuckets[l].numa++,s[c].subBuckets[l].assessmentPoints+=p[n].points;break}}else for(l in p[n].columns)if(p[n].columns[l]=parseFloat(p[n].columns[l])||0,s[c].subBuckets[l]&&p[n].columns[l]>0&&p[n].colweights&&p[n].colweights[l]>0&&"1"==p[n].summative)s[c].subBuckets[l].numa++,s[c].subBuckets[l].assessmentPoints+=p[n].colweights[l];else if(this.codeStrandsMap&&l in this.codeStrandsMap){var d=this.codeStrandsMap[l];s[c].subBuckets[d]&&p[n].columns[l]>0&&p[n].colweights&&p[n].colweights[l]>0&&"1"==p[n].summative&&(s[c].subBuckets[d].numa++,s[c].subBuckets[d].assessmentPoints+=p[n].colweights[l])}}else delete p[n].subBuckets,p[n].points&&"1"==p[n].summative&&(s[c].assessmentPoints+=p[n].points);n++}}s[-1].points=100-s.totalBucketPoints,s[-1].points<0&&(s[-1].points=0),s.totalBucketPoints=s[-1].points+s.totalBucketPoints;var h,g,m,p,f,v=this.percentages;for(c in s)if(e.is_obj(s[c]))if(m=(p=t[c]).length,s[c].subBuckets)for(h=s[c].subBuckets;m--;){f=p[m];var y=!1;for(l in h){if(h[l].percent=h[l].points/s.totalBucketPoints,y=!1,s[c].unitBucket&&h[l].id==f.thread){y=!0;var b=0===h[l].assessmentPoints?0:f.weighting/h[l].assessmentPoints*h[l].percent;if(g={subBucket:"0",points:f.points,name:h[l].title,percentActual:b},f.numCols>1)for(var S in f.subBuckets=[],f.percentActual=0,f.colweights){var k={subBucket:S,points:f.colweights[S],name:e.search&&e.search("gradeSchemes-"+f.scheme+"-cols-"+S+"-title",this),percentActual:0===h[l].assessmentPoints?0:(f.colweights&&f.colweights[S])/h[l].assessmentPoints*h[l].percent};k.percent=this.processPercent(k.percentActual,f),v[f.nid+"-"+S]=k.percent,f.subBuckets.push(k)}else delete f.subBuckets}else if(f.columns[l]>0&&!s[c].unitBucket||this.strandsCodeMap&&l in this.strandsCodeMap&&f.columns[this.strandsCodeMap[l]]>0){y=!0;var A=void 0,w=void 0;if(this.strandsCodeMap&&l in this.strandsCodeMap&&f.columns[this.strandsCodeMap[l]]>0&&f.colweights&&!f.colweights[l]){var _=this.strandsCodeMap[l];A=f.colweights&&f.colweights[_],w=0===h[l].assessmentPoints?0:(f.colweights&&f.colweights[_])/h[l].assessmentPoints*h[l].percent}else A=f.colweights&&f.colweights[l],w=0===h[l].assessmentPoints?0:(f.colweights&&f.colweights[l])/h[l].assessmentPoints*h[l].percent;g={subBucket:l,points:A,name:h[l].title,percentActual:w},f.subBuckets&&f.subBuckets.push(g)}y&&(f.percentActual+=g.percentActual,v[f.nid+"-"+l]=g.percent=this.processPercent(g.percentActual,f))}v[f.nid]=f.percent=this.processPercent(f.percentActual,f)}else for(s[c].percent=s[c].points/s.totalBucketPoints;m--;){if((f=p[m]).percentActual=0===s[c].assessmentPoints?0:f.points/s[c].assessmentPoints*s[c].percent,f.colweights&&f.colweights[0]===r)for(l in f.subBuckets=[],f.percentActual=0,f.colweights)g={subBucket:l,points:f.colweights[l],name:e.search&&e.search("gradeSchemes-"+f.scheme+"-cols-"+l+"-title",this),percentActual:0===s[c].assessmentPoints?0:f.colweights[l]/s[c].assessmentPoints*s[c].percent},f.subBuckets.push(g),f.percentActual+=g.percentActual,v[f.nid+"-"+l]=g.percent=this.processPercent(g.percentActual,f);v[f.nid]=f.percent=this.processPercent(f.percentActual,f)}},findNonWeightedAssessments:function(){this.currentReportingPeriod;var e,t=this.assessments,s=[];for(e in t)e=t[e],this.impactsAverage(e)&&0===e.percentActual&&s.push(e);return s},impactsAverage:function(e){var t=this.currentReportingPeriod;if(t&&2===this.AverageType){var s=t.amap;if(!s||!s[e.nid])return!1}return"0"!=e.summative&&e.scheme!==this.noneScheme},processBuckets:function(e){var t=e.buckets;try{t=JSON.parse(t)}catch(e){t={}}if(t[this.nid])for(var s in t)s==this.nid?e.buckets=JSON.stringify(t[s]):this.reporting&&this.reporting[s]&&(this.reporting[s].bucketsRaw=JSON.stringify(t[s]))},processDefaults:function(t,s,i){var n,a,o,l,u=this;try{for(a in(n=JSON.parse(t)).bucketLen=0,n)(a=parseInt(a))>=n.bucketLen&&(n.bucketLen=++a)}catch(e){n={"-1":{points:100},bucketLen:0}}try{for(a in u.customSelectors=JSON.parse(s),u.customSelectors)u.selectors[a]=u.customSelectors[a],a>=u.selectorLen&&(u.selectorLen=a)}catch(e){u.customSelectors={},u.selectorLen=0}for(a in n){if((o=n[a].selectors&&n[a].selectors.length||0)&&-5==n[a].selectors[0]&&(n[a].unitBucket=!0),e.is_obj(n[a])&&n[a].subBuckets){var c=r;if(n[a].selectors.map(function(e){var t=u.selectors[e];t?t.fields||(c=!1):(u.addWarning(e,"buckets"),c=!1)}),c===r)for(var d in n[a].subBuckets)if(d&&n[a].subBuckets[d]){c=!0;break}if(c||delete n[a].subBuckets,n[a].unitBucket&&n[a].subBuckets){var h=new Set;for(var g in n[a].subBuckets){var m=n[a].subBuckets[g];m&&m.id&&(h.has(m.id)?delete n[a].subBuckets[g]:h.add(m.id))}}}for(;o--;)l=n[a].selectors[o],u.selectors[l]||(u.selectors[l]={title:l,value:l})}return n},populateStrandSelector:function(t,s){if(s&&s.length){for(var r=0;r<s.length;r++)t.fields&&e.is_arr(t.fields)||(t.fields=[]),t.fields.push({id:s[r].key,title:s[r].name});return t}return!1},populateGLOSelector:function(e,t){if(t&&t.length){for(var s=0;s<t.length;s++)e.fields||(e.fields=[]),e.fields.push({id:t[s].key,title:"".concat(t[s].name," ").concat(t[s].display),value:t[s].name});return e}return!1},handlePreDefinedSelectors:function(t){var s=this;t||(t={});var i=t.fields,n={},a=s.strands,o=(a&&a.length,s.glo),l={},u=100,c=function(t){if("strands"===t||"outcomestrands"==t){if(!(t=s.populateStrandSelector(i[t],a)))return d=t,"continue";e.cook(t)}else if("units"===t)(t=i[t]).fields||(t.fields=[]),s.unitList.map(function(e){t.fields.push({id:e.nid,title:e.name})});else if("glo"===t){if(!(t=s.populateGLOSelector(i[t],o)))return d=t,"continue";e.cook(t)}else t=i[t];t.scheme&&(l[t.scheme]=!0),n[t["data-value"]]=t,d=t};for(var d in i)c(d);for(var h in this.gradeSchemes){var g,m=this.gradeSchemes[h],p=void 0,f=[];if(!(h in l)&&isNaN(h)&&"gs_none"!==h){if("gs_strands"==m.group){if(!(f=s.populateStrandSelector({},a)))continue;f=f.fields}else if("gs_glo"==m.group){if(!(f=s.populateStrandSelector({},o)))continue;f=f.fields}else{var v=e.obj_to_arr(m.cols),y=!0,b=!1,S=r;try{for(var k,A=v[Symbol.iterator]();!(y=(k=A.next()).done);y=!0){var w=k.value,_=1==v.length?m.title:w.title;f.push({id:w.id,title:_})}}catch(e){b=!0,S=e}finally{try{y||null==A.return||A.return()}finally{if(b)throw S}}}h?p=h:(p=u,u+=1),g={id:h,type:"sys",title:m.title,"data-value":p,css:" ",scheme:h,fields:f},e.cook(g),n[p]=g}}var N,C=s.assessments;for(var P in C)(N=C[P].type)===r||n[N]||"19"==N||(n[N]={"data-value":N,title:N,assessmentType:N});return n},bucketTitle:function(t){if(!t)return e.lang("Everything Else");for(var s=[],r=t.length;r--;){var i=e.lookup("assessmentTypes",t[r]).str();i||(i=this.selectors[t[r]].title),s.push(i)}return s.join(", ")},bucketAll:function(){var e=this.reporting,t={};for(var s in e)t[(s=e[s]).nid]=this.bucket(s.assessments,s.buckets);return t[this.nid]=this.bucket(this.assessmentList,this.buckets[this.nid]),t},bucket:function(t,s){var i,n,a,o,l,u,c,d,h,g={"-1":[],"-2":[]};for(var m in s)if(e.is_obj(s[m])){if("-1"!==m)for(var p=s[m].selectors.length,f=0;f<p;){var v=s[m].selectors[f];if((l=this.selectors[v])&&l.fields){var y=s[m].subBuckets||(s[m].subBuckets={});for(var b in l.fields)y[b]||(y[b]={}),y[b].title=l.fields[b].title}f++}g[m]=[]}this.currentReportingPeriod;for(var S in t)if(t.hasOwnProperty(S))if(c=!1,u=!1,(S=t[S]).bucket!==r&&s[S.bucket])S._bucket=S.bucket,g[S.bucket].push(S);else{for(a in s)if("-1"!==a&&e.is_obj(s[a])){for(d=!1,i=(n=s[a].selectors).length,o=0;o<i&&((l=this.selectors[n[o]])&&(h=this.gradeSchemes[S.scheme],h=this.getRealScheme(h),l.assessmentType!==r&&l.assessmentType==S.type?d=a:l.scheme&&l.scheme==S.scheme||h&&h.group&&h.group==l.scheme||h&&h.name&&h.name==l["data-value"]?d=a:-5==l["data-value"]&&(d=a)),!1===d);)o++;if(!1===d||c){if(!1!==d&&c){u="-2";break}}else u=d,c=!0}!1===u&&(u="-1"),S._bucket=u,g[u].push(S)}return g},buildStandardsTree:function(t,s){try{if(e.get("standards")!==r&&s.learningstandards){var i;if(t.standards=e.get("standards").construct(s.learningstandards),t.strandsCodeMap={},t.codeStrandsMap={},Array.isArray(t.CourseID)){i={};var n=!0,a=!1,o=r;try{for(var l,u=t.CourseID[Symbol.iterator]();!(n=(l=u.next()).done);n=!0){var c=l.value;t.standards.standardsTree[c]&&(i=_objectSpread({},i,t.standards.standardsTree[c].children))}}catch(e){a=!0,o=e}finally{try{n||null==u.return||u.return()}finally{if(a)throw o}}}else i=t.standards.standardsTree[t.CourseID].children;if(t.strands){var d=!0,h=!1,g=r;try{for(var m,p=t.strands[Symbol.iterator]();!(d=(m=p.next()).done);d=!0){var f=m.value;for(var v in i){var y=i[v];y.body==f.name&&(t.strandsCodeMap[f.key]=y.fullcode,t.codeStrandsMap[y.fullcode]=f.key)}}}catch(e){h=!0,g=e}finally{try{d||null==p.return||p.return()}finally{if(h)throw g}}}}}catch(e){}},averages:function(){var e,t,s,r=this.students,i={};for(t in r)e=r[t],this.overallAverage(e,!0),s=this.normalizePercent(e.average),isNaN(s)?i[e.rid]="":i[e.rid]=s;return i},termAverage:function(t,s){if(e.is_obj(t)||(t=this.students[t]),e.is_obj(s)||(s=this.terms[s]),t){var i,n,a=t.normalized,o={};for(var l in a)((i=this.assessments[l]).thread===s.nid||(n=this.units[i.thread])&&n.thread===s.nid)&&(o[i.nid]=!0);var u=this.aggregateAssessments("overall",t,s.nid,r,r,r,!1,1);return t.terms||(t.terms={}),t.terms[s.nid]=u,u}},unitReportingPeriod:function(e){var t=e.assessments;if(!t)return self.nid;var s=t[0];if(!s)return self.nid;var r=s.reporting;return r?r.nid:self.nid},unitAverage:function(t,s){var i=this.unitReportingPeriod(s);if(e.is_obj(t)||(t=this.students[t]),!e.is_obj(s))this.terms[s];if(t){for(var n=s.assessments,a=n&&n.length||0,o={};a--;)o[n[a].nid]=!0;var l=this.aggregateAssessments("overall",t,i,r,r,r,!1,1);return t.units||(t.units={}),t.units[s.nid]=l,l}},currentAMap:function(){var e={};if(this._currentAMap)return this._currentAMap;if(this.currentReportingPeriod&&2===this.AverageType)e=this.currentReportingPeriod.amap;else for(var t in this.assessments)e[t]=!0;return this._currentAMap=e,e},calculateSummaryCol:function(t,s,i,n){var a,o=s.summary,l=(s.type,s.showas),u=s.scheme,c=s.ignorewb;this.buckets[n];if(2==s.type)return t.StudentID;if(3==s.type)return t.nEvidence===r?0:t.nEvidence;var d=s.subCol,h={scheme:u,ignoreWeightingBuckets:c},g=this.getHierarchicalBucket(n),m=!1!==g||o in e.lookupAll("GradebookSummaryTypesOutcomes");if(m&&this.strandsCodeMap&&d in this.strandsCodeMap&&(d=this.strandsCodeMap[d]),m){var p=this.getHSAPolicy(g,o,d);a=this.aggregateAssessments(d,t,n,u,r,r,!1,o,p,l)}else 1==o?a=this.mean(t,i,n,d,h):2==o?a=this.mode(t,i,n,d,l,h):3==o?(i=this.filterAssessments(n,u,r,r,r,!0),a=this.range(t,i,n,d)):4==o?(i=this.filterAssessments(n,u,r,r,r,!0),a=this.completedCount(t,i,n,d)):5==o?(i=this.filterAssessments(n,u,r,r,r,!0),(a=this.stdDev(t,i,n,d))===r?a="-":a/=100):6==o?(i=this.filterAssessments(n,u,r,r,r,!0),a=this.median(t,i,n,d)):7==o?a=this.latestSummary(t,i,n,d,h):12==o&&(a=this.highestSummary(t,i,n,d,h));e.is_arr(a)||(a=[a]);for(var f=e.lookup("GradebookSummaryTypes",o),v=[],y=0;y<a.length;y++)2==o&&!m||f&&f.params&&f.params.noconfig?5==o?v.push(this.percent(a[y])):v.push(a[y]):0!=l&&l?a[y]!==r?v.push(this.symbolicMap(l,null===a[y]?null:100*a[y])):v.push("-"):v.push(this.percent(a[y]));return f&&f.params&&f.params.join?v.join(" "+f.params.join+" "):v.join(" - ")},calcualteAllSummaryCols:function(t){var s,r=this.currentAMap();s=this.currentReportingPeriod&&2===this.AverageType?this.currentReportingPeriod.nid:this.nid,e.is_obj(t)||(t=this.students[t]);var i=this.SummaryCols||[{type:1}];t.summaryCols=[];for(var n=0;n<i.length;n++)t.summaryCols.push(this.calculateSummaryCol(t,i[n],r,s))},overallAverage:function(t,s,i){e.is_obj(t)||(t=this.students[t]);var n,a=t.normalized,o={},l=this.currentReportingPeriod;if(l&&2===this.AverageType)o=this.currentReportingPeriod.amap,n=l.nid;else for(var u in n=this.nid,a)o[u]=!0;var c=this.mean(t,o,n);isNaN(c)&&(c=r);var d=this.normalizePercent(t.average)/100;if(isNaN(d)&&(d=r),c!=d&&!0!==s&&i===r&&(this.hasOutOfSync=!0,this.outOfSync[t.rid]=this.percent(c,!0),s=!0),this.calcualteAllSummaryCols(t),!0===s||""===t.average||t.average===r){if(i)return c;t.average=c}return t.average!==r?t.average:NaN},completedAssessments:function(){var e=this.assessments,t={};for(var s in e)e[s]._completed&&(t[s]=e[s]);return t},completedCount:function(t,s,i,n,a){s=s||this.currentAMap(),e.is_obj(t)||(t=this.students[t]);var o=!1,l=0;for(var u in n&&!Array.isArray(n)&&(n=[n]),a&&a.countUngraded&&(o=!0),s)if((t.grades[u]&&t.grades[u].v||o)&&(this.assessments[u]&&(!this.assessments[u].individualAssessment||this.assessments[u].studentAssigned[t.nid])||this.evidenceData[u]&&this.evidenceData[u].snids&&this.evidenceData[u].snids.split(",").includes(""+t.nid))){var c=!1;if(n){c=!0;var d=!0,h=!1,g=r;try{for(var m,p=n[Symbol.iterator]();!(d=(m=p.next()).done);d=!0){var f=m.value;if(t.normalized[u].cols[f]!==r&&!1!==t.normalized[u].cols[f]||o&&(this.assessments[u]&&this.assessments[u].columns[f]||this.evidenceData&&this.evidenceData[u]&&this.evidenceData[u].standards&&this.evidenceData[u].standards.split(",").includes(f))){c=!1;break}}}catch(e){h=!0,g=e}finally{try{d||null==p.return||p.return()}finally{if(h)throw g}}}if(c)continue;l++}return l+""},range:function(t,s,i,n){var a,o;e.is_obj(t)||(t=c.students[t]);var l;for(var u in s)if(t.grades[u].v&&this.assessments[u]){if(n&&(t.normalized[u].cols[n]===r||!1===t.normalized[u].cols[n]))continue;((l=n?t.normalized[u].cols[n]:t.normalized[u].average)<a||a===r)&&(a=l),(l>o||o===r)&&(o=l)}return[a,o]},mean:function(e,t,s,i){var n,a=arguments.length>4&&arguments[4]!==r?arguments[4]:{},o=a.scheme,l=!!a.ignoreWeightingBuckets;if(i){var u=[];for(var c in t)u.push(this.assessments[c]);n=this.aggregateAssessments(i,e,s,o,r,r,l,"mean")}else n=this.aggregateAssessments("overall",e,s,o,r,r,l,"mean");return this.normalizePercent(n)/100},mode:function(e,t,s,i,n){var a=[],o=(arguments.length>5&&arguments[5]!==r?arguments[5]:{}).scheme;for(var l in t)t[l]&&a.push(this.assessments[l]);return this.aggregateAssessments(i,e,s,o,r,r,!0,2.1,r,n)},median:function(t,s,i,n){s=s||this.currentAMap(),e.is_obj(t)||(t=this.students[t]);var a=[];for(var o in n&&!Array.isArray(n)&&(n=[n]),s)if(t.grades[o]&&t.grades[o].v)if(n){var l=!0,u=!1,c=r;try{for(var d,h=n[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var g=d.value;t.normalized[o].cols[g]!==r&&a.push(t.normalized[o].cols[g])}}catch(e){u=!0,c=e}finally{try{l||null==h.return||h.return()}finally{if(u)throw c}}}else a.push(t.normalized[o].average);a.sort(function(e,t){return e-t});var m=Math.floor(a.length/2);return a.length%2?a[m]:(a[m-1]+a[m])/2},stdDev:function(t,s,i,n){e.is_obj(t)||(t=this.students[t]);var a=this;if(s){var o={};for(var l in s)o[l]=this.assessments[l]}else o=a.completedAssessments();function u(e){return"gs_yesno"===o[e].scheme||1==o[e].points||(2==o[e].summative||8==a.getAttr(t,e,"r")||a.getAttr(t,e,"d"))}var c=t.normalized,d=0,h=0,g=0;for(var l in o){var m=a.normalizedAverage(t,l);if(!u(l)&&(!1!==m&&!isNaN(m))){c=t.normalized[l].cols;if(n)!o[l].colweights[n]||t.normalized[l].cols[p]&&"total)"===t.grades[l].o||(g+=o[l].colweights[n],d+=c[n],h++);else for(var p in c)!1===t.normalized[l].cols[p]&&"total"===t.grades[l].o||(g+=o[l].colweights[p],d+=c[p],h++)}}d/=h;var f,v=0,y=0;if(!isNaN(d))for(l in o)if(m=a.normalizedAverage(t,l),!u(l)&&!1!==m&&!isNaN(m))if(c=t.normalized[l].cols,n)!o[l].colweights[n]||t.normalized[l].cols[p]&&"total)"===t.grades[l].o||(f=c[n]-d,v+=o[l].colweights[n]*f*f,y++);else for(p in c)!1===t.normalized[l].cols[p]&&"total"===t.grades[l].o||(f=c[p]-d,v+=o[l].colweights[p]*f*f,y++);var b=v/g;return y<4&&!s?r:100*(Math.sqrt(b)||0)},latestSummary:function(e,t,s,i){var n,a=arguments.length>4&&arguments[4]!==r?arguments[4]:{},o=a.scheme,l=!!a.ignoreWeightingBuckets;return n=i?this.aggregateAssessments(i,e,s,o,r,r,!0,"latest"):this.aggregateAssessments(i,e,s,o,r,r,l,"latest"),this.normalizePercent(n)/100},latest:function(e,t,s,i,n){var a,o,l=arguments.length>5&&arguments[5]!==r?arguments[5]:{},u=0,c=l&&l.formative;for(var d in n&&!Array.isArray(n)&&(n=[n]),e){var h=e[d],g=h.nid,m=!1,p=void 0;if(n){var f=!0,v=!1,y=r;try{for(var b,S=n[Symbol.iterator]();!(f=(b=S.next()).done);f=!0){b.value in h.columns&&(m=!0)}}catch(e){v=!0,y=e}finally{try{f||null==S.return||S.return()}finally{if(v)throw y}}}if(t.grades[g]&&s[g]&&(!n||m)&&!t.grades[g].d&&("0"!=h.summative&&3!=h.summative||c)){var k=t.grades[g],A=(k.o?k.o.split(" "):[]).includes("total"),w=Date.parse(t.grades[g].a);if(!a||w>a){if(n){var _=!1,N=!0,C=!1,P=r;try{for(var M,z=n[Symbol.iterator]();!(N=(M=z.next()).done);N=!0){var B=M.value,D=t.normalized[g].cols[B];if(!(null===D||!1===D&&A)&&(_=!0,p=B,(o=D)!==r))break}}catch(e){C=!0,P=e}finally{try{N||null==z.return||z.return()}finally{if(C)throw P}}if(!_)continue}else{var j=t.normalized[g].average;if(null===j||!1===j&&A)continue;o=j}a=w,u=p?h.colweights[p]:h.weighting}}}return{average:o,weighting:u,timeGraded:a}},highestSummary:function(e,t,s,i){var n,a=arguments.length>4&&arguments[4]!==r?arguments[4]:{},o=a.scheme,l=!!a.ignoreWeightingBuckets;return n=i?this.aggregateAssessments(i,e,s,o,r,r,!0,"highest"):this.aggregateAssessments(i,e,s,o,r,r,l,"highest"),this.normalizePercent(n)/100},highest:function(e,t,s,i,n){var a=arguments.length>5&&arguments[5]!==r?arguments[5]:{},o=0,l=0,u=!1,c=a&&a.formative;for(var d in n&&!Array.isArray(n)&&(n=[n]),e){var h=e[d],g=h.nid,m=!1;if(n){var p=!0,f=!1,v=r;try{for(var y,b=n[Symbol.iterator]();!(p=(y=b.next()).done);p=!0){y.value in h.columns&&(m=!0)}}catch(e){f=!0,v=e}finally{try{p||null==b.return||b.return()}finally{if(f)throw v}}}if(t.grades[g]&&s[g]&&(!n||m)&&!t.grades[g].d&&("0"!=h.summative&&3!=h.summative||c)){var S=void 0;if(n){var k=!0,A=!1,w=r;try{for(var _,N=n[Symbol.iterator]();!(k=(_=N.next()).done);k=!0){var C=_.value,P=t.normalized[g].cols[C];P>=o&&(o=P,l=h.colweights[C],u=!0)}}catch(e){A=!0,w=e}finally{try{k||null==N.return||N.return()}finally{if(A)throw w}}}else(S=t.normalized[g].average)>=o&&(o=S,l=h.weighting,u=!0)}}return!1===u&&(o=r),{average:o,weighting:l}},weightedMode:function(t,s,i,n,a,o){var l=arguments.length>6&&arguments[6]!==r?arguments[6]:{},u=l&&l.formative;i=i||this.currentAMap();e.is_obj(s)||(s=this.students[s]);var c,d,h={},g=0,m={};for(var p in t){var f=t[p],v=f.nid;if(("0"!=f.summative&&"3"!=f.summative||u)&&!(s.grades&&s.grades[f.nid]&&s.grades[f.nid].d)&&s.normalized[v].average){if(c=r,d=r,a){if(!f.colweights[a])continue;s.normalized[v].cols[a]!==r&&(c=s.normalized[v].cols[a]),f.colweights[a]&&(d=f.colweights[a])}else c=s.normalized[v].average,d=f.weighting;if(!1===c&&"total"===s.grades[f.nid].o)continue;c=null===c?c:parseFloat(100*c),o&&(c=this.symbolicMap(o,c)),c!==r&&(h[c]?h[c]++:h[c]=1,m[c]?m[c]+=d:m[c]=d,h[c]>=g&&(g=h[c]))}}var y=0,b=0,S=[];for(c in h)h[c]===g&&(S.push(c),0===y&&"null"===c?y=null:"null"!==c&&(y+=c*m[c],b+=m[c]));return null!==y?y/=b:b=m.null,{weightedMode:y,modeArray:S=S.sort()}},rollupConsistency:function(){var e=this.students,t=0,s=0;for(var i in e){var n=this.stdDev(i);n===r||isNaN(n)||(t++,s+=n)}this.consistencyRollup=s/t},consistency:function(t,s){if(s=s||{},this.consistencyRollup||this.rollupConsistency(),e.is_obj(t)||(t=this.students[t]),t){var i=new Date(Date.now()-7776e6),n=new Date(Date.now()-432e7),a=new Date(Date.now()-2592e6),o=0,l=0,u=0,c=0,d=!1,h=this,g=0,m=0,p=h.completedAssessments(),f=(t.normalized,0);for(var v in p){var y=h.normalizedAverage(t,v);if(!_(v)&&(f++,0===y?g++:!1===y&&p[v].graded&&m++,!1!==y&&!isNaN(y))){var b=p[v].compDate;b<a&&b>=i?(b<=n&&(d=!0),o+=y,l++):b>=a&&(u+=y,c++)}}var S=this.stdDev(t),k=S;S<1.07*this.consistencyRollup&&(S=r),o/=l,u/=c;var A=d&&100*(u-o),w=A;return w=!isNaN(w)&&w!==r&&Math.round(100*w)/100,(Math.abs(A)<5||isNaN(A))&&(A=r),{trend:w,change:A,totalCompleted:f,stdDevActual:Math.round(100*k)/100,percentZero:Math.round((g||0)/f*100),percentMissing:Math.round((m||0)/f*100),increase:A&&A>0&&A,decrease:A&&A<0&&A,inconsistent:S||r,missing:m||r,zero:g||r,hasFlags:A||S||m||g}}function _(e){return"gs_yesno"===p[e].scheme||1==p[e].points||(2==p[e].summative||8==h.getAttr(t,e,"r")||h.getAttr(t,e,"d"))}},saveGrade:function(t){var s=this.students[t.snid],r={rid:s.rid,field:t.anid};if((t.value||0===t.value||""===t.value)&&(r.value=t.value),t.attr?(r.attr=t.attr,this.setAttr(s,t.anid,r.attr,r.value)):(r.key=t.col||"0",this.setGrade(s,t.anid,r.key,r.value)),this.rubric&&(r.rubric=this.rubric),t.validGrade&&(r.validGrade=1),t.aux)for(var i in t.aux)r[i]=t.aux[i];e.post({data:r,url:{command:"putlink",nid:this.nid,xds:t.xds},errorDialog:!0,error:t.error,success:t.success})},setGrade:function(t,s,i,n){e.is_obj(t)||(t=this.students[t]);var a=s;if(e.is_obj(s)?a=s.nid:s=this.assessments[a],t.grades[a]===r&&(t.grades[a]={}),!t.grades[a].cols&&(t.grades[a].cols={}),t.grades[a].cols[i]=n,e.is_obj(s))return this.normalizeAssessment(t,s)},setAttr:function(t,s,i,n){e.is_obj(t)||(t=this.students[t]);var a=s;e.is_obj(s)&&(a=s.nid),t.grades[a]===r&&(t.grades[a]={}),t.grades[a][i]=n},getAttr:function(t,s,i){e.is_obj(t)||(t=this.students[t]);var n=s;if(e.is_obj(s)&&(n=s.nid),t.grades[n]!==r)return t.grades[n][i]},getGrade:function(t,s,i){e.is_obj(t)||(t=this.students[t]);var n=s;if(e.is_obj(s)&&(n=s.nid),t.grades[n]!==r)return t.grades[n].cols[i||"0"]},normalizedAverage:function(t,s){e.is_obj(t)||(t=this.students[t]),e.is_obj(s)||(s=this.assessments[s]);var r=s.nid;return!!t.normalized[r]&&t.normalized[r].average},normalizedCol:function(e,t,s){var r=this.normalizedAssessment(e,t);return r&&r.cols&&r.cols[s]},normalizedAssessment:function(e,t){return this.normalizeAssessment(e,t,!0)},normalizeAssessment:function(t,s,i){e.is_obj(t)||(t=this.students[t]),e.is_obj(s)||(s=this.assessments[s]);var n=s.nid;return i?s.individualAssessment&&!s.studentAssigned[t.nid]&&(t.ia_normalized[n]=this.normalizeGrade(t.grades[n],s),t.normalized[n]=this.normalizeGrade(r,s)):t.normalized[n]=this.normalizeGrade(t.grades[n],s),t.normalized[n]},normalizeAll:function(e){var t=this.students;e&&((t={})[e.nid]=e);var s,r,i,n,a=this.assessments;for(s in a)for(r in t)n=i=t[r].grades,(i="object"===_typeof(i)&&"object"===_typeof(i[s])?i[s]:{}).cols="object"===_typeof(i.cols)?i.cols:{},n[s]||(n[s]=i),this.normalizeAssessment(t[r],a[s])},normalizeEvidence:function(e,t){var s;for(var r in e||(e=this.evidenceData),s=t?[this.students[t]]:this.students,e){var i=e[r];for(var n in i&&!i.synthetic&&(i=this.syntheticAssessment(i)),s){var o=s[n];if(!o.normalized[i.nid]||!o.normalized[i.nid].synthetic)if(o.normalized[i.nid]&&!isNaN(o.normalized[i.nid].average)&&!1!==o.normalized[i.nid].average){for(var l in i.colweights)if(!(l in o.normalized[i.nid].cols)){var u=i.scheme&&this.gradeSchemes[i.scheme];if(a[u.group]){var c=this.convertStandardToStrand(l,a[u.group])[0];o.normalized[i.nid].cols[l]=o.normalized[i.nid].cols[c]}else o.normalized[i.nid].cols[l]=o.normalized[i.nid].average}}else{if(o.grades[i.nid]){var d=o.grades[i.nid].cols[0];for(var h in i.colweights)o.grades[i.nid].cols[h]||(o.grades[i.nid].cols[h]=d);d&&(o.grades[i.nid].v=1)}this.normalizeAssessment(o,i),o.normalized[i.nid].synthetic=!0}}}},xprt:function(){var t=function(e){return e.indexOf(",")>=0?'"'+e+'"':e},s=[e.lang("Header Column"),e.lang("First Name"),e.lang("Last Name"),e.lang("Edsby ID"),e.lang("Student ID"),"Overall Average"],i=[e.lang("Edsby ID"),"","","","",""],n=[e.lang("Assessment Column ID"),"","","","",""],a=[e.lang("Assessment Out Of"),"","","","",""],o=[e.lang("Assessment Grade Scheme ID"),"","","","",""],l=[e.lang("Assessment Weighting"),"","","","",""],u=[e.lang("Assessment Date"),"","","","",""],c=[e.lang("Assessment Type"),"","","","",""],d=[e.lang("Unit ID"),"","","","",""],h=[e.lang("Unit Name"),"","","","",""],g=e.get("bookGrades").studentsOrder,m=(this.assessments,g.length),p=[s,i,n,a,o,l,u,c,d,h],f=p.length;for(b=0;b<m;b++)p.push(["",e.htmlentitiesdecode(g[b].first),e.htmlentitiesdecode(g[b].last),g[b].nid,e.htmlentitiesdecode(g[b].StudentID),100*g[b].average]);var v,y,b,S,k,A,w=bookGrades.cols;v=w.length;for(var _=0;_<v;_++){if(y=w[_].rows.length,A=w[_],(k=w[_].item).nodesubtype===e.nt.Document.Unit(!0)?s.push(t(e.htmlentitiesdecode(this.unitName(k)))):s.push(t(e.htmlentitiesdecode(k.name))),i.push(k.nid),n.push(A.schemeCol),u.push(k.date),k.nodesubtype===e.nt.Document.Assignment(!0)&&1===A.type){o.push(k.scheme),a.push(k.columns[A.schemeCol]),l.push(k.colweights[A.schemeCol]);var N=e.lookup("assessmentTypes",k.type);c.push(t(N&&N.str&&N.str()||"")),d.push(k.thread),h.push(t(this.unitName(this.units[k.thread])))}else o.push(""),5===A.type?a.push(e.lang("No Grade Scheme")):A.schemeCol?a.push(e.lang("Assessment Total Column")):a.push(e.lang("Summary Column")),l.push(""),c.push(e.lookup("nt",k.nodetype+"."+k.nodesubtype).str(!0)),u.push(""),d.push(""),h.push("");for(b=0;b<y;b++)S=this.getCellValue({col:w[_],student:w[_].rows[b]}),101!=A.type&&((S===r||!1===S||isNaN(S)&&1!==A.type)&&(S=""),1!==A.type&&""!==S&&(S=this.percent(S))),p[f+b].push(S)}return p},averageSummaryColumn:function(e,t,s){return""},averageColumn:function(t,s){var r;r=t&&t.nodesubtype==e.nt.Document.ReportingPeriod(!0)?["reporting",t.nid]:t&&t.nodesubtype==e.nt.Document.Unit(!0)?["units",t.nid]:t&&t.nodesubtype==e.nt.Document.Assignment(!0)?["normalized",t.nid]:[],s&&-1!=s?r.push.apply(r,["cols",s]):t&&(!t||s&&-1!=s)||r.push("average");var i,n,a,o=this.studentsOrder||this.students,l=0,u=0,c=r.length;for(a in o)if(o.hasOwnProperty(a)){for(n=0,i=o[a];n<c&&"object"===_typeof(i)&&null!==i;)i=i[r[n]],n++;"number"!=typeof(i=parseFloat(i))||isNaN(i)||(l+=i,u++)}return l=u>0?l/u:NaN},normalizeGrade:function(e,t,s){var i=e&&e.cols,n={cols:{},sum:0,total:0,sTotal:0,sSum:0},a=t.gs;if(i===r||!a)return n.average=!1,n;var o,l,u,c,d=a.mapping,h=a.cols,g=0,m=this.valid.upper/100,p=this.valid.lower/100;if(t.rubric&&!t.rubricRow&&(d="percent"),!a.numCols){var f={};for(o in h)1!==f[o]&&(f[o]=1,g++);a.numCols=g,g=0}var v,y=(e.o?e.o.split(" "):[]).includes("total"),b=(f={},0),S=!1;for(o in h)if(1!==f[o]){f[o]=1;var k=void 0;if(k=a.cols[o]&&a.cols[o].mapping?"points"===a.cols[o].mapping||"percent"===a.cols[o].mapping?a.cols[o].mapping:this.mappingSchemes[a.cols[o].mapping].mapping:d,l=i[o],(v=e.ct||e.coltotals)||"object"!==_typeof(e.f)||(v=e.f),u="object"===_typeof(v)&&v[o]||t.columns[o],"percent"===k||"points"==k){if(l&&isNaN(l)&&t.rubric&&a.mapping[l]&&null===a.mapping[l].percentage){n.cols[o]=null,n.total=1;var A=t.colweights[o];b+=isNaN(A)?0:A;continue}(!1===u||null===u||!0===u)&&(u=NaN),(!1===l||null===l||!0===l||""===l||" "===l)&&(l=NaN),u=+u,isNaN(u)&&(u=0),(!1===l||null===l||!0===l)&&(l=parseFloat(l)),!isNaN(l)&&(l=+l),0==u&&"percent"!==k||isNaN(l)||("percent"===k&&(u=100),((c=l/u)<=m&&c>=p||s||this.allowOverride(e,o))&&(n.cols[o]=c,n.sum+=l/u*(t.colweights[o]/t.weighting),n.total=1,n.sTotal+=u,n.sSum+=l))}else l!==r&&(k[l=(l+"").toUpperCase()]&&l.length&&(i[o]=l),u&&(n.cols[o]=k[l]?+k[l].percentage/100:r,k[l]&&null==k[l].percentage&&(S=!0,n.cols[o]=null),n.cols[o]!==r&&!1!==n.cols[o]&&(n.sum+=n.cols[o]*(t.colweights[o]/t.weighting),n.total=1)));if((n.cols[o]>=0||0==u)&&g++,n.cols[o]===r&&(n.cols[o]=!1),y&&!n.cols[o]&&0!==n.cols[o]||S){var w=t.colweights[o];b+=isNaN(w)?0:w}S=!1}return"object"===_typeof(i)?n.average=a.numCols>1?n.sum/n.total:n.cols[o]:n.average=!1,g!==a.numCols&&!y&&(n.average=!1),isNaN(n.average)&&(n.average=!1),n.average&&b?n.average*=t.weighting/(t.weighting-b):b&&t.weighting==b&&(n.average=null),n},filterAMapByUnit:function(e,t){var s=this.units[e]&&this.units[e].amap,r={};for(var i in t)s&&s[i]&&(r[i]=1);return r},aggregateVirtualSubCol:function(e,t,s,i,n,a,o){var l=[];if(e===r&&s)for(var u in e=[],s)e.push(this.assessments[u]);var c=!0,d=!1,h=r;try{for(var g,m=o.allotment[i].values()[Symbol.iterator]();!(c=(g=m.next()).done);c=!0){var p=g.value;l.push(a(e,t,s,p,n))}}catch(e){d=!0,h=e}finally{try{c||null==m.return||m.return()}finally{if(d)throw h}}return i in this.codeStrandsMap&&l.push(a(e,t,s,this.codeStrandsMap[i],n)),this.collateSecondaryColumns(n,l)},collateSecondaryColumns:function(e,t){if(!e||"1"==e){var s=0,i=0,n=!1,a=!0,o=!1,l=r;try{for(var u,c=t[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var d=u.value;d.average===r||!1===d.average||isNaN(d.average)||null===d.average||(s+=(d.average||0)*d.weighting,i+=d.weighting,n=!0)}}catch(e){o=!0,l=e}finally{try{a||null==c.return||c.return()}finally{if(o)throw l}}return n||(s=r),{average:s/=i,weighting:i}}if("2"==e){var h={},g=0,m=0,p=0,f=!0,v=!1,y=r;try{for(var b,S=t[Symbol.iterator]();!(f=(b=S.next()).done);f=!0){var k=b.value;isNaN(k.average)||(k.average in h?(h[k.average].count+=1,h[k.average].weighting+=k.weighting):h[k.average]={count:1,weighting:k.weighting},h[k.average].count>g&&(g=h[k.average].count))}}catch(e){v=!0,y=e}finally{try{f||null==S.return||S.return()}finally{if(v)throw y}}for(var A in h)h[A].count==g&&(m+=h[A].weighting,p+=A*h[A].weighting);return 0==Object.keys(h).length?p=r:p/=m,{average:p,weighting:m}}if("3"==e||"4"==e){var w,_,N,C=!0,P=!1,M=r;try{for(var z,B=t[Symbol.iterator]();!(C=(z=B.next()).done);C=!0){var D=z.value,j="3"==e?D.timeGraded:D.average;(!w||j>w&&D.average!==r&&!1!==D.average&&!isNaN(D.average)&&null!==D.avearge)&&(w=j,_=D.average,N=D.weighting)}}catch(e){P=!0,M=e}finally{try{C||null==B.return||B.return()}finally{if(P)throw M}}return{average:_,weighting:N}}if("5"==e){var x,T,O=!0,L=!1,R=r;try{for(var F,G=t[Symbol.iterator]();!(O=(F=G.next()).done);O=!0){var W=F.value;(W[0]<x||x===r)&&(x=W[0]),(W[1]>T||T===r)&&(T=W[1])}}catch(e){L=!0,R=e}finally{try{O||null==G.return||G.return()}finally{if(L)throw R}}return[x,T]}if("6"==e){var E=0,I=!0,U=!1,V=r;try{for(var H,J=t[Symbol.iterator]();!(I=(H=J.next()).done);I=!0){E+=+H.value}}catch(e){U=!0,V=e}finally{try{I||null==J.return||J.return()}finally{if(U)throw V}}return E}},bucketAggregationFunction:function(e,t,s,r,i,n,a,o){var l=this;function u(t,s,r,i,o,u){return o&&"1"!=o?"2"==o||"2.1"==e?n||"2.1"==e?l.weightedMode(t,s,r,0,i,a,u):l.aggregateMode(t,s,r,i,u):"3"==o?l.latest(t,s,r,0,i,u):"4"==o?l.highest(t,s,r,0,i,u):"5"==o?{average:l.completedCount(s,r,0,i,{countUngraded:!0})}:"6"==o?{average:l.median(s,r,0,i)}:void 0:l.averageAssessments(t,s,r,i,u)}return n?l.aggregateVirtualSubCol(t,s,r,i,e,u,n):u(t,s,r,i,e,o)},aggregateMode:function(e,t,s,i,n){var a=this.weightedMode(e,t,s,0,i,r,n);if(!a.modeArray.length)return{average:NaN,weighting:0};var o=a.weightedMode;return{average:null===o?null:(o/100).toFixed(2),weighting:1}},bucketedAverage:function(t,s,i,n){var a;if(n&&n.bucket){var o=""+n.bucket,l=n.subBucket;l&&(u=this.getMutualStrandColumns(u))}else if(n&&n.subCol){var u=n.subCol;u=this.getMutualStrandColumns(u)}n&&n.aggregationFunction&&(a=n.aggregationFunction);var c,d,h,g,m,p=[],f=[];(e.is_obj(s)||(s=this.students[s]),i&&this.buckets[i]?(h=this.buckets[i],g=this.bucketed[i]):(h=this.buckets[this.nid],g=this.bucketed[this.nid]),o)&&(o=o.split(",").sort().join(","));for(var v in h)if("bucketLen"!==v){if(1==h[v].standardsSchemeLevel&&h[v].selectors.includes("19")&&(m=this.virtualStandardsSchemeBucket(h[v].subBuckets,h[v].standardsSchemeLevel)),o){if((h[v].selectors||[-1]).join(",").split(",").sort().join(",")!==o)continue;var y=a||h[v].aggregationMethod;return this.bucketAggregationFunction(y,g[v],s,t,l,m).average}if(h[v].subBuckets){var b=void 0;if(m&&(!u||u in m.allotment)){var S=m.buckets;b={};var k=!0,A=!1,w=r;try{for(var _,N=S[Symbol.iterator]();!(k=(_=N.next()).done);k=!0){var C=_.value;C.id=C.subBucket,b[C.subBucket]=C}}catch(e){A=!0,w=e}finally{try{k||null==N.return||N.return()}finally{if(A)throw w}}}else b=h[v].subBuckets,m=r;for(c in b){if(h[v].unitBucket){var P=this.filterAMapByUnit(b[c].id,t),M=a||h[v].aggregationMethod;d=this.bucketAggregationFunction(M,g[v],s,P,u)}else{if(u&&(!Array.isArray(u)||!u.includes(c))&&u!=c)continue;if(!m&&this.strandsCodeMap&&c in this.strandsCodeMap){var z=c;c=[c,this.strandsCodeMap[c]]}else if(!m&&this.codeStrandsMap&&c in this.codeStrandsMap){z=c;c=[c,this.codeStrandsMap[c]]}var B=a||h[v].aggregationMethod;d=this.bucketAggregationFunction(B,g[v],s,t,c,m)}z&&(c=z),d.weighting&&(f.push(d.average),p.push(b[c].points))}}else{var D=a||h[v].aggregationMethod;(d=this.bucketAggregationFunction(D,g[v],s,t,u,m)).weighting&&(f.push(d.average),p.push(h[v].points))}m=r}if(o)return r;for(var j=p.length,x=0,T=0;j--;)isNaN(parseFloat(f[j]))||(T+=f[j]*p[j],x+=p[j]);return T/x},averageAssessments:function(e,t,s,i){var n,a,o,l,u,c=arguments.length>4&&arguments[4]!==r?arguments[4]:{},d=0,h=0,g=0,m=c&&c.formative;if(i&&!Array.isArray(i)&&(i=[i]),e){for(n=e.length;n--;)if(s[(a=e[n]).nid]){if(i){o=0;var p=!0,f=!0,v=!1,y=r;try{for(var b,S=i[Symbol.iterator]();!(f=(b=S.next()).done);f=!0){var k=b.value;a.columns[k]&&(o+=a.colweights[k],p=!1)}}catch(e){v=!0,y=e}finally{try{f||null==S.return||S.return()}finally{if(v)throw y}}if(p)continue}else o=a.weighting;"1"!=a.summative&&"2"!=a.summative&&!m||!t.grades||t.grades[a.nid]===r||!1===t.normalized[a.nid].average||t.grades[a.nid].d||("1"==a.summative||m&&"0"==a.summative||"3"==a.summative?h+=parseFloat(o)||0:parseFloat(o)||0)}n=e.length;for(var A=0;n--;){a=e[n];var w=t.grades[a.nid];if(s[a.nid]){if(i){var _=!1,N=!0,C=!1,P=r;try{for(var M,z=i[Symbol.iterator]();!(N=(M=z.next()).done);N=!0){M.value in a.columns&&(_=!0)}}catch(e){C=!0,P=e}finally{try{N||null==z.return||z.return()}finally{if(C)throw P}}if(!_)continue}else o=a.weighting;if(("1"==a.summative||"2"==a.summative||m)&&!1!==t.normalized[a.nid].average&&!t.grades[a.nid].d&&a.weighting)if(i){var B=!0,D=!1,j=r;try{for(var x,T=i[Symbol.iterator]();!(B=(x=T.next()).done);B=!0){var O=x.value;if("1"==a.summative||m&&"0"==a.summative||"3"==a.summative){if(!a.columns[O])continue;o=a.colweights[O];var L=t.normalized[a.nid].cols[O];(w.o&&w.o.includes("total")&&!1===L||null===L)&&(A+=isNaN(o)?0:o),d+=t.normalized[a.nid].cols[O]*o}else g+=t.normalized[a.nid].cols[O]*o}}catch(e){D=!0,j=e}finally{try{B||null==T.return||T.return()}finally{if(D)throw j}}}else for(l in u=a.colweights)if("1"==a.summative||m&&"0"==a.summative||"3"==a.summative){var R=t.normalized[a.nid].cols[l];(w.o&&w.o.includes("total")&&!1===R||null===R)&&(A+=isNaN(u[l])?0:u[l]),d+=t.normalized[a.nid].cols[l]*u[l]}else g+=t.normalized[a.nid].cols[l]*u[l]}}}return{weighting:h-=A,average:d=0===h?NaN:d/h+g/h}},filtrAssessments:function(e){return this.filterAssessments(e.rnid,e.scheme,e.unit,e.formative,e.assessments,e.ret_amap,e.atype,e.tags,e.tstart,e.tend,e.evidence,e.transmuteStandards)},filterAssessments:function(t){var s=arguments.length>1&&arguments[1]!==r?arguments[1]:r,i=arguments.length>2&&arguments[2]!==r?arguments[2]:r,a=arguments.length>3&&arguments[3]!==r?arguments[3]:r,o=arguments.length>4&&arguments[4]!==r?arguments[4]:r,l=arguments.length>5&&arguments[5]!==r&&arguments[5],u=arguments.length>6&&arguments[6]!==r?arguments[6]:r,c=arguments.length>7&&arguments[7]!==r?arguments[7]:r,d=arguments.length>8&&arguments[8]!==r?arguments[8]:r,h=arguments.length>9&&arguments[9]!==r?arguments[9]:r,g=arguments.length>10&&arguments[10]!==r?arguments[10]:r,m=arguments.length>11&&arguments[11]!==r?arguments[11]:r,p=[],f={},v={},y=function(e){return e=e!==r?[].concat(e):[]};if(!o)if(t){t&&!Array.isArray(t)&&(t=[t]),o=[];var b=!0,S=!1,k=r;try{for(var A,w=t[Symbol.iterator]();!(b=(A=w.next()).done);b=!0){var _=A.value;o=_ in this.reporting?o.concat(this.reporting[_].assessments):o.concat(e.obj_to_arr(this.assessments))}}catch(e){S=!0,k=e}finally{try{b||null==w.return||w.return()}finally{if(S)throw k}}}else o=e.obj_to_arr(this.assessments);if(g){var N=[];for(var C in this.evidenceData)N.push(this.syntheticAssessment(this.evidenceData[C]));1==g?o=N:2==g&&(o=o.concat(N))}if(s=s!==r&&""!==s?[].concat(s):[],i!==r)if(Array.isArray(i)){var P=!0,M=!1,z=r;try{for(var B,D=i[Symbol.iterator]();!(P=(B=D.next()).done);P=!0){var j=B.value;v=_objectSpread({},v,this.units[j].amap)}}catch(e){M=!0,z=e}finally{try{P||null==D.return||D.return()}finally{if(M)throw z}}}else v=this.units[i].amap;for(var x in a=y(a),u=y(u),c=y(c),!d||d instanceof Date||(d=e.parseDate(d)),!h||h instanceof Date||(h=e.parseDate(h)),o){var T=o[x],O=this.getRealScheme(T.gs);if(!1!==T.columns&&((!s.includes("!standards")||!(T.standards&&T.standards.length||n.includes(T.gs&&T.gs.group)||n.includes(O.id)||n.includes(O.name)))&&(!s.includes("!kica")||!("gs_kica"===T.scheme||T.gs&&"gs_kica"===T.gs.group||"gs_kica"===O.id||"gs_kica"===O.name))&&(s.includes("!standards")||s.includes("!kica")||!s.length||s.includes(T.scheme)||s.includes(O.id)||s.includes(O.name))&&!(i&&!v[T.nid]||u.length&&!u.includes(T.type)||d&&(!T.date||e.parseDate(T.adate)<d)||h&&(!T.adate||e.parseDate(T.adate)>h)))){if(a.length){var L=!0,R=!0,F=!1,G=r;try{for(var W,E=a[Symbol.iterator]();!(R=(W=E.next()).done);R=!0){var I=W.value;if(T.averageType==I){L=!1;break}}}catch(e){F=!0,G=e}finally{try{R||null==E.return||E.return()}finally{if(F)throw G}}if(L)continue}if(c.length)if(T.tags&&T.tags.length){var U=!1,V=T.tags.split(", "),H=!0,J=!1,K=r;try{for(var $,q=V[Symbol.iterator]();!(H=($=q.next()).done);H=!0){var Z=$.value;if(c.includes(Z)){U=!0;break}}}catch(e){J=!0,K=e}finally{try{H||null==q.return||q.return()}finally{if(J)throw K}}if(!U)continue}else if(null!==c[0])continue;p.push(T),f[T.nid]=!0}}if(m){for(var Q=[],X=[],Y=0;Y<p.length;Y++){var ee=p[Y];69==ee.nodesubtype?X.push(ee):Q.push(this.syntheticAssessment(ee))}this.normalizeEvidence(Q),p=Q.concat(X)}return l?f:p},aggregateStandardsColumn:function(e,t,s,i,n,a,l,u){if(n.sub&&n.sub.length){var c=[],d=!0,h=!1,g=r;try{for(var m,p=n.sub[Symbol.iterator]();!(d=(m=p.next()).done);d=!0){var f=m.value,v=this.aggregateStandardsColumn(e,t,s,f.col,f,r,l,u);1==o[n.type]&&f.weighting&&(v.weighting=f.weighting),c.push(v)}}catch(e){h=!0,g=e}finally{try{d||null==p.return||p.return()}finally{if(h)throw g}}return this.collateSecondaryColumns(o[n.type],c)}if(this.convertStandardToStrand(i,1)){var y=this.getStandardsStrandLevel(i);if(y<3){var b=new Set;for(var S in e){var k=e[S];if(s[k.nid])for(var A in k.columns)this.convertStandardToStrand(A,y)[0]==i&&b.add(A)}if(i=this.getMutualStrandColumns(i),Array.isArray(i)){var w=!0,_=!1,N=r;try{for(var C,P=i[Symbol.iterator]();!(w=(C=P.next()).done);w=!0){var M=C.value;b.add(M)}}catch(e){_=!0,N=e}finally{try{w||null==P.return||P.return()}finally{if(_)throw N}}}else b.add(i);i=Array.from(b)}}return a!==r?a(e,t,i):this.bucketAggregationFunction(o[n.type],e,t,s,i,r,u,l)},aggAssessments:function(e,t,s,i,n,a,o,l){return n===r&&(n={}),this.aggregateAssessments(e,t,s,n.scheme,n.unit,n.formative,n.ignoreWeightingBuckets,i,a,o,n.atype,n.tags,n.tstart,n.tend,n.evidence,l)},aggregateAssessments:function(t,s,i){var n,a=arguments.length>3&&arguments[3]!==r?arguments[3]:r,u=arguments.length>4&&arguments[4]!==r?arguments[4]:r,c=arguments.length>5&&arguments[5]!==r?arguments[5]:["1","2"],d=!(arguments.length>6&&arguments[6]!==r)||arguments[6],h=arguments.length>7&&arguments[7]!==r?arguments[7]:1,g=arguments.length>8&&arguments[8]!==r?arguments[8]:r,m=arguments.length>9?arguments[9]:r,p=arguments.length>10?arguments[10]:r,f=arguments.length>11?arguments[11]:r,v=arguments.length>12?arguments[12]:r,y=arguments.length>13?arguments[13]:r,b=arguments.length>14?arguments[14]:r,S=arguments.length>15?arguments[15]:r,k={},A={},w={};e.is_obj(i)&&i.assessments&&(n=i.assessments),n=this.filterAssessments(i,a,u,c,n,!1,p,f,v,y,b,S);var _=!0,N=!1,C=r;try{for(var P,M=n[Symbol.iterator]();!(_=(P=M.next()).done);_=!0){k[P.value.nid]=!0}}catch(e){N=!0,C=e}finally{try{_||null==M.return||M.return()}finally{if(N)throw C}}if(c){var z=!0,B=!1,D=r;try{for(var j,x=c[Symbol.iterator]();!(z=(j=x.next()).done);z=!0){var T=j.value;"0"!=T&&"3"!=T||(w.formative=!0)}}catch(e){B=!0,D=e}finally{try{z||null==x.return||x.return()}finally{if(B)throw D}}}if(e.is_obj(s)||(s=this.students[s]),t=[].concat(t),Array.isArray(i)){var O,L=!0,R=!1,F=r;try{for(var G,W=i[Symbol.iterator]();!(L=(G=W.next()).done);L=!0){var E=G.value;(O===r||this.reporting[E].rpend>O.rpend)&&(O=this.reporting[E])}}catch(e){R=!0,F=e}finally{try{L||null==W.return||W.return()}finally{if(R)throw F}}i=O.nid}var I=i||this.currentReportingPeriod&&this.currentReportingPeriod.nid,U=this.getHierarchicalBucket(I),V=!0,H=!1,J=r;try{for(var K,$=t[Symbol.iterator]();!(V=(K=$.next()).done);V=!0){var q=K.value,Z=this.convertStandardToStrand(q,1);if(!U||d||g){if(!g&&(Z||this.strandsCodeMap&&q in this.strandsCodeMap))g=this.getHSAPolicy(r,h,q);else if(g&&"string"==typeof g)if("overall"===q&&this.standards&&this.standards.standardsTree){var Q=this.standards.standardsTree[this.CourseID],X={type:1,col:q,sub:[]};if(Q)for(var Y in Q.children){var ee=Q.children[Y],te=this.getHSAPolicy(r,o[g],ee.fullcode);te.weighting=te.sub.length,X.sub.push(te)}g=X}else g=this.getHSAPolicy(r,o[g],q)}else g=this.getHSAPolicy(U,h,q);if(g){var se=void 0,re=o[g.type]==o.summaryMode?"modeArray":"average";q||(q=g.col),se=q,this.strandsCodeMap&&q in this.strandsCodeMap&&(se=this.strandsCodeMap[q]),A[q]=this.aggregateStandardsColumn(n,s,k,se,g,r,w,m)[re]}else if(d){var ie,ne=l.includes(q)?r:q,ae=o[h]==o.summaryMode?"modeArray":"average";(ie=this.getVirtualSubBuckets(ne,i))===r&&(ne=this.getMutualStrandColumns(ne)),A[q]=this.bucketAggregationFunction(o[h],n,s,k,ne,ie,m,w)[ae]}else{var oe={};l.includes(q)||(oe.subCol=q),o[h]!==o.mean&&(oe.aggregationFunction=o[h]),A[q]=this.bucketedAverage(k,s,i,oe)}}}catch(e){H=!0,J=e}finally{try{V||null==$.return||$.return()}finally{if(H)throw J}}return 1===t.length&&(A=A[Object.keys(A)[0]]),A},getAssessmentColumns:function(e){var t=arguments.length>1&&arguments[1]!==r?arguments[1]:r,s=arguments.length>2&&arguments[2]!==r?arguments[2]:r,i=arguments.length>3&&arguments[3]!==r?arguments[3]:r,n=arguments.length>4&&arguments[4]!==r&&arguments[4],a=new Set;for(var o in n=this.filterAssessments(e,t,s,i)){var l=n[o];for(var u in l.columns)a.add(u)}return a},assessmentReportingName:function(t){if((e.is_str(t)||e.is_num(t))&&(t=c.assessments[unit]),!t)return"";var s=t.rmap,r=[];if(s)for(var i in s)r.push(this.reporting[i].name);return r.join(", ")},unitName:function(t){return(e.is_str(t)||e.is_num(t))&&(t=this.units[t]),t||(t={}),e.tpl(e.lang("Unit"),{num:t.unitNumber})+(t.name?": "+t.name:"")},colWeights:function(t){var s,i,n=t.gs;if(e.is_obj(t.weighting))s=t.weighting;else try{s=JSON.parse(t.weighting)}catch(e){s=parseFloat(t.weighting)||0}if("object"===_typeof(s)){var a=0;for(var o in s)n.cols[o]?("0"===t.columns[o]&&(t.columns[o]=0),(t.columns[o]||"0"==o)&&(a+=parseFloat(s[o])||0)):delete s[o];t.weighting=a}else{var l=!1;if(t.columns)for(i in t.columns){l=!0;break}if(l){var u=0,c=s;for(i in t.columns)"0"===t.columns[i]&&(t.columns[i]=0),u+=parseFloat(t.columns[i])||0;for(o in s={},t.columns)s[o]=t.columns[o]/u*c||0}else s={0:s}}for(var d in t.colweights=s,t.columns)t.colweights[d]===r&&(t.colweights[d]=0);for(var d in t.columns)t.columns[d]&&n.cols[d]||(delete t.columns[d],delete t.colweights[d])},setOverride:function(t,s){var r=t.o?t.o.split(" "):[];return-1===e.in_array(s,r)&&r.push(s),r=r.join(" "),t._o||(t._o={}),t._o[s]=1,t.o=r,t.o},clearOverride:function(e,t){if(e._o&&e._o[t]){delete e._o[t];var s=[];for(var r in e._o)s.push(r)}return e.o=s.join(" "),e.o},allowOverride:function(e,t){if(!e._o){for(var s=(e.o||"").split(" "),r={},i=s.length;i--;)r[s[i]]=1;e._o=r}return!!e._o[t]},validGrade:function(e){if(e===r||null===e)return!0;var t=e.length,s=parseFloat(e);return s<=this.valid.upper&&s>=this.valid.lower||0===t},normalizePercent:function(e){return isNaN(e)||"number"!=typeof e?NaN:((e=Math.round(e*Math.pow(10,this.SigFigs+2))/Math.pow(10,this.SigFigs))>1e9&&(e=e.toPrecision(this.SigFigs)),e)},percent:function(e,t){var s=this.normalizePercent(e);return isNaN(s)?"-":t?s:s+"%"},publishedGrade:function(t,s){var i,n,a,o,l,u=t.gs,c=(t.colweights,t.weighting,t.columns),d=0,h=[],g=s&&s.r;if(u&&!u.cols&&(u.cols={0:{}}),!1!==(n=this.normalizeGrade(s,t)).average)if("points"===u.mapping||"percent"==u.mapping&&c){a=u.order;var m="points"===u.mapping?"2"!=t.summative?"{{score}}/{{total}}":"{{score}}":"{{score}}%";if(a)for(w=a.length,o=0;o<w;o++){var p=a[o].mapping&&!("points"===a[o].mapping||"percent"===a[o].mapping);if(l=a[o].id,i=p?this.mappingSchemes[a[o].mapping].mapping[(s.cols[l]||"").toUpperCase()].title:+s.cols[l],c[l]&&(!isNaN(i)||p)&&u.cols[l]&&0!=l){var f=!p&&Math.min(2,this.countDecimals(i));h.push({id:a[o].id,name:a[o].title,result:p?i:e.tpl(m,{score:i.toFixed(f)+"",total:c[l]})})}}if(0!==n.sTotal){var v=Math.min(2,this.countDecimals(n.sSum));d=e.tpl(m,{score:n.sSum.toFixed(v)+"",total:n.sTotal})}}else if("percent"===u.mapping)d=s.cols[0]+"%";else if(u.cols&&e.is_obj(u.mapping)&&u.cols[0]===r)for(l in u.cols){_=u.cols[l];var y=l,b=s.cols[l],S=_.mapping?this.mappingSchemes[_.mapping]?this.mappingSchemes[_.mapping].mapping:_.mapping:u.mapping;if("points"===S||"percent"===S){var k="points"===S?"2"!=t.summative?"{{score}}/{{total}}":"{{score}}":"{{score}}%";isNaN(+b)||h.push({id:_.id,name:_.title,result:e.tpl(k,{score:"points"===S?(+b).toFixed(Math.min(2,this.countDecimals(+b)))+"":b,total:c[l]})})}else t.rubric&&(b=this.symbolicMap(_.mapping&&this.mappingSchemes[_.mapping]?S:t.scheme,b)),(l=S[(b||"").toUpperCase()])&&h.push({id:y,name:_.title,result:l.title})}else{var A=s.cols[0];t.rubric&&(A=this.symbolicMap(t.scheme,A)),u.mapping[A]&&(d=u.mapping[A].title||A)}(!u||u.nototal)&&(d="");var w=h.length,_="";for(o=0;o<w;o++)i=h[o],_+=e.html.div(e.html.span(i.result,"xds-bookGrades-publish-cols-result")+e.html.span(i.name,"xds-bookGrades-publish-cols-name"),"xds-bookGrades-publish-cols-col");return{norm:n.sTotal?n.sSum/n.sTotal:n.average,total:d||!1,status:g,cols:_,rcols:h}},averageName:function(e){return this.currentReportingPeriod&&2===this.AverageType?this.currentReportingPeriod.name:e||""},countDecimals:function(e){return Math.floor(e)===e?0:e.toString().split(".")[1].length||0},getCellValue:function(e){var t,s=e.col,i=s.item,n=e.student;if(1===s.type){var a=n.grades[i.nid]||{};(t=a.cols&&a.cols[s.schemeCol])===r&&(t="")}else if(2===s.type&&i.individualAssessment&&!i.studentAssigned[n.nid])t=(n.ia_normalized[i.nid]||{}).average;else if(2===s.type)t=(n.normalized[i.nid]||{}).average;else if(3===s.type)t=n.reporting[i.nid];else if(4===s.type)t=n.average;else if(5===s.type)t="";else if(6===s.type)t=n.units[i.nid];else if(s.type>100&&101==s.type)return n.summaryCols[s.index];return t},inherit:function(e,t){},postGrade:function(t){if(e.is_arr(t.grades)){for(var s,r=t.grades.length,i=r,n=[],a=function(e){n.push(e),0===--i&&t.success(n)},o=[],l=0;l<r;l++)(s=t.grades[l]).success=a,s.error=a,s.errorDialog=!0,s.xds=t.xds,o.push(this.postGrade(s));return o}var u=t.anid,c=t.snid,d=this.students[c],h=d.grades,g=this.assessments[u],m=t.value,p=t.col,f=t.attr,v=t.override,y={};if(f)this.setAttr(c,u,f,m),y.attr=f;else{if(v?v=v:this.allowOverride(h,p)&&(v=this.clearOverride(h,p)),g.overdue){var b=e.in_array(c+"",g.overdue);-1!==b&&(y.clearOverdue=1,g.overdue[b]=!1)}var S=this.setGrade(c,u,p,m),k=this.normalizePercent(this.normalizedCol(d,g,p)),A=this.normalizePercent(this.normalizedAverage(d,u)),w=this.normalizePercent(this.averageColumn(g,p)),_=this.normalizePercent(this.averageColumn(g));g.classAverage=_,y.key=p,!1!==S&&(y.unread=!0),y.l_snid=c,y.l_norm=k,y.l_cnorm=w,y.l_cweight=g.colweights[p],y.l_summative=g.summative}for(var N in y.rid=d.rid,y.value=m,y.field=u,y.key=p,y.overallAverage=this.normalizePercent(this.overallAverage(d,!0)),y.classAverage=this.normalizePercent(this.averageColumn()),y.AverageName=this.averageName(),isNaN(_)||1==g.graded?isNaN(_)&&g.graded&&(y.graded="",delete g.graded):y.graded=g.graded=1,y)"number"==typeof y[N]&&isNaN(y[N])&&(y[N]="");return e.post({data:y,url:{command:"putlink",nid:this.nid,xds:t.xds},errorDialog:!0,error:t.error,success:t.success}),{normalized:S,normalizedCol:k,normalizedAverage:A,colAverage:w,totalAverage:_,overallAverage:y.overallAverage,classAverage:y.classAverage}},virtualStandardsSchemeBucket:function(t,s){var i=[],n={};if(!Array.isArray(t)){var a=t;for(var o in t=[],a){var l=a[o];l.subBucket=o,t.push(l)}}var u=!0,c=!1,d=r;try{for(var h,g=t[Symbol.iterator]();!(u=(h=g.next()).done);u=!0){var m=h.value.subBucket;i.push(m),n[m]=this.convertStandardsToStrands(m,s)[0].key}}catch(e){c=!0,d=e}finally{try{u||null==g.return||g.return()}finally{if(c)throw d}}var p=this.convertStandardsToStrands(i.join(","),s),f={},v={},y=!0,b=!1,S=r;try{for(var k,A=p[Symbol.iterator]();!(y=(k=A.next()).done);y=!0){var w=k.value;f[w.key]={subBucket:w.key,title:w.key,points:0,numa:0,count:0},v[w.key]=new Set}}catch(e){b=!0,S=e}finally{try{y||null==A.return||A.return()}finally{if(b)throw S}}for(var _ in t){var N=t[_],C=n[N.subBucket];v[C].add(N.subBucket),f[C].count+=N.count,f[C].numa+=N.numa,f[C].points+=+N.points}return{buckets:f=e.obj_to_arr(f),allotment:v,keyMap:n}},getVirtualSubBuckets:function(e,t){var s,r=this.buckets[t];for(var i in r){var n=r[i];if(1==n.standardsSchemeLevel&&n.selectors.includes("19")&&(s=this.virtualStandardsSchemeBucket(n.subBuckets,n.standardsSchemeLevel),Object.keys(s.allotment).includes(e)))return s}},markCompleteList:function(e){var t=[];for(var s in this.students){var r=this.students[s].normalized[e];r.average&&r.average>=this.FailThreshold&&t.push(s)}return t},getMutualStrandColumns:function(e){return this.strandsCodeMap&&e in this.strandsCodeMap?e=[e,this.strandsCodeMap[e]]:this.codeStrandsMap&&e in this.codeStrandsMap&&(e=[e,this.codeStrandsMap[e]]),e},getHierarchicalBucket:function(e,t){for(var s in t||(t=this.buckets[e]),t){var r=t[s];if(1==r.standardsSchemeLevel&&r.selectors.includes("19"))return r}return!1},getHSAPolicy:function(t,s,i){if(!t){if(s in e.lookupAll("gradebookAggregationTypes"))for(var n in s=e.lookup("gradebookAggregationTypes",s).val(),e.lookupAll("GradebookSummaryTypesOutcomes")){e.lookup("GradebookSummaryTypesOutcomes",n).params.subaggregation==s&&(s=n)}if(s in e.lookupAll("GradebookSummaryTypesOutcomes")&&this.glo){var a=e.lookup("GradebookSummaryTypesOutcomes",s),o=this.glo,l=[],u=!0,c=!1,d=r;try{for(var h,g=o[Symbol.iterator]();!(u=(h=g.next()).done);u=!0){var m=h.value.key,p=this.convertStandardToStrand(m,1);p&&p.length&&p[0]==i&&l.push({col:m,type:a.params.subaggregation,weighting:1})}}catch(e){c=!0,d=e}finally{try{u||null==g.return||g.return()}finally{if(c)throw d}}return{type:1,col:i,sub:l}}return{type:s,col:i}}var f=this.virtualStandardsSchemeBucket(t.subBuckets,1),v={type:s,col:"overall"},y=[],b=!0,S=!1,k=r;try{for(var A,w=f.buckets[Symbol.iterator]();!(b=(A=w.next()).done);b=!0){var _=A.value,N=f.allotment[_.subBucket],C=[],P=!0,M=!1,z=r;try{for(var B,D=N[Symbol.iterator]();!(P=(B=D.next()).done);P=!0){var j=B.value,x={col:j,type:t.subaggMethod||1,weighting:t.subBuckets[j].points};if(i==j)return x;C.push(x)}}catch(e){M=!0,z=e}finally{try{P||null==D.return||D.return()}finally{if(M)throw z}}var T={type:t.aggregationMethod||1,sub:C,col:_.subBucket,weighting:_.points};if(i==_.subBucket)return T;y.push(T)}}catch(e){S=!0,k=e}finally{try{b||null==w.return||w.return()}finally{if(S)throw k}}return v.sub=y,v},addWarning:function(e,t){this.warnings||(this.warnings={}),this.warnings[t]||(this.warnings[t]=[]),this.warnings[t].push(e)},activeAssessmentTypes:function(t,s){var i=new Set;if("all"===t){var n=!0,a=!1,o=r;try{for(var l,u=this.assessmentList[Symbol.iterator]();!(n=(l=u.next()).done);n=!0){var c=l.value,d=s?e.lookup("assessmentTypes",c.type).str():c.type;d&&i.add(d)}}catch(e){a=!0,o=e}finally{try{n||null==u.return||u.return()}finally{if(a)throw o}}}else if(!t||!t.length){t=Object.keys(this.reporting);var h=!0,g=!1,m=r;try{for(var p,f=t[Symbol.iterator]();!(h=(p=f.next()).done);h=!0){var v=p.value,y=this.reporting[v],b=!0,S=!1,k=r;try{for(var A,w=y.assessments[Symbol.iterator]();!(b=(A=w.next()).done);b=!0){var _=A.value,N=s?e.lookup("assessmentTypes",_.type).str():_.type;N&&i.add(N)}}catch(e){S=!0,k=e}finally{try{b||null==w.return||w.return()}finally{if(S)throw k}}}}catch(e){g=!0,m=e}finally{try{h||null==f.return||f.return()}finally{if(g)throw m}}}return i},syntheticAssessment:function(e){if(this.syntheticAssessments[e.nid])return this.syntheticAssessments[e.nid];this.syntheticAssessmentCalls=(this.syntheticAssessmentCalls||0)+1;var t,s,i,n,a=e.standards;if(a&&a.length){var o=1;t={},s={},Array.isArray(a)||(a=a.split(",")),n=0;var l=!0,u=!1,c=r;try{for(var d,h=a[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var g=d.value,m=this.getStandardsStrandLevel(g);t[g]=e.weighting?e.weighting/a.length:this.averageWeighting/a.length,s[g]=1,m>o&&(o=m),n+=t[g]}}catch(e){u=!0,c=e}finally{try{l||null==h.return||h.return()}finally{if(u)throw c}}e.scheme?i=e.scheme:(i="gs_standards_4LevelTrafficLights",this.registerFakeScheme({standards:e.standards,nid:e.nid,scheme:i,cols:e.weighting}),i=e.nid)}else s={0:1},t={0:e.weighting?e.weighting:this.averageWeighting},i="gs_traffic",n=e.weighting?e.weighting:this.averageWeighting;return e=_objectSpread({},e,{gs:this.gradeSchemes[i],scheme:i,colweights:t,columns:s,summative:"1",averageType:"1",weighting:n,synthetic:!0,adate:e.adate||e.date}),this.syntheticAssessments[e.nid]=e,e},unpackFilterPicker:function(e){var t={evidence:r,rnid:[],syntheticAssessment:function(e){if(this.syntheticAssessments[e.nid])return this.syntheticAssessments[e.nid];this.syntheticAssessmentCalls=(this.syntheticAssessmentCalls||0)+1;var t,s,i,n,a=e.standards;if(a&&a.length){var o=1;t={},s={},Array.isArray(a)||(a=a.split(",")),n=0;var l=!0,u=!1,c=r;try{for(var d,h=a[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var g=d.value,m=this.getStandardsStrandLevel(g);t[g]=e.weighting?e.weighting/a.length:this.averageWeighting/a.length,s[g]=1,m>o&&(o=m),n+=t[g]}}catch(e){u=!0,c=e}finally{try{l||null==h.return||h.return()}finally{if(u)throw c}}e.scheme?i=e.scheme:(i="gs_standards_4LevelTrafficLights",this.registerFakeScheme({standards:e.standards,nid:e.nid,scheme:i,cols:e.weighting}),i=e.nid)}else s={0:1},t={0:e.weighting?e.weighting:this.averageWeighting},i="gs_traffic",n=e.weighting?e.weighting:this.averageWeighting;return e=_objectSpread({},e,{gs:this.gradeSchemes[i],scheme:i,colweights:t,columns:s,summative:"1",averageType:"1",weighting:n,synthetic:!0,adate:e.adate||e.date}),this.syntheticAssessments[e.nid]=e,e},formative:[],unit:[],atype:[]};if(!e)return t;var s=e.split(","),i=!0,n=!1,a=r;try{for(var o,l=s[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var u=o.value;"evidence"==(u=u.split(":"))[0]?t.evidence==r?t.evidence=u[1]:t.evidence="all":"rnid"===u[0]?this.reporting[u[1]]&&t.rnid.push(u[1]):"unit"===u[0]?this.units[u[1]]&&t.unit.push(u[1]):"atype"===u[0]?this.activeAssessmentTypes("all").has(u[1])&&t.atype.push(u[1]):"formative"===u[0]&&t.formative.push(u[1])}}catch(e){n=!0,a=e}finally{try{i||null==l.return||l.return()}finally{if(n)throw a}}for(var c in 0===t.formative.length&&(t.formative=["0","1","2"]),t)t[c]!==r&&0!==t[c].length||delete t[c];return t},saveCustomFilter:function(t,s,r){var i={};i[r]=s,e.post({url:{nid:t.nid(),xds:"dataBookProps"},data:i})}};var d={TypeList:function(){var t=[],s=e.lookup("assessmentTypes");for(var r in s)"_reverse"===r||s[r].val()<0||t.push({value:s[r].val(),display:s[r].str(),"calendar-type":s[r].params&&s[r].params["calendar-type"],css:s[r].params&&s[r].params.css});return(t=e.sort({sortBy:"display"},t)).push({value:s[-4].val(),display:s[-4].str(),css:s[-4].params.css,addNew:!0,placeholder:s[-4].params.placeholder}),t},GradeSchemePicker:function(){var t=e.user.gradeSchemes,s=[];for(var r in t)t[r].disabled||"rubric"===r||"points"===t[r].mapping||"percent"===t[r].mapping||s.push({display:t[r].title,value:r,group:t[r].group});return s},mappingSchemePicker:function(t){var s=e.user.mapping,r={list:[{display:e.lang("Percent"),value:0}]},i=e.get("gradebook")[e.gbl.nid];if(s)for(var n in s){var a=s[n];r.list.push({display:a.title,value:a.name})}i.GBMapScheme&&(r.defaultValue=i.GBMapScheme),t.inherit("dd.select",r)},schemePicker:function(t){var s=[],r=e.user.gradeSchemes,i=e.get("gradebook")[e.gbl.nid];for(var n in r)if("gs_none"!==n){var a=r[n];if(!i.RestrictSchemes||i.RestrictSchemes&&("gs_strands"==a.id||"gs_strands"==a.group)){var o={title:a.title,"data-value":n,value:n,name:a.title,display:a.title,disabled:a.disabled,formativeOnly:a.formativeOnly};s.push(o)}}t.inherit("dd.select",{list:s})},StudentAverage:function(t){var s=t.state.get("ShowAverage"),i=s,n=t.arg("sigfigs")!==r?parseInt(t.arg("sigfigs")):1;if((t.has_role("Teacher")||t.has_role("Administrator")||t.has_role("SysAdmin"))&&!t.arg("forceObey")&&("4LevelTrafficLights"==s?t.arg("forceObey",!0):s=0),1==s)return!1;if(!t.get_children())if(0!=s&&s){if(t.arg("forceObey")||"4LevelTrafficLights"==i){var a=parseFloat(t.get_val());if(!1===a||a===r||isNaN(a))return!(!t.arg("defaultValue")&&""!==t.arg("defaultValue"))&&void(t.displayVal=t.arg("defaultValue"));if(a>100&&(t.data=100),0==s||!s)return void t.inherit("percent",{sigfigs:n});var o=!1;if(e.user.gradeMapping&&e.user.gradeMapping[s]&&e.user.gradeMapping[s].mapping?(s=e.user.gradeMapping[s].mapping,o=!0):s=e.lookup(s),!s)return void t.inherit("percent",{sigfigs:n});var l,u=parseFloat(t.get_val());if(!t.arg("forceObey")&&"4LevelTrafficLights"==i)return void e.get("gradebook").trafficLight(t,s[u].color,t.arg("trafficLightSize")||"20px");for(var c in s)if((l=o?s[c]:s[c].params)&&u>=l.min&&(l.max===r||u<l.max))return"4LevelTrafficLights"===t.state.get("ShowAverage")?void e.get("gradebook").trafficLight(t,l.color,t.arg("trafficLightSize")||"20px"):void(t.displayVal=c)}}else t.inherit("percent",{sigfigs:n})},PerspectiveData:function(e){var t=e.rnode||e.node,s=e.data;$.extend(t,s)},trafficLight:function(e,t,s,r){var i={"text-shadow":"0 0 1px black","-webkit-text-stroke-width":"1px","-webkit-text-stroke-color":"black","font-size":s,background:"none","font-weight":900};r?(e.addChild({id:"trafficlight",type:"fa.glyph",fa_class:"fa-solid",icon:"circle",_styles:[{styles:i},{condition:".dataBook-summary-summary-rows-trafficlight",styles:{color:t}}]}),e.addStyle({color:t}),e.displayVal=""):(e.inherit("fa.glyph",{icon:"circle",fa_class:"fa-solid"}),i.color=t,e.addStyle(i),e.displayVal="")},setup:function(e){if(!d[e.nid()]||e.get_setting("reload")||e.get_setting("GradebookName")||e.build.isPageReload&&!e.get_setting("redrawPath")){e.get_val();d[e.get_setting("GradebookName")||e.nid()]=new c(e.nid(),e.get_val(),e.xds,!1)}return!1},reportingPeriodMenu:function(t){var s=d[t.nid()];if(!s)return!1;if(2!==s.AverageType||!s.currentReportingPeriod)return!1;var r=[{value:-1,display:e.lang("All Reporting Periods")},{value:s.currentReportingPeriod.nid,display:e.lang("Current Reporting Period")}];for(var i in t.inherit("f_str",{choices:r,simple:!0,defaultValue:s.activeNid||s.currentReportingPeriod.nid}),d)d[i]instanceof c&&!d[i].activeNid&&d[i].setActiveAssessments(s.currentReportingPeriod.nid);d.activeNid=s.currentReportingPeriod.nid,t.on("xds-picker-picked",function(e){for(var t in d)d[t]instanceof c&&d[t].setActiveAssessments(e.get_arg("value"));e.trigger("Gradebook-newActiveAssessments",{value:e.get_arg("value")})})},currentAndPastReportingPeriodMenu:function(t){var s=d[t.nid()];if(!s)return!1;if(2!==s.AverageType||!s.currentReportingPeriod)return!1;var r=[{value:s.currentReportingPeriod.nid,display:e.lang("Current Reporting Period")}],i=[],n=new Date;for(var a in s.reporting){var o=s.reporting[a];o.end<n&&a!=s.currentReportingPeriod.nid&&i.push({value:a,display:o.name,edate:o.end})}for(var l in i=e.sort({sortBy:"edate",sortType:"date",sortDirection:"reverse"},i),(r=r.concat(i)).push({value:-1,display:e.lang("All Reporting Periods")}),t.inherit("f_str",{choices:r,simple:!0,defaultValue:s.activeNid||s.currentReportingPeriod.nid}),d)d[l]instanceof c&&!d[l].activeNid&&d[l].setActiveAssessments(s.currentReportingPeriod.nid);d.activeNid=s.currentReportingPeriod.nid,t.on("xds-picker-picked",function(e){for(var t in d)d[t]instanceof c&&d[t].setActiveAssessments(e.get_arg("value"));e.trigger("Gradebook-newActiveAssessments",{value:e.get_arg("value")})})},gradebook:c,standardsLevelMap:a,standardsSchemes:n};return t.gradebook=d,d});

/* resources: GradebookGradeSchemePicker */

"use strict";cf.resource("GradebookGradeSchemePicker",function(e,a,r,t){return{setup:function(a){var r=e.get("gradebook"),t=r.gradebook;t=new t(a.nid(),a.get_val(),a.xds,!1),r.schemeGB=t;var i=[];for(var s in t.gradeSchemes)if("gs_none"!==s){var d=t.gradeSchemes[s];i.push({title:d.title,"data-value":s,value:s,name:d.title,display:d.title,disabled:d.disabled})}return a.siblings.item=i,!1}}});

/* resources: GradebookWeighting */

"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}cf.resource("GradebookWeighting",function(e,t,i,r){var s,n={defaultOpen:{},moved:{},percentFields:{},percentages:{},virtualSubBuckets:{},vsbAllotment:{},vsbStandardLevelKeyMap:{},edited:!1,parsePoints:function(e,t){var i=e.val(),r=parseFloat(i)||0;return t&&(r/=t),r<0&&(r=0,e.val(r)),r},setup:function(t){t.get_setting("redrawPath")?n.edited=!0:s=new(e.get("gradebook").gradebook)(t.nid(),t.get_val(),t.xds,!1)},rebuildPercents:function(e){n.edited=!0;var t=s.buckets[n.ActiveReportingPeriod];s.calculatePercentages(s.bucketed[n.ActiveReportingPeriod],t);var i=n.percentFields;for(var r in i)i[r].update(s.percentages[r]);e.get_xdo("*everything-points").update(t[-1].points.toFixed(2));var a=e.get_xdo("*total"),o=e.get_xdo("*save"),d=e.get_xdo("*form");t.totalBucketPoints=t.totalBucketPoints.toFixed(2),a.state.set("total",t.totalBucketPoints+"%"),t.totalBucketPoints>100?(o.attr("disabled","disabled"),a.addClass("GradebookWeighting-invalidTotal"),d.state.set("form-valid",!1)):(o.attr("disabled",null),a.removeClass("GradebookWeighting-invalidTotal"),d.state.set("form-valid",!0)),o.update(),a.update(),e.get_xdo("*noWeightAssessments")},form:function(t){if(s&&s.busted)return!1;if(t.addClass("xds-form"),t.on("xds-form-close",function(t){var i=t.get_arg("func");n.edited?e.confirm({confirmButton:"Close",message:t.arg("titleDirty"),confirm:function(){n.edited=!1,i()}}):(n.edited=!1,i())}),2==s.AverageType){var i=!1;for(var a in s.reporting){i=!0;break}if(!i)return t.xds.title=t.arg("titleNoReporting"),t.inherit("noContent"),t.sparse=!0,t.addStyle({padding:"10px",margin:"10px"}),void t.exit()}s.bucketed=s.bucketAll();var o=s.bucketed[n.ActiveReportingPeriod],d=s.buckets[n.ActiveReportingPeriod],c=[];s.calculatePercentages(s.bucketed[n.ActiveReportingPeriod],s.buckets[n.ActiveReportingPeriod]);var u,l,g,v,p,f,b,h,k=d.totalBucketPoints;for(var m in o)if(u=[],m>=0){for(l=d[m].selectors.length,g=[],v=0;v<l;){if(b=d[m].selectors[v],(f=s.selectors[b])&&f.fields)for(p in f.fields){var P={subBucket:p,title:f.fields[p].title,points:d[m].subBuckets[p].points||"0",numa:d[m].subBuckets[p].numa,count:d[m].subBuckets[p].numa};if(d[m].unitBucket){var y={};o[m].map(function(e){y[e.nid]=1}),y=s.filterAMapByUnit(d[m].subBuckets[p].id,y);var B=[];o[m].map(function(e){y[e.nid]&&B.push(e)}),P.unitBucket=!0,P.bucket=m,P.loader={assessments:B}}g.push(P)}u.push({value:b,display:f&&f.title||b}),v++}if(u._r=!1,h={bucket:m,points:d[m].points||"0",count:o[m].length,titlebox:{title:u},aggmethod:d[m].aggregationMethod,subaggmethod:d[m].subaggMethod},"19"==b&&(1==n.getActualBucketLen(d)?h.standardsSchemeLevel=d[m].standardsSchemeLevel:d[m].standardsSchemeLevel=r),d[m].unitBucket||(h.loader={assessments:o[m]}),g.length)if(n.virtualBucketsActive(b,h.standardsSchemeLevel)){var A=s.virtualStandardsSchemeBucket(g,h.standardsSchemeLevel),_=A.buckets,S=A.allotment;n.vsbAllotment[m]=S,n.vsbStandardLevelKeyMap[m]=A.keyMap,n.virtualSubBuckets[m]={};var w=!0,R=!1,x=r;try{for(var L,W=_[Symbol.iterator]();!(w=(L=W.next()).done);w=!0){var M=L.value;n.virtualSubBuckets[m][M.subBucket]=M;var O=!0,C=!1,T=r;try{for(var G,N=S[M.subBucket].values()[Symbol.iterator]();!(O=(G=N.next()).done);O=!0){var j=G.value;d[m].subBuckets[j].points=M.points/S[M.subBucket].size}}catch(e){C=!0,T=e}finally{try{O||null==N.return||N.return()}finally{if(C)throw T}}}}catch(e){R=!0,x=e}finally{try{w||null==W.return||W.return()}finally{if(R)throw x}}h.subBuckets=_}else h.subBuckets=g;c.push(h)}var F=d[-1].points;F=Math.round(1e3*F)/1e3,(isNaN(F)||0==F)&&(F="-"),k=+k.toFixed(2),t.data={totalBucketPoints:k,valid:!(k>100),totalPercent:k+"%",buckets:c,everything:{count:o[-1].length,points:F,loader:{assessments:o[-1]}}},t.state.set("form-valid",t.data.valid),t.state.set("total",k+"%"),o[-2].length&&(t.data.unknown={assessments:o[-2].map(function(e){return delete e.readonly,e})}),t.node[t.xds.id]=t.data,t.hasData=!0},moveDropDown:function(e){var t,i,r,a,o=s.selectors,d=[],c=s.buckets[n.ActiveReportingPeriod],u=(e.xdo||e.obj).get_val("_bucket");for(var l in c)if(l!==u&&(i=-1,l>=0)){for(a=[],r=(t=c[l].selectors||["-1"]).length;++i<r;)a.push(o[t[i]].title);var g=(e.xdo||e.obj).get_val("scheme"),v=(e.xdo||e.obj).get_val("gs-group");if(!isNaN(g)){var p=s.gradeSchemes[g];g=(p=s.getRealScheme(p))&&p.name?p.name:g}if(o[t[0]].scheme&&o[t[0]].scheme!==g&&o[t[0]].scheme!==v)continue;d.push({display:a.length>1?a.join(", "):a[0],value:l})}return"-1"!==u&&d.push({value:"-1",display:o[-1].title}),d},handleBucketWeightWarnings:function(e){var t,i,a="children:warningAssessments",o="children:warningWeight",d="children:warningSchemeDisabled",c="children:warningSchemeCols",u="children:warningSelectorBustedStrand",l="children:warningSelectorBustedGLO",g=e.get_val("bucket")||-1,v=s.buckets[n.ActiveReportingPeriod][g],p=(s.bucketed[n.ActiveReportingPeriod][g],e.get_val("subBucket")),f=e.get_val("count"),b=e.state.get("standardsSchemeLevel"),h=v.selectors&&v.selectors.length?s.selectors[v.selectors[0]]:r;t=!p||b&&1==b?p&&b&&1==b?n.virtualSubBuckets[g][p].points:v.points:v.subBuckets[p].points,h&&"17"==h.value&&!h.scheme?(e.get_target(u,1).show(),e.get_target(l,1).hide()):h&&"19"==h.value&&!h.scheme?(e.get_target(u,1).hide(),e.get_target(l,1).show()):(h&&h.scheme&&(i=s.gradeSchemes[h.scheme]),e.get_target(u,1).hide(),e.get_target(l,1).hide()),t||!f||!p&&v.subBuckets?e.get_target(a,1).hide():e.get_target(a,1).show(),!t||f||-1===g||!p&&v.subBuckets?e.get_target(o,1).hide():e.get_target(o,1).show(),i&&i.disabled?e.get_target(d,1).show():e.get_target(d,1).hide(),!i||i.cols&&"object"===_typeof(i.cols)&&Object.keys(i.cols).length||20==h["data-value"]&&h.fields?e.get_target(c,1).hide():e.get_target(c,1).show()},noWeightAssessment:function(e){0==e.get_val("points")&&0!=e.state.get("summative")||e.addStyle("display","none")},noWeightAssessmentBucket:function(e){for(var t=e.get_val("bucket")||-1,i=s.bucketed[n.ActiveReportingPeriod][t],r=i.length;r--;)if(!i[r].weighting&&0!=i[r].summative)return;e.addStyle("display","none")},bucket:function(e){e.tag("div",!1);var t=e.get_val("bucket")||-1,a=s.bucketed[n.ActiveReportingPeriod][t],o=a.length,d=s.buckets[n.ActiveReportingPeriod],c=d[t],u=e.get_val("subBucket");if(!u&&"subBuckets"===e.xds.id)return!1;c.selectors&&c.selectors.includes("19")&&(1==n.getActualBucketLen(d)?e.state.set("standardsBucketSelected",!0):(e.data.standardsSchemeLevel=r,e.data.subaggregation=r,e.state.set("standardsSchemeLevel",r),e.state.set("subaggregation",r)));for(var l=0,g=0;g<o;g++)if(0!=a[g].summative){if(u){var v=e.state.get("standardsSchemeLevel"),p={};if(v){var f=s.convertStandardsToStrands(Object.keys(a[g].columns).join(","),v);for(var b in f){p[f[b].key]=b}}else p=a[g].columns;if(c.unitBucket){if(c.subBuckets[u].id!=a[g].thread)continue}else if(!(p[u]||s.strandsCodeMap&&s.strandsCodeMap[u]&&p[s.strandsCodeMap[u]]))continue}l++}e.data||(e.data={}),e.data.count=l,e.ready(n.handleBucketWeightWarnings).on(i,"GradebookWeighting-warnings",n.handleBucketWeightWarnings)},bucketDropDown:function(e){var t,i,r=s.selectors,a=[],o=s.buckets[n.ActiveReportingPeriod];for(var d in r)if(-3!=d&&-1!=d&&-4!=d&&-5!=d&&!r[d].isUnit){for(t in i=!1,o)if(-1!==$.inArray(d,o[t].selectors)||-1!==$.inArray(parseInt(d),o[t].selectors)||r[d].scheme){i=!0;break}i||a.push({display:r[d].title,value:d})}var c=o[(e.obj||e.xdo).get_val("bucket")],u=c.selectors[0];return(r[u]&&r[u].scheme||c.unitBucket)&&(e.noAdd=!0),a},dropDown:function(t){var i,a,o,d=s.selectors,c=[],u=[],l=[],g=[],v=[],p=[],f=s.buckets[n.ActiveReportingPeriod],b=e.get("gradebook").standardsSchemes;for(var h in d){if(d[h].scheme&&(h>=100||isNaN(h))){var k=s.gradeSchemes[d[h].scheme];if(k.disabled)continue;if(!k.cols||"[]"===k.cols)continue}for(a in o=!1,f)if(-1!==$.inArray(h,f[a].selectors)||-1!==$.inArray(parseInt(h),f[a].selectors)||"-1"===h){o=!0;break}if(!o){if(-3==h||-1==h||-4==h||d[h].isUnit)continue;var m=void 0;if(d[h].assessmentType!==r)m=c;else if(-5==h)m=g;else if(d[h].scheme!==r){var P=s.gradeSchemes[d[h].scheme];m=P&&b.includes(P.group)||b.includes(d[h].scheme)?l:P&&"gs_strands"==P.group||"gs_strands"==d[h].scheme?p:u}m&&m.push({display:d[h].title,value:h,css:d[h].css})}}i=[c,g,p,l,u];var y=["Assessment Type","Unit","Strands","Outcome Scheme","Scheme"];for(var B in i){var A=i[B];A.length&&(A=A.sort(function(e,t){return e.display>t.display?1:-1})).unshift({display:y[B],section:!0})}v=v.concat(c,g,p,l,u),t.inherit("dd.select",{list:v})},reportingPeriodSelector:function(e){var t=!0;if(2!=s.AverageType&&(n.ActiveReportingPeriod=s.nid,t=!1,e.exit(!0)),n.ActiveReportingPeriod&&!s.reporting[n.ActiveReportingPeriod]&&n.ActiveReportingPeriod!=s.nid&&delete n.ActiveReportingPeriod,n.ActiveReportingPeriod||(n.ActiveReportingPeriod=s.currentReportingPeriod&&s.currentReportingPeriod.nid),!n.ActiveReportingPeriod)for(var i in s.reporting){n.ActiveReportingPeriod=s.reporting[i].nid;break}n.ActiveReportingPeriod&&(s.reporting[n.ActiveReportingPeriod]||n.ActiveReportingPeriod==s.nid)||(n.ActiveReportingPeriod=s.nid,t=!1,e.exit(!0)),e.state.set("showRPS",t),e.global("defaultReportingPeriod",n.ActiveReportingPeriod),e.inherit("boxModel")},reportingPeriodMenu:function(){var e=[],t=s.reporting;for(var i in t)e.push({display:t[i].name,value:t[i].nid});return e},setReportingPeriod:function(t,i,r){n.ActiveReportingPeriod=r.value,t.args.redrawPath=t.build.xdsid,e.get_func("redraw")(t,i)},setAssessmentPoints:function(e,t){var i=e.get_val("subBucket")||0,r=e.nid(),a=n.parsePoints(t.find("input"));e.get_val("unitBucket")&&(i=0);var o=s.assessments[r];for(var i in o.colweights[i]=a,o.points=0,o.weighting=0,o.colweights)o.weighting+=parseFloat(o.colweights[i])||0;n.moved[r]||(n.moved[r]={}),n.moved[r].weighting=o.colweights,e.args.redrawPath=e.build.xdsid,n.rebuildPercents(e),o.weighting?e.target("*noWeight").hide():e.target("*noWeight").show()},setSubBucketPoints:function(e,t,i){var a=e.get_val("bucket"),o=s.buckets[n.ActiveReportingPeriod][a];o.subBuckets||(o.subBuckets={});var d=e.get_val("subBucket");if(n.virtualBucketsActive(o.selectors[0],e.state.get("standardsSchemeLevel"))){var c=n.vsbAllotment[a][d],u=!0,l=!1,g=r;try{for(var v,p=c.values()[Symbol.iterator]();!(u=(v=p.next()).done);u=!0){var f=v.value;o.subBuckets[f]={points:n.parsePoints(t.find("input"),c.size)}}}catch(e){l=!0,g=e}finally{try{u||null==p.return||p.return()}finally{if(l)throw g}}}else o.subBuckets[d]={points:n.parsePoints(t.find("input"))};e.args.redrawPath=e.build.xdsid,n.rebuildPercents(e),t.trigger("GradebookWeighting-warnings")},setBucketPoints:function(e,t,i){var r=e.get_val("bucket");s.buckets[n.ActiveReportingPeriod][r].points=n.parsePoints(t.find("input")),e.args.redrawPath=e.build.xdsid,n.rebuildPercents(e),t.trigger("GradebookWeighting-warnings")},modifyBucketSelectors:function(t,i,r){var a=t.get_val("bucket"),o=s.buckets[n.ActiveReportingPeriod][a];r.value?(o.selectors=r.value.split(","),t.args.redrawPath=t.build.xdsid):delete s.buckets[n.ActiveReportingPeriod][a],t.args.redrawPath=t.build.xdsid,e.get_func("redraw")(t,i)},moveAssessment:function(t,i,r){n.moved[t.nid()]||(n.moved[t.nid()]={}),n.moved[t.nid()].bucket=t.rnode.bucket=r.value,t.args.redrawPath=t.build.xdsid,e.get_func("redraw")(t,i)},setAggregationMethod:function(e,t,i){var r=e.state.get("bucket"),a=s.buckets[n.ActiveReportingPeriod][r];e.get_arg("subaggregation")?a.subaggMethod=e.state.get("subaggmethod"):a.aggregationMethod=e.state.get("aggmethod")},setStandardsSchemeLevel:function(e){var t=e.state.get("bucket"),i=e.val();e.state.set("standardsSchemeLevel",i),s.buckets[n.ActiveReportingPeriod][t].standardsSchemeLevel=i,e.args.redrawPath=e.build.xdsid,e.get_xdo("*form").update(),n.rebuildPercents(e)},addBucket:function(t,i,r){if("-3"==r.value)return t.picker.clear_val(),t.picker.dom.display.attr("readonly",!1),t.picker.dom.display.attr("placeholder",t.args.message),void t.picker.dom.display[0].focus();if(""!==r.value){if(!s.selectors[r.value]){var a=-1*++n.selectorLen-3;n.selectors[a]=n.customSelectors[a]={title:r.value},r.value=a}var o;o=s.buckets[n.ActiveReportingPeriod][s.buckets[n.ActiveReportingPeriod].bucketLen++]={selectors:[r.value]},-5==r.value&&(o.unitBucket=!0),t.args.redrawPath=t.build.xdsid,e.get_func("redraw")(t,i)}},percent:function(e){e.get_val("subBucket")?n.percentFields[e.nid()+"-"+e.get_val("subBucket")]=e:n.percentFields[e.nid()]=e},total:function(t){!t.state.get("form-valid")&&t.addClass("GradebookWeighting-invalidTotal"),!t.state.get("form-valid")&&t.preclosetag(e.html.span(t.arg("message"),"GradebookWeighting-invalidMessage")),t.displayVal='<span class="GradebookWeighting-overallTotal">'+t.state.get("total")+"</span>"},saveButton:function(e){e.inherit("f_submit",{disabled:!e.state.get("form-valid")})},save:function(t,i){var a,o,d=$.extend({},s.buckets,!0);for(var c in d){var u=d[c];for(a in u)if(((a=u[a]).selectors&&!a.selectors.includes("19")||1!==n.getActualBucketLen(u))&&(delete a.standardsSchemeLevel,delete a.subagMethod),delete a.assessmentPoints,delete a.percent,delete a.bucketLen,a.subBuckets)for(o in a.subBuckets)delete a.subBuckets[o].title,delete a.subBuckets[o].percent,delete a.subBuckets[o].assessmentPoints,delete a.subBuckets[o].numa}for(var l in n.moved)n.moved[l].weighting!==r&&(n.moved[l].weighting=JSON.stringify(n.moved[l].weighting));s.isCourseModel&&(d=d[s.nid]);var g={buckets:JSON.stringify(d),weighting:JSON.stringify(n.moved),custom:JSON.stringify(s.customSelectors)};n.moved={};t.get_arg("reloadThis");delete e.get("gradebook")[t.nid()],e.post({xdo:t,data:g,callback:function(){t.newEvent("loadPage",{xds:"classSetupPage",ClassSetup_active:"weighting"})}})},arrowToggle:function(e){var t=e.get_val("bucket")||"-1";e.on("click",function(e,i){setTimeout(function(){i.hasClass("xds-arrowToggle-open")?(n.defaultOpen[t]=!0,i.parent().addClass("GradebookWeighting-bucketOpen")):(n.defaultOpen[t]=!1,i.parent().removeClass("GradebookWeighting-bucketOpen"))},1)}),e.inherit("arrowToggle",{defaultOpen:n.defaultOpen[t]})},focusPoints:function(e,t){t.find("input").select()},setFocus:function(e,t){},type:function(t){t.displayVal=e.lookup("assessmentTypes",t.get_val("type")).str()},unitName:function(e){e.displayVal=s.unitName(s.units[e.get_val("thread")])},input:function(e){e.state.set("readonly",!1);var t=e.get_val();t||0===t||(e.data=e.get_val("weighting")),e.inherit("f_str")},copy:function(t){t.inherit("button"),t.on("click",function(t){e.localStorage("GradebookWeighting-copy",s.buckets[n.ActiveReportingPeriod])})},paste:function(t){var i=e.localStorage("GradebookWeighting-copy");i?(t.inherit("button"),t.on("click",function(t,r){s.buckets[n.ActiveReportingPeriod]=i,s.reporting[n.ActiveReportingPeriod]&&(s.reporting[n.ActiveReportingPeriod].buckets=i),t.args.redrawPath=t.build.xdsid,e.get_func("redraw")(t,r)})):t.exit(!0)},virtualBucketsActive:function(e,t){return"19"==e&&1==t},getActualBucketLen:function(e){var t=0;for(var i in e)i>=0&&(t+=1);return t},uniformallyDistribute:function(e,t){var i=s.buckets[n.ActiveReportingPeriod],r=s.bucketed[n.ActiveReportingPeriod],a=n.getActualBucketLen(i),o=0;for(var d in r[-1]&&r[-1].length>0&&(o=-1,a+=1),i)if(d>=o){var c=i[d];if(c.points=100/a,c.subBuckets){var u=c.subBuckets,l=Object.keys(c.subBuckets).length;for(var g in u)l>0&&(u[g].points=c.points/l)}}e.get_xdo("*form").update()},cancel:function(e){e.caller().caller().event("tabbedform.close_tab")}};return n});

/* resources: dataBook */

"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}cf.resource("bookGrades",function(e,t,a,s){e.fn,e.html;var o,r,n,d,i={cell:"dataBook-cell",col:"dataBook-col",activeCol:"dataBook-col-active",colWidths:"dataBook-col-",currentStudent:"dataBook-currentStudent",footerAverage:"dataBook-footerAverage",cellFocussed:"dataBook-cell-focussed",formative:"dataBook-formative",buttonValue:"dataBook-inspector-value",buttonEnter:"dataBook-inspector-enter",grade:"dataBook-grade",footer:"dataBook-footer",average:"dataBook-average",active:"dataBook-active",focus:"dataBook-focus",dropped:"dataBook-dropped",failing:"dataBook-failing",buttonSelected:"dataBook-button-selected",cmds:"dataBook-inspector-commands",inspectorSelected:"dataBook-inspector-selected",esubmit:"dataBook-esubmit",discussion:"dataBook-discussion",discussionUnread:"dataBook-discussion-unread",discussionExists:"dataBook-discussion-exists",status:"dataBook-status",statusInvalid:"dataBook-status-invalid",invalidFocussed:"dataBook-cell-invalidFocussed",statusPublished:"dataBook-status-published",statusOutgoing:"dataBook-status-outgoing",comment:"dataBook-comment",commentTrue:"dataBook-comment-true",commentFull:"dataBook-comment-full",received:"dataBook-received",assessment:"dataBook-assessment",unitName:"dataBook-headerUnit-name",term:"dataBook-term",dropGrade:"dataBook-drop-grade",cellDisabled:"dataBook-disabled"},l={unload:function(a){a.eventSource()[0]===a.dom()[0]&&e.links.getxds()!==a.build.xdsid&&(e.extend(l,{averages:{units:{},terms:{},assessments:{}},comments:{},cmap:{},smap:{},students:{},studentsOrder:[],assessments:{},chartCounter:0,grades:{},matrix:{},headerMatrix:{},initialized:!1,loaded:0,hoverInspectorParams:{},sheetMode:!1,sortSettingLoaded:!1}),t.onresize=s,t.onscroll=s,delete e.get("gradebook")[a.nid()])},noSheetModeInspector:{3:1,4:1,6:1,101:1},maxColsPerPage:10,matrix:{},headerMatrix:{},mobile:$("body").hasClass("mobile"),loaded:0,gradebookData:function(t){e.get("gradebook")[t.nid()]&&t.state.get("sortReload")&&(t.build.isPageReload=!1,t.set_setting("reload",!1)),t.inherit("gradebook.setup"),o=e.get("gradebook")[t.nid()],l.gradeSchemes=o.gradeSchemes},sync:function(t,a){if(o.hasOutOfSync&&!o.busted){var s={averages:JSON.stringify(o.outOfSync),AverageName:o.averageName()};t.args.data=s,e.get_func("post")(t,a)}},init:function(t,a){delete l.rubricGrading,delete l.current,l.prevScheme=!1,l.prevFeed=!1,l.cellFocussed=!1,l.commentBody=t.get_xdo("*inspectorCommentBody"),l.input=t.gebi("dataBook-input"),l.commentInput=t.gebi("dataBook-commentInput"),l.dragHandle=t.gebi("dataBook-dragHandle"),l.inspectorToggle=t.gebi("dataBook-inspectorToggle"),l.feedToggle=t.gebi("dataBook-feedToggle"),l.inspector=t.gebi("dataBook-inspector"),l.hoverInspector=t.gebi("dataBook-hoverInspector"),l.hoverInspectorForm=t.gebi("dataBook-hoverInspector-message"),l.activityFeed=t.find(".dataBook-activityFeed-loader"),l.rubricGrade=t.gebi("dataBook-rubrics"),l.activityFeedToggle=t.gebi("dataBook-feedToggle-unread"),l.activityFeedUnread=t.gebi("dataBook-feedToggle-unread"),l.inspectorValues=t.gebi("dataBook-inspector-values"),l.inspectorCharts=t.gebi("dataBook-inspector-charts"),l.inspectorButtons=t.gebi("dataBook-footerBar-values-buttons"),l.inspectorHeader=t.gebi("dataBook-inspector-header"),l.inspectorHeaderName=t.gebi("dataBook-inspector-header-name"),l.inspectorDrop=t.gebi("dataBook-inspector-values-drop"),l.inspectorNoCell=t.gebi("dataBook-inspector-nocell"),l.inspectorClear=t.gebi("dataBook-footerBar-values-clear"),l.warning=t.gebi("dataBook-warning"),l.statusCodesObj=t.get_xdo("*statusCodes"),l.studentFooter=t.gebi("dataBook-students-footer"),l.hoverInspectorFeedFormLoaded=!1,l.hoverInspectorParams={},l.dataBook=t.gebi("dataBook"),l.body=t.gebi("dataBook-body"),l.viewerOffset=l.dataBook.offset(),l.studentList=t.gebi("dataBook-students"),l.header=t.gebi("dataBook-header"),l.summaryColumn=t.find(".dataBook-summary"),l.summaryColumn.length||(l.summaryColumn=$("<div>"));(t.get_xdo("*right-view")||{}).dd&&t.get_xdo("*right-view").dd.setValueByValue(l.view);if(l.feedVisible||(l.activityFeedToggle.addClass("dataBook-feedToggle-hidden"),l.dataBook.addClass("dataBook-feedHidden"),l.activityFeed.css("display","none")),l.hasWarning&&l.warning.show(),l.activityFeed.length||(l.dataBook.addClass("dataBook-feedHidden"),l.feedToggle.hide(),l.feedVisible=!1),!l.xdsRubricGrade&&(l.xdsRubricGrade=t.arg("xdsRubricGrade")),!l.xdsGrader&&(l.xdsGrader=t.arg("xdsGrader")),!l.xdsSet&&(l.xdsSet=t.arg("xdsSet")),!l.xdsList&&(l.xdsList=t.arg("xdsList")),!l.xdsProps&&(l.xdsProps=t.arg("xdsProps")),!l.xdsSubmissions&&(l.xdsSubmissions=t.arg("xdsSubmissions")),!l.xdsClearTeacherUnreaed&&(l.xdsClearTeacherUnreaed=t.arg("xdsClearTeacherUnreaed")),!l.xdsESubmit&&(l.xdsESubmit=t.arg("xdsESubmit")),!l.xdsOnlineTestGrade&&(l.xdsOnlineTestGrade=t.arg("xdsOnlineTestGrade")),!l.loaded){if(!l.initialized&&!l.mobile){var r=e.storage("dataBook-nid-version");r&&t.build.version<=r&&setTimeout(function(){a.trigger("reload")},1),e.storage("dataBook-nid-version",-1)}if(l.initialized=!0,t.get_setting("GraderHost")&&t.get_setting("anid")){var n={anid:t.get_setting("anid")};if(t.get_setting("esnid")&&(n.esnid=t.get_setting("esnid")),t.get_setting("snid"))n.snid=t.get_setting("snid");else{for(var d=o.assessments[t.get_setting("anid")],i=o.studentsOrder,c=i[0],u=1;d.individualAssessment&&!d.studentAssigned[c.nid];)c=i[u],u+=1;n.snid=c.nid}t.newEvent("bookGrades.events.openGraderHost",n),t.set_setting("GraderHost",s),t.set_setting("anid",s),t.set_setting("esnid",s),t.set_setting("snid",s)}}},valid:{upper:120,lower:0},rowHeight:32,headerOffset:80,offsetLeft:179,feedWidth:200,headerSize:0,headerBandSize:5,offsetTop:67,colWidth:85,w:86,colWidths:{7:"small",8:"small",9:"large",10:"small"},colWidthsMeasure:{small:57,large:400},css:i,showInspector:!1,feedVisible:"0"!==e.storage("dataBook-activityFeed",s,"localStorage"),noneScheme:"gs_none",gradeSchemes:{},gsButtons:{},gradeSchemeTitles:{0:e.lang("Uncategorized")},averages:{units:{},terms:{},assessments:{}},comments:{},cmap:{},smap:{},students:{},studentsOrder:[],assessments:{},chartCounter:0,grades:{},windowHeight:e.window.height(),onresize:function(){delete l.resizeHandled,delete l.windowHeight,delete l.windowWidth,l.scrollListen(!0),l.activityFeed.trigger("dataBook-resize"),l.rubricGrade.trigger("dataBook-resize")},scrollListen:(n=0,d=0,t.addEventListener&&t.addEventListener("touchmove",function(){l.scrollListen()}),function(s){if(!(o&&o.busted||l.print)&&l.studentList&&l.studentList[0]&&!l.studentList[0].dead){!l.documentHeight&&(l.documentHeight=e.document.height()),!l.windowWidth&&(l.windowWidth=e.window.width()),!l.windowHeight&&(l.windowHeight=e.window.height()),l.body.height()||l.body.css({"min-height":l.studentList.height()});var i=t.scrollY||a.documentElement.scrollTop,c=t.scrollX||a.documentElement.scrollLeft,u=!1,p=!1;if(i==n&&!0!==s||(u=!0),c==d&&!0!==s||(p=!0),u){l.studentList[0].style.cssText="position:absolute; margin-top:0; margin-left:".concat(c,"px");var g=l.windowWidth+c-l.offsetLeft-l.summaryColWidth;l.feedVisible&&(g-=l.feedWidth),l.summaryColumn[0].style.cssText="position:absolute; margin-top:0; right:auto; margin-left:"+g+"px; width:"+l.summaryColWidth+"px;",l.header[0].style.cssText="margin-left:"+-c+"px;"}p&&(l.studentList[0].style.cssText="margin-top:"+(l.offsetTop-i)+"px;",l.summaryColumn[0].style.cssText="margin-top:"+(l.offsetTop-i)+"px; width:"+l.summaryColWidth+"px;",l.header[0].style.cssText="position:absolute; margin-top:"+(-l.offsetTop+i)+"px;"),n=i,d=c,clearTimeout(r),r=setTimeout(function(){l.loaded&&($(".lightbox").length||(l.sheetMode||e.storage("dataBook-scroll-"+e.gbl.nid,{left:c,top:i}),l.resizeHandled||(l.documentHeight===l.windowHeight?l.dataBook.addClass("dataBook-noScroll"):l.dataBook.removeClass("dataBook-noScroll")),l.resizeHandled=!0))},500)}}),moveScroll:function(s,o,r){if(s.xdo){var n=l.footerBarHeight||s.xdo.target("*footerBar").outerHeight();l.footerBarHeight=n}else n=27;l.windowWidth||(l.windowWidth=e.window.width()),l.windowHeight||(l.windowHeight=e.window.height()),l.windowWidth||(l.windowWidth=e.window.width());var d=l.rowHeight,i=l.windowHeight,c=l.windowWidth,u=t.scrollY||a.documentElement.scrollTop,p=t.scrollX||a.documentElement.scrollLeft;if(o=o||s.offset()){r=r||s.outerWidth(),l.inspectorHeight||l.showInspector&&(l.inspectorHeight=l.inspector.height()+20);var g=l.showInspector?l.inspectorHeight:0;o.top>i+u-d-g-n?e.window.scrollTop(o.top-i+d+n+g):o.top<l.offsetTop+l.headerOffset+u&&e.window.scrollTop(u-d),l.feedVisible&&(c-=l.feedWidth),o.left<l.offsetLeft+p?e.window.scrollLeft(p-(l.offsetLeft+p-o.left)):o.left+2*r>c+p&&!s.parents(".dataBook-summary").length&&e.window.scrollLeft(p+(o.left+2*r-(c+p)))}},changeRubricStudent:function(e,t){if(l.graderHost){var a=o.assessments[l.graderHost.nid()];if(e.preventDefault(),e.stopPropagation(),a.individualAssessment&&!a.studentAssigned[e.nid()])return;var s=l.graderHost;s.state.set("studentpicker",e.nid()),s.event("GraderHost.events.changeStudent");var r=e.get_index();l.utils.studentNameListSetActiveClass(r)}if(l.rubricGrading){e.preventDefault(),e.stopPropagation();var n=l.rubricGrading,d=n.node.item;if(d.individualAssessment&&!d.studentAssigned[e.nid()])return;var i=l.utils.getCell({student:e.nid(),col:n.node.schemeCol,assessment:d.nid},e);delete l.rubricGrading,i.e=e.e,l.commentInput.appendTo(l.body),i.event("bookGrades.events.focusCell")}l.rubricGrading||l.graderHost||delete l.rubricGrade},utils:{maxCols:function(){var e=l.maxColsPerPage;return l._colBroken&&(e+=2),e},numCols:function(e){if(e){var t=e.numCols||1;return e.includeTotalColumn&&t++,t}},cancelSheetMode:function(){arguments.length>0&&arguments[0]!==s&&arguments[0];delete l.graderHost,delete l.sheetMode,e.storage("bookGrades-sheetMode-"+e.gbl.nid,-1)},addStatusPicker:function(){var t=l.current,a=l.statusCodesObj;a&&(a.dd._open?(a.dom().hide(),a.dd.close()):setTimeout(function(){a.dom().show(),a.dd.open(!0),e.hoverboxPosition(t.dom(),a.dom()),a.find(".xds-dd-listItem").first().focus()}))},assessmentPicker:function(){return o.assessmentList},saveFocussedCell:function(t){e.storage("bookGrades-focus-"+e.gbl.nid,t)},unitName:function(e){return o.unitName(e)},reload:function(t,a){if(t.get_arg("nid")){var s=(t.get_arg("nid")+"").split("/").pop();s&&s.length&&(l.utils.saveFocussedCell({assessment:s}),l.sheetMode&&(l.sheetMode=s))}var o=setTimeout(function(){$("body").append('<div class="dataBook-reload">'+e.html.loading()+"</div>")},300);t.newEvent("reload",{reload:!0,func:function(){clearTimeout(o),$(".dataBook-reload").fadeOut(function(){$(this).remove()})}})},sort:function(t,a,r){var n,d=t.get_arg("sortKey")||"GradebookSort",i={xds:t.build.xdsid,redrawPath:t.build.xdsid,nid:e.gbl.nid,url:t.build.hash,target:"#cfload",redraw:!0,ssort:t.get_setting("ssort"),sortParam:t.get_setting("sortParam"),func:function(){l.scrollListen(!0)},afilters:t.get_xdo("*includepicker")?t.get_xdo("*includepicker").val():t.state.get("afilters"),sfilters:t.get_xdo("*gradelevelpicker")?t.get_xdo("*gradelevelpicker").val():t.state.get("sfilters"),tab:t.get_setting("tab")};if(i.sortParam=t.get_arg("xdo")&&t.get_arg("xdo").xds.sortParam||t.get_setting("sortParam"),i.ssort="GradebookSort"===d&&t.get_arg("value")||t.get_setting("ssort"),i.showDropped=t.get_arg("showDropped")!==s?t.get_arg("showDropped"):i.sfilters&&i.sfilters.length&&i.sfilters.split(",").includes("showDropped"),!1===t.get_arg("showDropped")&&i.sfilters&&i.sfilters.length){var c=i.sfilters.split(","),u=c.indexOf("showDropped");u>=0&&c.splice(u,1),i.sfilters=c.join(",")}else!0===t.get_arg("showDropped")&&(i.sfilters=i.sfilters&&i.sfilters.length?i.sfilters+",showDropped":"showDropped");t.set_setting("showDropped",i.showDropped),i.csort=t.get_arg("csort"),i.csortcol=t.get_arg("csortcol"),i.csortReverse=t.get_arg("csortReverse"),"view"===d&&(l.view=t.state.get("view"));var p=t.state.get("GradebookTabs");try{p=JSON.parse(p)}catch(e){p=[]}var g=t.get_setting("tab")||0;p[g]?(p[g].afilters=i.afilters,p[g].sfilters=i.sfilters,p[g].sortParam=i.sortParam,p[g].ssort=i.ssort,p[g].view=t.state.get("view"),p[g].csort=i.csort,p[g].csortcol=i.csortcol,p[g].csortReverse=i.csortReverse):p[g]={afilters:i.afilters,sfilters:i.sfilters,label:"tab".concat(g+1),sortParam:i.sortParam,ssort:i.ssort,view:t.state.get("view"),csort:i.csort,csortcol:i.csortcol,csortReverse:csortReverse},n=p,n=JSON.stringify(n),t.state.top().set("GradebookTabs",n),t.state.top().set("sortReload",!0),o.saveCustomFilter(t,n,"GradebookTabs"),l.sortSettingLoaded=!1},getCell:function(e,t){var a=e.assessment,r=e.col,n=e.student;n&&o.students[n]||(n=l.studentsOrder[0].nid);var d=t.global("matrix");if(d){var i,c=d[a];if(c)if(c.Reporting||c.Unit||"summary"===a)i=c[n];else if(r===s)for(r in c){i=c[r][n];break}else i=c[r]&&c[r][n];return i}return!1},focusCell:function(e,t){var a=l.utils.getCell(e,t);a&&l.events.focusCell(a,a.dom())},currentGrade:function(){var e=l.current;if(e){var t=e.node.item;if(t){t=t.nid;var a=e.rnode.grades;if(a)return a[t]||{}}}},gradeGadgetStudentNid:function(){return l.current&&l.current.rnode.nid},findImpacted:function(e){var t=e.rnode.nid,a=(e.node.schemeCol,e.node.item),s=a.nid,o=e.global("matrix")||{},r={},n=e.id(1);if(r.cell=n,r.col=n.parent(),r.colAverage=r.col.find(c.footerAverage),a.includeTotalColumn?(r.total=o[s][-1][t].id(1),r.totalGrade=r.total.find(c.grade),r.totalAverage=r.total.parent().find(c.footerAverage),r.handedIn=r.total.children(c.received),r.comment=r.total.find(c.comment)):(r.handedIn=r.cell.children(c.received),r.comment=r.cell.find(c.comment)),r.grade=r.cell.find(c.grade),r.status=r.cell.find(c.status),r.overall=o.summary&&o.summary[t]&&o.summary[t].dom(),r.customSummary=[],o.customSummary&&o.customSummary[t])for(var d in o.customSummary[t])r.customSummary.push(o.customSummary[t][d]);if(r.overall||(r.overall=$("<div>")),r.overallGrade=r.overall.find(c.grade),r.overallAverage=r.overall.parent().find(c.footerAverage),"units"===l.view)r.reporting=[],a.thread&&o[a.thread]&&o[a.thread][t]&&r.reporting.push(o[a.thread][t]);else for(var i in r.reporting=[],a.rmap)o[i]&&o[i][t]&&r.reporting.push(o[i][t]);return r},normalizeStudent:function(e){var t,a,r=l.assessments,n=l.reporting,d=l.units,i=r.length;for(t=0;t<i;t++)a=r[t],e.normalized[a.nid]=o.normalizedAssessment(e,a.nid);var c=n.length;for(t=0;t<c;t++)a=n[t],e.reporting[a.nid]=o.aggregateAssessments("overall",e,a.nid,s,s,s,!1);for(var u in d)a=d[u],e.units[a.nid]=o.aggregateAssessments("overall",e,s,s,a.nid,s,!1);o.overallAverage(e)},normalizeGrades:function(){for(var e=l.studentsOrder,t=e.length,a=0;a<t;a++)e[a]&&l.utils.normalizeStudent(e[a])},buildAssessment:function(e,t){var a,s,o=(t=t||{}).studentsOrder||l.studentsOrder,r=o.length,n=[],d=e.gs.order,i=d&&d.length,c=0;e.renderColumns=0,e.fullColumns=0,e.smallColumns=0,e.largeColumns=0;var u,p=[];for((t.sheetMode||l.sheetMode)&&(n.push({type:8,item:e,schemeCol:"__8",rows:[]}),n.push({type:7,schemeCol:"__7",item:e,rows:[]}),e.renderColumns+=2,e.smallColumns+=2,c+=2),a=0;a<i;a++)u=d[a],(e.columns[u.name]&&0!=e.columns[u.name]||!1===e.columns||0===u.name)&&(n.push({type:1,item:e,schemeCol:u.name,rows:[]}),p.push(u.name),e.renderColumns++,e.fullColumns++);c+=p.length,0===p.length&&e.scheme===l.noneScheme&&(c+=1,e.renderColumns+=1,e.fullColumns++,n.push({type:5,item:e,rows:[]}));var g,m=!1;for(e.fullColumns>1&&(!t.sheetMode&&!l.sheetMode||!e.gs.nototal)&&(m=!0,n.push({item:e,schemeCol:-1,type:2,rows:[]}),e.fullColumns++,e.renderColumns++),e.includeTotalColumn=m,(t.sheetMode||l.sheetMode||l.graderHost)&&(n.push({type:9,item:e,schemeCol:"__9",rows:[]}),e.renderColumns++,e.largeColumns++,c++),a=0;a<r;a++){for(g=o[a],s=0;s<c;s++)n[s].rows.push(g);m&&n[n.length-1].rows.push(g)}return n},buildReporting:function(e){for(var t,a=l.studentsOrder,s=a.length,r=[{type:3,item:e,rows:[]}],n=r[0],d=0;d<s;d++)t=a[d],n.rows.push(t);return n.average=o.averageColumn(e),r},buildReportingHeader:function(){var e,t,a,o=[],r=l.cols,n=(t=l.reporting).length,d=r.length;for(i=0;i<n;i++)for((u=t[i])._number=i%6,a=!1,c=0;c<d;c++)if((e=r[c]).item)if(e.item.rmap)!a&&e.item.rmap[u.nid]&&(u._colStart=c,a=!0);else if(e.item.nid===u.nid){u._colEnd=c,u._colStart===s&&(u._colStart=c);break}var i,c,u,p,g,m,v,h=o.length;for(i=0;i<n;i++){for(h=o.length,p=!1,u=t[i],c=0;c<h;c++){if((m=o[c]).reporting[0]._colStart>u._colStart&&m.reporting[0]._colStart>u._colEnd){m.reporting.splice(0,0,u),p=!0;break}if(m.reporting[0]._colEnd<u._colStart){m.reporting.push(u),p=!0;break}}p||o.push({assessments:[],reporting:[u],amap:{},numcols:1})}for(n=o.length;n--;)for((m=o[n]).assessments.length,g=m.reporting.length,v=s,i=0;i<g;i++)(u=m.reporting[i])._leftCount=v?u._colStart-v._colEnd:u._colStart,v=u;return o},buildUnit:function(e){for(var t,a=l.studentsOrder,s=a.length,r=[{type:6,item:e,rows:[]}],n=r[0],d=0;d<s;d++)t=a[d],n.rows.push(t);return n.average=o.averageColumn(e),r},insertUnit:function(t,a,s){var r,n,d,i,c,u,p,g=e.nt.Document.Assignment(!0),m=(l.assessments.length,t.length);s=o.units;for(var v in s){for(n=l.utils.buildUnit(s[v]),d=!1,c=t.length-1;c>=0;c--)if((r=t[c]).item.nodesubtype===g&&r.item.thread==n[0].item.nid){for(t.splice(c+1,0,n[0]),p=a.length,u=0;u<p;u++)if(a[u].nid===r.item.nid){a.splice(u+1,0,n[0].item);break}d=!0;break}if(!d)for(n[0].item.empty=!0,i=0;i<m;i++){if((r=t[i]).item.unitNumber>n[0].item.unitNumber){for(t.splice(i,0,n[0]),p=a.length,u=0;u<p;u++)if(a[u].nid===r.item.nid){!0,a.splice(u,0,n[0].item);break}d=!0;break}}d||(t.push.apply(t,n),a.push(n[0].item))}},insertReporting:function(t,a,s){var o,r,n,d,i,c,u,p=e.nt.Document.Assignment(!0),g=s.length,m=l.assessments.length;for(d=0;d<g;d++){for(r=l.utils.buildReporting(s[d]),m=t.length,n=!1,i=0;i<m;i++)if((o=t[i]).item.nodesubtype===p&&(!o.item.date||o.item.compDate>s[d].end)){for(t.splice(i,0,r[0]),u=a.length,c=0;c<u;c++)if(a[c].nid===o.item.nid){a.splice(c,0,r[0].item);break}n=!0;break}n||(t.push.apply(t,r),a.push(r[0].item))}},reorderAssessments:function(e,t){var a,r,n,d,i,c,u,p,g,m,v,h=l.assessments,f=(e.length,e.length),b=h.length,k=t.length;for(i=0;i<b;i++)if((u=h[i]).rperiod||u.xrperiod){if(u.rperiod){for(a=!0,r=s,m=u.rperiod.length,v=0;v<m;v++)if(o.reporting[u.rperiod[v]]){r=u.rperiod[v];break}}else r=u.xrperiod[0],a=!1;for(d=0;d<f&&(n=e[d].item).nid!=r;d++);for(c=0;c<f;c++)if((n=e[c]).item.nid===u.nid&&!n._moved){p=e.splice(c,u.renderColumns),c<d&&!a?d=d-u.renderColumns+1:c<d&&a?d-=u.renderColumns:c>d&&!a&&d++,g=(g=[d,0]).concat(p),e.splice.apply(e,g);break}for(d=0;d<k&&(n=t[d]).nid!=r;d++);for(c=0;c<k;c++)if((n=t[c]).nid===u.nid&&!n._moved){n._moved=!0,t.splice(c,1),c<d&&a?d--:c>d&&!a&&d++,t.splice(d,0,n);break}}},buildSummaryColumn:function(t){var a=e.get("gradebook")[t.nid()],s=a.SummaryCols,o=[];return s.map(function(t,s){var r=e.lookup("GradebookSummaryColumns",t.type),n="";t.subCol?n=a.strandKey&&a.strandKey[t.subCol]||a.gloKey&&t.subCol in a.gloKey&&a.gloKey[t.subCol].display||t.subCol:r&&r.str&&(n+=r.str());var d=e.lookup("GradebookSummaryTypes",t.summary),i=e.lookup("GradebookSummaryTypesOutcomes",t.summary);d&&d.str&&d.str()?n+=" "+d.str():i&&i.str&&i.str()&&(n+=" "+i.params.display),o.push({type:101,index:s,summaryType:t.summary,columnType:t.type,rows:l.studentsOrder,title:n,average:a.averageColumn(),showas:t.showas})}),l.summaryColWidth=l.colWidth*o.length+1,o},sortReporting:function(){var t=o.reporting,a=[];for(var s in t)a.push(t[s]);return e.sort({sortBy:"start,end",sortType:"date,date"},a)},sortAssessments:function(t){t=t||o.assessments;var a,s=[];for(var r in t)(a=o.units[t[r].thread])&&(t[r].unitNumber=a.unitNumber),s.push(t[r]);return"units"!==l.view?e.sort({sortBy:"date,nid",sortType:"date,int"},s):e.sort({sortBy:"unitNumber,date,nid",sortType:"int,date,int"},s)},buildTable:function(t,a){l.sheetMode||(l.sheetMode=e.storage("bookGrades-sheetMode-"+e.gbl.nid));var r=l.sheetMode?[o.assessments[l.sheetMode]]:l.assessments;l.sheetMode&&r&&!r[0]&&(l.utils.cancelSheetMode(),r=l.assessments),a.global("matrix",{});var n,d=l.reporting,i=r.length,c=[],u=[];for(n=0;n<i;n++)r[n]._moved=!1,u.push(r[n]),c.push.apply(c,l.utils.buildAssessment(r[n]));l.sheetMode||o.GBNoAverages||("reporting"===l.view?(l.utils.insertReporting(c,u,d),l.utils.reorderAssessments(c,u)):l.utils.insertUnit(c,u));var p,g,m=a.node.body.book;m.body||(m.body={}),m.header||(m.header={});var v,h=[],f=0,b=c.length,k=e.nt.Document.Unit(!0),y=e.nt.Document.ReportingPeriod(!0),C=e.nt.Document.Assignment(!0);for(n=0;n<b;n++)if(v=c[n],(g=v.item).nodesubtype!==k||!0!==g.empty||h.filter(function(e){return e.item.nid==g.nid}).length||h.push({len:0,item:g}),g.nodesubtype===C)if(v.average=o.averageColumn(v.item,v.schemeCol),g.thread!==p||p===s&&v.thread===s){var x=l.units[g.thread];x&&(h.push({len:1,item:x}),p=g.thread),x&&x._number===s&&(x._number=f%6,f++)}else g.thread===p&&h[h.length-1].len++;else g.nodesubtype===y&&(p=g.nid,h.push({len:1,item:g}));l.cols=c,o.GBNoAverages||(m.summary={},m.topright={},m.topright.summary=m.summary.summary=l.utils.buildSummaryColumn(a)),m.body.cols=c,l.sheetMode||(m.header.stacks=l.utils.buildReportingHeader(),m.header.units=h),m.header.cols=c,m.header.assessments=u},flashAverage:function(e){var t=e&&e.dom();t.css({"-webkit-transition":"-webkit-transform 0.2s ease-in"}),t.css({"-webkit-transform":"scale(0.8,0.8)"}),setTimeout(function(){t.css({"-webkit-transform":"scale(1,1)"})},300)},bucketCharts:function(t,a){var s,r,n={};t?(r=t.nodesubtype==e.nt.Document.Unit(!0)?o.unitReportingPeriod(t):t.nid,s=t.assessments):2==o.AverageType&&o.currentReportingPeriod?(r=o.currentReportingPeriod.nid,s=o.currentReportingPeriod.assessments):(r=o.nid,s=o.assessmentList);for(var d=s&&s.length;d--;)n[s[d].nid]=1;var i,c,u,p,g,m=o.buckets[r]||o.buckets[o.nid],v=o.bucketed[r]||o.bucketed[o.nid],h={},f={},b=l.studentsOrder,k={};for(var y in d=b.length,m)if(e.is_obj(m[y])){var C=(p=m[y]).aggregationMethod;if(m[y].subBuckets)for(var x in k[y]={},u=p.selectors[0],u=e.lookup("assessmentTypes",u,!0).fields,h[y]={},f[y]={},m[y].subBuckets){var B=d;if(i=0,k[y][x]=u&&u[x].title||m[y].subBuckets[x].title,m[y].unitBucket){var w=o.filterAMapByUnit(m[y].subBuckets[x].id,n);c=o.bucketAggregationFunction(C,v[y],a,w)}else c=o.bucketAggregationFunction(C,v[y],a,n,x);for(h[y][x]=c.average,f[y][x]=0;B--;){if(m[y].unitBucket){var S=o.filterAMapByUnit(m[y].subBuckets[x].id,n);c=o.bucketAggregationFunction(C,v[y],a[lens2],S)}else c=o.bucketAggregationFunction(C,v[y],b[B],n,x);"number"!=typeof c.average||isNaN(c.average)||(f[y][x]+=c.average,i++)}f[y][x]=f[y][x]/i}else{i=0;var _=b.length;k[y]=[],f[y]=0,(u=p.selectors)||(u=["-1"]),g=u.length;for(var T=0;T<g;T++)M=e.lookup("assessmentTypes",u[T],!0),k[y].push(M&&M.title||u[T]);for(k[y]=k[y].join(", "),c=o.bucketAggregationFunction(C,v[y],a,n),h[y]=c.average;_--;)"number"!=typeof(c=o.bucketAggregationFunction(C,v[y],b[_],n)).average||isNaN(c.average)||(f[y]+=c.average,i++);f[y]=f[y]/i}}var G,H,I,A,M,F="",P=e.html,N=function(e,t,a){var s,r;return isNaN(a)&&(a="-"),G=P.progress(o.normalizePercent(a)||0,"","orange"),I=P.progress(o.normalizePercent(e)||0,"","blue"),o.GBMapScheme?(s=o.symbolicMap(o.GBMapScheme,100*a),r=o.symbolicMap(o.GBMapScheme,100*e)):(s=o.percent(a),r=o.percent(e)),H=P.p(s,"dataBook-bucket-class-result"),A=P.p(r,"dataBook-bucket-student-result"),t=P.p(t,"dataBook-bucket-title"),P.div(t+A+H+I+G,"dataBook-bucket-chart")};for(var D in h)if("object"===_typeof(h[D]))for(var O in h[D])F+=N(h[D][O],k[D][O],f[D][O]);else F+=N(h[D],k[D],f[D]);return F+=P.div(P.p("- Student Average","dataBook-bucket-student-result")+P.p("- Class Average","dataBook-bucket-class-result"),"dataBook-bucket-legend"),e.html.div(F,"dataBook-bucket")},getAndShowFeed:function(t,a){e.xdsbuild({nid:a,xds:l.xdsList,gradeLink:o.students[t].rid,thread:t,_t:Date.now(),target:l.hoverInspector.find(".xds-scroll-content"),func:function(){a==l.previousFeedNid&&t==l.previousFeedThread||l.hoverInspector.find(".xds-scroll-content").parent().xdo.element.reset(),o.students[t].grades[a]&&o.students[t].grades[a].t&&o.saveGrade({attr:"t",value:s,anid:a,snid:t,xds:l.xdsSet});var r=l.utils.getCell({assessment:a,student:t,col:"__8"},l.hoverInspector.xdo);r&&r.find(c.discussion).removeClass(i.discussionUnread);var n=e.get("dataBookFeed");n&&n.clearUnread(t,a),l.previousFeedNid=a,l.previousFeedThread=t}})},makeGSButtons:function(t){if(!e.is_arr(t)&&l.gsButtons[t])return l.gsButtons[t];var a="",o=function(t,a,s){var o=[i.buttonValue,s];return e.html.make("button",a||t,{"data-value":t},o)},r=e.is_arr(t)||"points"===t||"percent"===t?t:l.gradeSchemes[t].omap;if(e.is_arr(r))for(var n=r.length,d=0;d<n;d++)r[d].noButton||(a+=o(r[d].id,r[d].id));else{for(var c=1;c<=9;c++)a+=o(c);a+=o(".")+o("0")+o(s,e.lang("Done"),i.buttonEnter)}return e.is_arr(t)||(l.gsButtons[t]=a),a},assessmentDate:function(t){var a=e.dateFormat(t,"mmm"),s=e.dateFormat(t,"d");return e.html.p(a,"xds-bookGrades-publish-date-month")+e.html.p(s,"xds-bookGrades-publish-date-day")},hoverInspectorHeight:function(){return Math.max(l.windowHeight/2-105,215)},hoverInspectorFresh:function(e,t){return!!(!0!==e&&l.hoverInspectorVisible&&l.hoverInspectorParams&&l.hoverInspectorParams.context&&t.selector==l.hoverInspectorParams.context.selector)},hoverInspectorPosition:function(t){var a,s,o=l.hoverInspectorParams.context;o&&o.xdo&&"post"===o.xdo.xds.id?(e.hoverboxPosition(o,l.hoverInspector),t&&t.dom&&(a=(s=t.dom().find(".xds-scroll-content")).scrollTop()),l.hoverInspector.appendTo(o.parents(".dataBookFeed").parent().parent().parent()),t&&t.dom&&s&&a&&s.scrollTop(a),l.hoverInspector.find(".dataBook-hoverInspector-details").trigger("dataBook-showHoverInspector")):(l.hoverInspector.find(".dataBook-hoverInspector-details").hide(),e.hoverboxRelativePosition(o,l.hoverInspector))},hideHoverInspector:function(){delete l.hoverInspectorVisible,l.hoverInspector.hide()},showHoverInspector:function(e,t,a,r){if(t===s&&e===s&&a===s){if(!l.current)return;var n=l.current,d=n.data,i=n.node.item;if(!d||!i)return;t=i.nid,e=d.nid,a=n.dom()}var c={snid:e,anid:t,rid:o.students[e].rid,context:a};l.utils.hoverInspectorFresh(r,a)||(l.hoverInspectorParams=c,setTimeout(function(){l.hoverInspector.show(),l.hoverInspector.appendTo(a),l.hoverInspectorVisible=!0},1),l.utils.hoverInspectorPosition(),l.hoverInspectorFeedFormLoaded?l.events.hoverInspectorFormLoaded():(l.hoverInspectorForm.trigger("dataBook-showHoverInspector"),l.hoverInspectorFeedFormLoaded=!0),l.utils.getAndShowFeed(e,t),l.hoverInspectorVisible=!0)},showGradePicker:function(){var t=l.inspectorButtons,a=(p=l.current).rnode,s=p.node,r=s.item;a.student;var n,d,u,p=l.current,g=l.input;if(1!==p.node.type&&2!==p.node.type&&5!==p.node.type||r.readonly)l.inspectorClear.hide(),t.hide();else{"."+i.cmds,a.nid,n=r.nid,d=r.gs.mapping;l.comments[n];if(l.utils.currentGrade().c,1===s.type){var m;if(u=r.scheme,r.gs.cols&&r.gs.cols[s.schemeCol]&&r.gs.cols[s.schemeCol].mapping){var v=r.gs.cols[s.schemeCol].mapping;m="points"===v||"percent"===v?v:o.mappingSchemes[v].omap}(l.prevScheme!==u||m)&&(l.prevScheme=m||u,u=l.utils.makeGSButtons(m||u),t.html(u)),""==u||!(e.is_obj(d)||m&&e.is_arr(m))||m&&!e.is_arr(m)?(l.numericKeypad=!0,l.numericKeypadReset=!0,l.numericKeypadClicked=!1):(t.find(c.inspectorSelected).removeClass(i.inspectorSelected),l.numericKeypadReset=!0,l.numericKeypad=!1,t.find("[data-value='"+g.val()+"']").addClass(i.inspectorSelected)),t.show(),l.inspectorClear.css("display","inline-block")}else 5===p.node.type?t.hide():(l.inspectorClear.hide(),t.hide())}},showInspector:function(){if(!l.sheetMode){l.inspector,l.inspectorToggle,l.showInspector;var t,a=l.inspectorHeader,s=l.inspectorHeaderName,o=l.inspectorCharts,r=l.inspectorNoCell,n=l.current;l.viewer,l.viewerOffset,l.input;if(!n)return a.hide(),void r.show();r.hide();var d=n.rnode,i=n.node.item;t=d.student||{},1!==n.node.type&&2!==n.node.type&&5!==n.node.type&&o.html(l.utils.bucketCharts(i,d)),s.html((t.last||"")+", "+(t.first||"")+e.html.div("","xds-hbox xds-hoverbox")),a.show()}},cmap:function(e,t,a){var s=(t=t||l.current).rnode.nid,o=t.node.item.nid,r=l.commentBody.val(),n=a?l.smap:l.cmap;n[o]||(n[o]={}),n[o][s]||(n[o][s]={}),n[o][s].nid=e.nid,n[o][s].body=r},assessmentTypeList:(e.get("gradebook")||{}).TypeList,studentNameListSetActiveClass:function(e){l.currentStudent&&l.currentStudent.removeClass(i.currentStudent),l.currentStudent=l.studentList.children(":nth-child("+(e+1)+")"),l.currentStudent.addClass(i.currentStudent)},prepGrader:function(e,t){var a=e.get_xdo("*optionsToolbar"),s=t?99:"",o=t?"hidden":"",r=t?"144px":"";if(a){a.addStyle({"z-index":s});var n=a.get_xdo("*courseheader").get_xdo("*title-title");n&&n.addStyle({width:r})}$("body").css({"overflow-x":o})},toggleStudentList:function(e){var t,a=l.studentStatusList,o=e.caller().find(".dataBook-topleft-classReturn",!0),r=!0,n=!1,d=s;try{for(var c,u=a[Symbol.iterator]();!(r=(c=u.next()).done);r=!0){var p=c.value;(p=p.get_xdo("*student")).get_xdo("*body").hasClass(i.currentStudent)&&(t=p.get_index()),p.state.get("collapsed")?(p.state.set("collapsed",!1),e.state.set("collapsed",!1),o&&o.xdo&&o.xdo.removeClass("collapsed")):(p.state.set("collapsed",!0),e.state.set("collapsed",!0),o&&o.xdo&&o.xdo.addClass("collapsed"))}}catch(e){n=!0,d=e}finally{try{r||null==u.return||u.return()}finally{if(n)throw d}}var g=l.studentList&&l.studentList.xdo;g&&e.state.get("collapsed")?g.addClass("dataBook-students-collapsed"):g&&g.removeClass("dataBook-students-collapsed"),setTimeout(function(){l.rubricGrade.trigger("dataBook-resize"),l.utils.studentNameListSetActiveClass(t)},200)},cellActive:function(t,a){o||(o=e.get("gradebook")[e.gbl.nid]);var s=o.assessments[t];return!(s.individualAssessment&&!s.studentAssigned[a])}},types:{createAssessment:function(t){var a=e.get("gradebook").TypeList();delete a[a.length-1].addNew,t.inherit("dd.button",{list:a})},rubricGrade:function(t){t.sparse=!0;var a=l.sheetMode;t.on("xds-loaded dataBook-resize",function(t){var a=l.graderHost;if("dataBook-resize"!==t.e.type||t.find(e.$css.cont).length){var s=t.gebi("dataBook-students").width(),o=t.target("*warning").is(":visible")?t.target("*warning").outerHeight():0,r=t.target("*optionsToolbar").outerHeight()+o,n=t.target("*footerBar").outerHeight()+2,d=0;l.feedVisible&&!a&&(d=l.activityFeed.width());var i={width:e.window.width()-s-d+"px",left:s+"px",display:"block",height:e.window.height()-n-r+"px"};a&&(l.utils.prepGrader(t,!0),i["z-index"]=101,i.height=e.window.height()-n+"px"),t.addStyle(i),(!a&&parseInt(t.dom().css("top"))<=0||a&&parseInt(t.dom().css("top"))<0)&&(t.addStyle({top:"-"+e.window.height()+"px"}),t.dom().animate({top:a?0:r},500))}}),t.on("Rubric-close",function(o,r,n){l.graderHost?l.events.openGraderHost(o,s,{snid:n.snid,anid:n.anid}):(l.sheetMode=a,delete l.rubricGrading,t.get_xdo("*topleft")&&t.get_xdo("*topleft").update(),t.dom().animate({top:" -"+e.window.height()},500,function(){l.utils.prepGrader(o,!1),t.dom().empty()}),l.currentStudent.removeClass(i.currentStudent),l.sheetMode||t.target("*return").hide())})},returnToRegularMode:function(e){if(!l.sheetMode&&!l.rubricGrading||l.graderHost)return!1;e.on("click",l.events.returnToRegularMode)},sheetModePicker:function(t){if(!l.sheetMode)return!1;t.on("xds-picker-picked",function(t){e.storage("bookGrades-sheetMode-"+e.gbl.nid,t.get_arg("value")),l.sheetMode=t.get_arg("value"),t.dom().trigger("reload")}),t.inherit("dd.select",{list:l.utils.assessmentPicker()})},hoverInspectorDetails:function(e){if(l.hoverInspectorParams){var t=o.assessments[l.hoverInspectorParams.anid];t&&(e.data={nid:t.nid,rid:t.rid,name:t.name,unit:o.unitName(t.thread),type:t.type},e.map(),e.on("click",function(){l.utils.saveFocussedCell({assessment:l.hoverInspectorParams.anid,student:l.hoverInspectorParams.snid}),l.sheetMode=t.nid,e.dom().trigger("reload")}))}e.sparse=!0,e.on("dataBook-showHoverInspector",function(){e.get_xdo("*hoverInspector-details").update()})},studentName:function(t){var a,s,o,r,n=e.get("gradebook")[t.nid("node")],d=n.students[t.nid()].CourseID;n.CourseID!=d&&d&&(t.addSubClass("hasCourseID"),t.map({CourseID:d})),t.get_val()?(a=t.get_val().prefix,s=t.get_val().first,o=t.get_val().last):(a="",s=t.xds.fields.first.title,o=t.xds.fields.last.title),t.state.get("collapsed")&&(a="",s=s&&s.length?"".concat(s[0],"."):s,o=o&&o.length?"".concat(o[0],"."):o),r="first"===t.get_setting("sortParam")?"".concat(a?a+" ":"").concat(s," ").concat(o):t.state.get("collapsed")?"".concat(o," ").concat(s):"".concat(o,", ").concat(a?a+" ":"").concat(s),t.arg("title",r),t.wrapTitle=!0,t.inherit("miniprofile"),t.tag("a"),t.xds.href&&t.attr("href",t.arg("href"))},studentSubmitStatus:function(e){l.studentStatusList?l.studentStatusList.length<o.studentsOrder.length&&l.studentStatusList.push(e):l.studentStatusList=[e];var t,a,s=e.nid();if(!l.graderHost)return l.rubricGrading&&(t=l.rubricGrading.state.get("item").nid,(a=o.assessments[t]).individualAssessment&&!a.studentAssigned[s]&&e.parent_xdo().dom().addClass("disabled")),e.exit(0),void e.addClass("studentSubmitStatus-sparse");if(t=l.graderHost.nid(),(a=o.assessments[t]).individualAssessment&&!a.studentAssigned[s])return e.parent_xdo().dom().addClass("disabled"),void e.exit(0);var r=o.grades[s][t],n=r;o.students[s].normalized[t].average?e.state.set("submitStatus","complete"):n&&n.e?r.t?e.state.set("submitStatus","commentUnread"):r.la&&1==r.la?e.state.set("submitStatus","submitted"):r.la&&2==r.la?e.state.set("submitStatus","studentReplied"):r.la&&3==r.la?e.state.set("submitStatus","teacherReplied"):r.la&&4==r.la?e.state.set("submitStatus","ashared"):r.m?e.state.set("submitStatus","studentReplied"):e.state.set("submitStatus","submitted"):e.state.set("submitStatus",!1)},invalidGrade:function(t){var a=l.current;t.inherit("hoverbox");var s=o.normalizeGrade(a.data.grades[a.node.item.nid],a.node.item,!0).cols[a.node.schemeCol];if(2==l.current.node.type){var r=l.current.data.grades[a.node.item.nid];r.o&&r.o.includes("total")?(t.displayVal=t.arg("titleNoMarkApplicableUndo"),t.state.set("invalidGradeMode",4)):(t.displayVal=t.arg("titleNoMarkApplicable"),t.state.set("invalidGradeMode",3))}else!o.validGrade(100*s)&&s>=0?(t.displayVal=e.tpl(t.arg("titleOutOfRange"),{norm:o.percent(s),max:o.percent(o.valid.upper/100)}),t.state.set("invalidGradeMode",1)):(t.displayVal=t.arg("titleInvalid"),t.exit())},summativeWarnings:function(t){var a,r=2==o.AverageType&&o.currentReportingPeriod&&o.currentReportingPeriod.nid||o.nid,n=o.buckets[r],d=o.bucketed[r],i={};if(t.state.set("weightingWarning",!0),2==o.AverageType&&o.previousReportingPeriod&&100!=o.previousReportingPeriod.buckets[-1].points&&100==o.currentReportingPeriod.buckets[-1].points&&(a=t.arg("titleNoActiveWeighting"),t.xds.fields.weighting.title=t.arg("titleCopyWeighting"),t.xds.fields.weighting.events=[{func:function(a){o.buckets[r]=o.previousReportingPeriod.buckets;t.arg("xdsWeighting");e.post({data:{buckets:JSON.stringify(o.buckets)},url:{nid:o.nid,xds:t.arg("xdsWeighting")},callback:function(){t.trigger("reload")}})}}]),0==d[-2]&&!d[-2].length)for(var c in n)if(!n[c].points&&d[c]&&d[c].length){var u=n[c].subBuckets;if(u){var p=!1;for(var g in u)if(u[g].points){p=!0;break}if(p)continue}if(!d[c].filter(function(e){return"0"!=e.summative}).length)continue;a=e.tpl(t.arg("titleBucket"),{name:o.bucketTitle(n[c].selectors)})}if(!a||d[-2]&&d[-2].length){var m;if(d[-2]&&d[-2].length)a=1===(m=d[-2]).length?t.arg("titleNoBuckets1"):t.arg("titleNoBuckets2");else{if(!(m=o.findNonWeightedAssessments()).length&&!o.warnings)return l.hasWarning=!1,!1;a=1===m.length?t.arg("title1"):t.arg("title2")}var v=m.map(function(e){return'<span class="dataBook-summativeWarning-tooltip-item" data-nid="'+e.nid+'">'+e.name+"</span>"}),h=1===m.length?t.arg("titleA1"):t.arg("titleA2");t.displayVal='<span class="dataBook-summativeWarning-title">'+e.tpl(a,{num:e.html.span(m.length+" "+h+e.html.tooltip(v.join("")),["xds-tooltip-parent","dataBook-summativeWarning-tooltip"])})+"</span>"}else l.hasWarning=!0,t.displayVal=a;if(o.warnings)if(o.warnings.buckets){var f=!0,b=!1,k=s;try{for(var y,C=o.warnings.buckets[Symbol.iterator]();!(f=(y=C.next()).done);f=!0){var x=y.value;if("17"==x&&!o.strands){t.displayVal=t.arg("titleBucketInvalidStrand");break}if("19"==x&&!o.glo){t.displayVal=t.arg("titleBucketInvalidGLO");break}}}catch(e){b=!0,k=e}finally{try{f||null==C.return||C.return()}finally{if(b)throw k}}}else o.warnings.schemes?(t.displayVal=t.arg("titleAssessmentScheme"),i.assessments=o.warnings.schemes,t.state.set("weightingWarning",!1)):o.warnings.mapping&&(t.displayVal=t.arg("titleAssessmentMapping"),i.assessments=o.warnings.mapping,t.state.set("weightingWarning",!1));i.warningText=t.displayVal,t.map(i),delete t.displayVal,t.arg("icon","alert"),l.hasWarning=!0,t.ready(function(){l.dataBook.addClass("dataBook-hasWarning")}),t.on("click",function(e,t){var a=e.eventSource();if(a.hasClass("dataBook-summativeWarning-tooltip-item"))a.attr("data-nid");(a.hasClass("dataBook-summativeWarning-tooltip")||a.parents(".dataBook-summativeWarning-tooltip").length)&&e.get_target("children:weighting").trigger("click")},{priority:2})},busted:function(e){if(!o.busted)return!1;e.map(o.busted),e.ready(function(){$(".dataBook").remove()}),e.inherit("noContent")},activityFeed:function(t,a){if(o&&o.busted)return!1;var s=l.footerBarHeight||t.target("*footerBar").outerHeight();l.footerBarHeight=s;var r=function(){var a=l.hasWarning?l.warning.outerHeight():0;return l.hasWarning&&t.dom().css("margin-top",l.warning.innerHeight()+"px"),e.window.height()-a-t.target("*optionsToolbar").outerHeight()-s+"px"};t.ready(function(e,t){t.css("height",r())}),t.on("dataBook-resize",function(e,t){t.css("height",r())})},setup:function(s){l.mobile||s.get_xdo("*body")&&s.get_xdo("*body").state.get("sortReload")||s.on(a,"keydown",l.events.navigate,{priority:10001}),l.print=e.links.queryParams().print,e.extend(l,{_colCount:0,_colCountHeader:0,_colCountHeaderBreak:0,_hcolCountHeaderBreak:0,_hcolCountHeader:0,_colBroken:0}),s.get_setting("redrawPath")||s.addClass("dataBook-first"),s.get_setting("tab")||s.set_setting("tab",0),l.sheetMode&&s.addClass("dataBook-sheetMode"),delete l.studentStatusList,delete l.graderHost,delete l.sortSettingLoaded,s.tag("div",!1);var o=e.storage("dataBook-scroll-"+e.gbl.nid);o||s.addClass("dataBook-scroll-init"),l.mobile&&$("head").append('<meta name ="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1">'),setTimeout(function(){l.print&&(t.print(),t.close())},1e3);try{var r=JSON.parse(s.state.get("GradebookTabs")||"[]");r.length||(r=[{label:"Main"}],s.state.set("GradebookTabs",JSON.stringify(r)));var n=r.map(function(e){return{label:e.label}});s.state.set("tabs",n)}catch(e){}s.ready(function(a){++l.loaded;t.onscroll=l.scrollListen;t.onresize=l.onresize,l.scrollListen(!0),setTimeout(function(){l.sheetMode?(e.scrollTop(1),e.scrollLeft(0)):o?(e.scrollTop(o.top||1),e.scrollLeft(o.left)):(e.scrollTop(1),e.scrollLeft(e.document.width()-e.window.width()));var t=e.storage("bookGrades-focus-"+e.gbl.nid);t&&l.utils.focusCell(t,a)},1)}),s.on(t,"click",function(e){var t=e.eventSource();t.xdo&&9!==t.xdo.node.type&&t[0]!==l.commentInput[0]?l.commentInput.hide():t.xdo&&9===t.xdo.node.type&&t[0]!==l.commentInput[0]&&!t.xdo.hasClass(i.cellDisabled)&&l.commentInput.show()},{priority:2}),s.on(t,"mousedown",function(e){var t=e.eventSource();t.hasClass("dataBook-hoverInspector")||t.parents(".dataBook-hoverInspector").length||t.xdo&&8===t.xdo.get_val("type","node")||l.utils.hideHoverInspector()})},studentSort:function(t){if(o&&o.busted)return!1;var a=t.state.peek("GradebookTabs");if(a&&!l.sortSettingLoaded){try{a=JSON.parse(a)}catch(e){}if(a&&e.is_arr(a)){var r=a[t.get_setting("tab")||0];e.is_obj(r)&&(r.view?(l.view=r.view,t.state.set("view",r.view)):(l.view="reporting",t.state.set("view",s)),t.state.set("afilters",r.afilters),t.global("afilters",r.afilters),t.state.set("sfilters",r.sfilters),t.global("sfilters",r.sfilters),t.set_setting("sortParam",r.sortParam),t.state.set("namesort",r.ssort),t.set_setting("ssort",r.ssort),t.set_setting("showDropped",r.sfilters&&r.sfilters.length&&r.sfilters.split(",").includes("showDropped")),t.set_setting("csort",r.csort),t.set_setting("csortcol",r.csortcol),t.set_setting("csortReverse",r.csortReverse)),t.on("onload",function(){t.get_xdo("*includepicker").update(),t.get_xdo("*gradelevelpicker").update()})}l.sortSettingLoaded=!0}var n,d=t.state.get("body"),i=o.students,c=[],u=[],p=t.state.get("sfilters");for(var g in p&&p.length&&(n=(p=p.split(",")).filter(function(t){return"showDropped"!==t&&!e.lookup("gradeLevel",t).val()}),p=p.filter(function(t){return"showDropped"!==t&&e.lookup("gradeLevel",t).val()})),d)(g=d[g]).prefname&&(g.first=g.prefname,g.student.first=g.prefname),!i[g.nid]||p&&p.length&&!p.includes(g.grade)||n&&n.length&&!n.includes(i[g.nid].CourseID||o.CourseID)||(e.extend(i[g.nid],g),e.lookup("r","Dropped").cmp(g.reltype)?(t.get_setting("showDropped")&&c.push(i[g.nid]),u.push(i[g.nid])):c.push(i[g.nid]));t.get_setting("showDropped")&&(c=l.studentsOrder=u),l.droppedStudents=u;var m=t.get_setting(),v=m.csort,h=m.csortcol,f=m.ssort,b=m.csortReverse;t.tag("div",!1),t.state.get("collapsed")?t.addClass("dataBook-students-collapsed"):t.removeClass("dataBook-students-collapsed"),v||(c=e.sort({sortBy:"last,first"},c));var k=t.get_val("body-book-body","node")||{};t.data&&t.data.body&&(l.studentsOrder=t.data.body=c),l.view=l.view||t.get_val("view")||"reporting";var y,C,x=t.state.get("afilters");if(x&&(x=o.unpackFilterPicker(x),y=o.filtrAssessments(x)),y=l.utils.sortAssessments(y),C=l.utils.sortReporting(),l.units=o.units,l.terms=o.terms,l.reporting=C,l.assessments=y,l.utils.normalizeGrades(),v){h=-1!==h?"-cols-"+h:"-average",v=o.reporting[v]?"reporting-"+v:o.units[v]?"units-"+v:"overall"===v?"average":"normalized-"+v+h;var B=e.sort({sortBy:v+","+(m.ssort||"last,first"),sortDirection:(b?"forward":"reverse")+",forward,forward",sortType:"number",round:100},c);l.studentsOrder=t.data.body=B}else if(t.get_setting("ssort")){B=e.sort({sortBy:f},c);l.studentsOrder=t.data.body=B}o.studentsOrder=l.studentsOrder,l.utils.buildTable(k,t)},footer:function(e){var t=l.graderHost!==s;e.state.set("GraderFooter",t),e.tag("div",i.footer)},dragHandle:function(t){var a,s,o,r;function n(t){var n=t.pageY-a.top;t.preventDefault();var d=n/l.rowHeight,c=parseInt(d,10);if((d=c+Math.round(d-c))!==o&&(o=d,$(".dataBook-drag-active").removeClass("dataBook-drag-active"),$(".dataBook-drag-active-last-prev").removeClass("dataBook-drag-active-last-prev"),$(".dataBook-drag-active-last-next").removeClass("dataBook-drag-active-last-next"),0!==d)){var u,p,g=!(d>0);d=Math.abs(d);for(var m=s,v=0;v<d;v++){if(!(m=g?m.prev():m.next()).hasClass(i.cell)&&u){g?u.addClass("dataBook-drag-active-last-prev"):u.addClass("dataBook-drag-active-last-next");break}(p=m).addClass("dataBook-drag-active"),v===d-1&&(g?p.addClass("dataBook-drag-active-last-prev"):p.addClass("dataBook-drag-active-last-next")),u=p,t.clientY>r-40?e.document.scrollTop(e.document.scrollTop()+10):t.clientY<200&&e.document.scrollTop(e.document.scrollTop()-10)}}}function d(){var t=l.current;l.events.setGrade();var a=$(".dataBook-drag-active"),s=a.length;l.filling=!0;for(var o=0;o<s;o++)l.current=e.get_obj(a[o].id),l.utils.cellActive(l.current.node.item.nid,l.current.nid())&&l.events.setGrade();l.filling=!1,l.current=t,t.newEvent("bookGrades.events.focusCell"),a.removeClass("dataBook-drag-active"),$(".dataBook-drag-active-last-prev").removeClass("dataBook-drag-active-last-prev"),$(".dataBook-drag-active-last-next").removeClass("dataBook-drag-active-last-next"),e.document.off("mouseup",d),e.document.off("mousemove",n)}t.tag("div",!1),t.on("mousedown",function(t,o){r=e.window.height(),l.showInspector&&(r-=200),t.e.preventDefault(),o.parents(c.col),o.parents(c.cell),a=o.offset(),1,s=o.parents(c.cell),e.document.on("mousemove",n),e.document.on("mouseup",d)})},commentInput:function(e){e.tag("textarea")},gradeInput:function(e){e.tag("input").addAttr({type:"text",value:""}),!l.mobile&&e.has_write(l.xdsSet)||e.addAttr("readonly","readonly")},footerAverage:function(t){t.tag("div","dataBook-footerAverage").eventSelector("dataBook-footerAverage"),t.addClass(i.cell);var a=t.rnode.type;if(2===a){if(t.rnode&&t.rnode.item&&t.rnode.item.gs&&t.rnode.item.gs.nototal)return void(t.displayVal=e.lang("N/A"))}else{if(o.GBNoAverages)return void(t.displayVal="");if(a>100){var s=o.SummaryCols[t.rnode.index];if(1==s.summary&&1==s.type){var r=o.averageColumn();s.showas&&"0"!==s.showas?(r=o.percent(r,!0),r=o.symbolicMap(s.showas,r)):r=o.percent(r),t.displayVal=r}else 4==s.summary&&4==s.type?t.displayVal=o.averageSummaryColumn():t.displayVal="";return}}o.GBMapScheme?t.displayVal=o.symbolicMap(o.GBMapScheme,100*t.data):t.displayVal=o.percent(t.data),t.data<o.FailThreshold&&t.addClass(i.failing)},headerStack:function(e){if("reporting"!==l.view)return!1;e.tag("div","dataBook-headerStack").eventSelector("dataBook-headerStack")},header:function(t){var a=t.data.item||t.data;t.displayVal='<span class="'+i.unitName+'">'+l.utils.unitName(a)+"</span>",t.addClass("dataBook-headerUnit-"+a._number);var s,o,r=l.colWidth/2,n=function(e){var a=t.dom(),n=e.pageX-o.left-r;n<-1*r/2?n=0:n>a.width()-r&&(n=a.width()-r),s.css({left:n+"px"})};t.on("mouseenter",function(t,a){s=a.children(c.unitName),o=a.offset();var d=t.e.pageX-o.left-r;s.css({left:d+"px",top:"5px"}),a.css("z-index",8),e.document.on("mousemove",n),a.on("mouseleave",function(){a.css("z-index",""),e.document.off("mousemove",n)})})},headerReporting:function(e){return!1},headerUnit:function(e){if(l.sheetMode)return!1;e.tag("div","dataBook-headerUnit").eventSelector("dataBook-headerUnit");var t=e.data.len;"units"!==l.view||o.GBNoAverages||t++;var a=l.colWidth*t+t-1;e.addStyle("width",a+"px"),e.inherit("bookGrades.types.header")},assessmentName:function(e){if(l.sheetMode)return!1;e.tag("nowrap")},assessmentDate:function(e){if(l.sheetMode)return!1;var t="dataBook-headerAssessment-date";e.tag("div",t).eventSelector(t),e.data||e.addClass(t+"-unset")},headerAssessment:function(t){if(l.print){0===t.get_index()&&(l._colBroken=0);var a=t.data.nid,r=l.utils.maxCols(),n=l.utils.numCols(t.data);l._colnidHeader||(l._colnidHeader=a),a!=l._colnidHeader&&(l._colnidHeader=a,r<l._colCountHeader+n&&(l._colCountHeaderBreak++,t.temp.numBreak=l._colCountHeaderBreak,l._colCountHeader=0,t.pretag('<div class="dataBook-col-breakHeader"></div>'),t.ready("bookGrades.events.movePrintHeader",{endClass:".dataBook-col-breakHeader"}),l._colBroken=!0)),l._colCountHeader+=n}var d,i;if(t.data.nodesubtype==e.nt.Document.ReportingPeriod(!0)||t.data.nodesubtype==e.nt.Document.Unit(!0))d=1,t.addClass("dataBook-headerAssessment-reporting"),i=l.colWidth*d;else{d=t.data.renderColumns;var c=t.data.summative,u="";0==c?u=e.lang("Formative"):2==c&&(u=e.lang("Bonus")),u&&(u='<p class="dataBook-headerAssessment-details-formative">'+u+"</p>");t.data.adate;t.data.formativeString=u||s,t.data.assessmentReportingName=o.assessmentReportingName(t.data),t.map(),l.sheetMode?(delete t.data.details,t.addStyle("overflow","visible")):delete t.data.sheetMode,i=l.colWidth*t.data.fullColumns+l.colWidthsMeasure.small*t.data.smallColumns+l.colWidthsMeasure.large*t.data.largeColumns}t.tag("div","dataBook-headerAssessment").eventSelector("dataBook-headerAssessment"),!l.sheetMode&&t.inherit("hoverIntent"),t.addStyle("width",i-5+d+"px"),l.sheetMode?t.addStyle("height","54px"):t.addStyle("height",("reporting"===l.view?50-l.headerBandSize*l.headerSize:50)+"px"),l.headerMatrix[t.data.nid]=t},headerCol:function(t){t.tag("div","dataBook-headerCol").eventSelector("dataBook-headerCol");var a=t.data.item;if(l.print){0===t.get_index()&&(l._colBroken=0);var s=a&&a.nid,o=l.utils.maxCols(),r=l.utils.numCols(a);l._hcolnidHeader||(l._hcolnidHeader=s),s!=l._hcolnidHeader&&(l._hcolnidHeader=s,o<l._hcolCountHeader+r&&(l._hcolCountHeaderBreak++,t.temp.numBreak=l._hcolCountHeaderBreak,l._hcolCountHeader=0,t.pretag('<div class="dataBook-col-breakHeaderCol"></div>'),t.ready("bookGrades.events.movePrintHeader",{endClass:".dataBook-col-breakHeaderCol"}),l._colBroken=!0)),l._hcolCountHeader++}var n=t.data,d=t.arg("noSort");d&&t.addClass("dataBook-headerCol-noSort");var c,u=d?"":'<span class="dataBook-headerCol-sort"> </span>',p=a&&a.nid;switch(n.type){case 1:case 2:var g=a.gs;a.scheme===l.noneScheme&&(u=""),0==a.summative&&t.addClass(i.formative),1===n.type?(u+='<span class="dataBook-headerCol-name">'+(1===g.order.length?g.title:g.cols[n.schemeCol].title)+"</span>",("points"===g.mapping&&!g.customMapping||g.customMapping&&("points"===g.cols[n.schemeCol].mapping||!g.cols[n.schemeCol].mapping&&"points"===g.mapping))&&(u+='<span class="dataBook-headerCol-outof">/'+a.columns[n.schemeCol]+"</span>",t.addClass("dataBook-headerCol-hasOutOf"))):u+='<span class="dataBook-headerCol-name">'+(g.nototal?e.lang("Status"):e.lang("Total"))+"</span>";break;case 3:t.addClass("dataBook-headerCol-reporting"),u+='<span class="dataBook-headerCol-name">'+a.name+'</span><span class="dataBook-headerReporting-marker dataBook-headerReporting-'+a._number+'"></span>';break;case 4:break;case 5:t.addClass("dataBook-assessment-noscheme"),c=e.lang("Set Scheme");break;case 6:t.addClass("dataBook-headerCol-reporting"),u+='<span class="dataBook-headerCol-name">'+l.utils.unitName(a)+'</span><span class="dataBook-headerUnit-marker dataBook-headerUnit-'+a._number+'"></span>';break;case 7:c=e.lang("Status");break;case 8:c=e.lang("Discussion");break;case 9:c=e.lang("Comments");break;case 10:c=e.lang("Submitted")}l.colWidths[n.type]&&t.addClass(i.colWidths+l.colWidths[n.type]),c&&(u='<span class="dataBook-headerCol-name">'+c+"</span>"),t.displayVal=u;var m=t.get_setting();m.csort==p&&m.csortcol==n.schemeCol&&(t.addClass("dataBook-sorted"),m.csortReverse&&t.addClass("dataBook-sort-reverse")),!d&&t.on("click",function(e,t){var a=e.data,s=a.item;if(s&&s.nid){var o=s.nid;if(s&&s.scheme===l.noneScheme)return void l.headerMatrix[o].target("*"+(l.sheetMode?"edit":"date")).trigger("click");var r=!(t.hasClass("dataBook-sort-reverse")||!t.hasClass("dataBook-sorted"));e.newEvent("bookGrades.utils.sort",{csort:o,csortcol:a.schemeCol,csortReverse:r,name:""})}})},col:function(e){if(e.tag("div","dataBook-col").eventSelector("dataBook-coll"),l.print&&e.rnode&&e.rnode.item){var t=e.rnode.item.nid,a=l.utils.maxCols(),s=l.utils.numCols(e.rnode.item);l._colnid||(l._colnid=t),t!=l._colnid&&(l._colnid=t,a<l._colCount+s&&(l._colCount=0,e.pretag('<div class="dataBook-col-break"></div>'),l._colBroken=!0)),l._colCount++}var o=e.data.type;e.rnode&&e.rnode.item&&(1===o||2===o)?(e.rnode.item.readonly&&e.addClass("dataBook-readonly"),0==e.rnode.item.summative&&e.addClass(i.formative)):3===o||6===o?e.addClass("dataBook-col-reporting"):5===o&&e.addClass("dataBook-assessment-noscheme"),l.colWidths[o]&&e.addClass(i.colWidths+l.colWidths[o])},cell:function(t,a){var r=t.global("matrix")||t.caller().global("matrix");t.tag("div","dataBook-cell").eventSelector("dataBook-cell");var n,d,c,u,p=a&&a.cell_node?a.cell_node:t.node,g=a&&a.student?a.student:t.data,m=a&&a.cell_node?a.cell_node.item:t.node.item,v=(g.nid,""),h=o.getCellValue({col:p,student:g});if(1===p.type||2===p.type||5===p.type||p.type>=7&&p.type<=10){d=p.schemeCol,n=m.nid,c=g.normalized[n];var f=g.grades[n]||{};if((!l.graderHost||m.rubric&&l.rubricGrading)&&(((r[n]||(r[n]={}))[d]||(r[n][d]={}))[g.nid]=t),m.individualAssessment&&!m.studentAssigned[g.nid]&&t.addClass(i.cellDisabled),l.sheetMode||l.graderHost&&t.xds_full.id==l.xdsGrader)switch(p.type){case 7:v='<span class="'+(b=[i.received,i.received+"-"+(f.r||0)]).join(" ")+'"></span>',f.e&&(v+='<span class="'+i.esubmit+'"></span>');break;case 8:b=[i.discussion],f.m&&b.push(i.discussionExists),f.t&&b.push(i.discussionUnread),v='<span class="'+b.join(" ")+'"></span>';break;case 9:v='<span class="'+i.commentFull+'">'+(f.c===s?"":f.c)+"</span>";break;case 10:f.e&&(v='<span class="'+i.esubmit+'"></span>')}else if(!m.includeTotalColumn&&1===p.type||2===p.type){var b=["dataBook-comment"];f.c&&b.push(i.commentTrue),v+='<span class="'+b.join(" ")+'"></span>',f.e&&(v+='<span class="'+i.esubmit+'"></span>'),b=[i.received,i.received+"-"+(f.r||0)],f.r||b.push("fa-solid","fa-caret-down"),v+='<span class="'+b.join(" ")+'"></span>'}if(!m.rubric||h===s||""===h||0==h||isNaN(h)&&null==o.gradeSchemes[m.scheme].mapping[h].percentage||(2===p.type&&(h*=100),h=o.symbolicMap(m.scheme,h)),1===p.type){u=c.cols[d],b=["dataBook-status"],""===h||o.validGrade(u)||o.allowOverride(f,d)?o.GBMapScheme&&l.mapAll&&(h=o.symbolicMap(o.GBMapScheme,100*u)):b.push(i.statusInvalid);var k=g.grades[n];(k.o&&k.o.includes("total")&&!h||null===u)&&t.addClass("dataBook-dropped"),v+='<span class="dataBook-grade">'+h+"</span>",t.displayVal='<span class="'+b.join(" ")+'"></span>'+v+"&nbsp;"}else if(2===p.type){var y;if(o.GBNoAverages)u="-";else if(m.rubric&&h!==s&&""!==h&&!1!==h)u=h;else if(o.GBMapScheme){u=o.symbolicMap(o.GBMapScheme,!1!==h&&""!==h?100*h:h);var C=o.mappingSchemes[o.GBMapScheme].mapping&&o.mappingSchemes[o.GBMapScheme].mapping[u];C&&null===C.max&&null===C.min&&null===C.percentage&&(y=!0)}else u=o.percent(h);((!o.GBNoAverages||!h)&&("-"===u||y)&&m.numCols>1&&Object.keys(f.cols).length||f.o&&f.o.includes("total"))&&(v+='<span class="dataBook-status dataBook-status-invalid"></span>'),m.gs.nototal&&(u="",t.addClass("dataBook-nototal")),t.displayVal=v+'<span class="dataBook-grade">'+u+"</span>",u=h}else p.type>=7&&p.type<=10&&(t.displayVal=v);7===p.type&&(t.displayVal+='<span class="dataBook-cell-pickerMarker fa-solid fa-caret-down"></span>'),f.d&&t.addClass(i.dropped)}else{if(101!=p.type)if(o.GBMapScheme&&"number"==typeof h&&!isNaN(h))var x=o.symbolicMap(o.GBMapScheme,100*h);else x=o.percent(h);else x=h;if(u=h,3===p.type)t.displayVal=v+'<span class="dataBook-grade">'+x+"</span>",(r[m.nid]||(r[m.nid]={}))[g.nid]=t,r[m.nid].Reporting=!0;else if(4===p.type)r.summary||(r.summary={}),r.summary[g.nid]=t,t.displayVal='<span class="dataBook-grade">'+x+"</span>";else if(101==p.type){if(r.customSummary||(r.customSummary={}),r.customSummary[g.nid]||(r.customSummary[g.nid]={}),r.customSummary[g.nid][p.index]=t,"4LevelTrafficLights"===p.showas&&o.mappingSchemes[p.showas].mapping){if(!o.mappingSchemes[p.showas].mapping[u])return;var B=o.mappingSchemes[p.showas].mapping[u].color;return void e.get("gradebook").trafficLight(t,B,"18px",!0)}if("4LevelTrafficLights"===p.showas&&e.get("trafficlight_performance")&&3==p.summaryType){var w=[],S=x.split("-");for(var _ in S){var T=S[_].trim(),G=e.get("trafficlight_performance").lightMap[T],H=[];if(G){for(var I in G.styles)H.push(I+":"+G.styles[I]);w.push('<span class="'+G.class.join(" ")+'" style="'+H.join(";")+'"></span>')}else w.push(T)}t.displayVal='<span class="dataBook-grade">'+w.join('<span style="vertical-align: top"> - </span>')+"</span>"}else t.displayVal='<span class="dataBook-grade">'+x+"</span>"}else 6===p.type&&(t.displayVal=v+'<span class="dataBook-grade">'+x+"</span>",(r[m.nid]||(r[m.nid]={}))[g.nid]=t,r[m.nid].Unit=!0)}"number"==typeof u&&u<o.FailThreshold&&m&&2!=m.summative&&t.addClass(i.failing),1!==p.type&&t.addClass("dataBook-calculated"),t.delegate("click","bookGrades.events.focusCell"),t.delegate("dblclick","bookGrades.events.focusCell")},consistencyFlag:function(t){if(!o.SummaryCols||t.node.index!=o.SummaryCols.length-1)return!1;t.tag("div","dataBook-consistencyFlag").eventSelector("dataBook-consistencyFlag");var a=o.consistency(t.rnode);if(t.rnode&&(t.rnode.flags=a),!a||!a.hasFlags)return!1;t.sparse=!0,t.on("click",function(t){t.dom().parent().trigger("click"),t.stopPropagation(),t.map({flags:a}),t.update(),t.addClass(i.invalidFocussed),l.invalidFocussed=t;var s=t.target("*consistencyDialog");e.hoverboxPosition(t.dom(),s),s.appendTo(t.target("xds-cont"))})},showDropped:function(t){t.get_setting("showDropped")?t.displayVal=e.lang("View Regular Students"):t.displayVal=e.lang("View Dropped Students (")+l.droppedStudents.length+")"},nameSort:function(e){e.get_setting("ssort")?e.xds.defaultValue=e.get_setting("ssort"):e.xds.defaultValue="last,first","units"!==e.xds.defaultValue&&"reporting"!==e.xds.defaultValue||(e.xds.defaultValue="last,first"),e.inherit("dd.select")},overallSummaryCol:function(e){if(l.print&&e.ready(function(){var t=e.targetFromId("body");e.dom().appendTo(t)}),o.busted||o.GBNoAverages)return!1;e.inherit("bookGrades.types.col")},overallSummaryWrap:function(e){if(e.get_val("summary")&&e.addStyle("width",l.summaryColWidth+"px"),o.busted||o.GBNoAverages)return!1;l.print&&e.ready(function(){e.dom().insertBefore(e.find(".dataBook-col-break",1).last().find(".dataBook-row-break").last())})},overallSummary:function(t){t.tag("p",!1),t.preclosetag(e.html.span("","dataBook-sort"));var a=e.nt.Container.Class(!0)==t.node.nodesubtype?o.averageName(t.arg("title")):t.node.title||o.averageName(t.arg("title"));t.xds.title=a,"overall"==t.get_setting("csort")&&(t.addClass("dataBook-sorted"),!t.get_setting("csortReverse")&&t.addClass("dataBook-sort-reverse")),t.on("click",function(e){var t=!1;"overall"!=e.get_setting("csort")||e.get_setting("csortReverse")||(t=!0),e.args={csort:"overall",csortReverse:t,name:""},l.utils.sort(e)})},buildTable:function(e){if(o&&o.busted)return!1;e.tag("div",!1),e.get_val(),e.addStyle("padding-right",l.summaryColWidth+(l.feedVisible?l.feedWidth:0)+"px")},publish:function(t){t.get_val();var a,r,n=t.rnode;if(r="sheetMode"===t.parent.id?n:"sheetModeOLT"===t.parent.id?t.parent_xdo().data:"graderhostheader"==t.parent.id?t.state.get("ghassessment"):"footer"==t.parent.id&&l.graderHost?l.graderHost.state.get("ghassessment"):n.item,1===n.type&&!r.includeTotalColumn||2===n.type||"sheetMode"===t.parent.id||"sheetModeOLT"===t.parent.id||"graderhostheader"==t.parent.id||"footer"==t.parent.id){var d=r.nid,i=t.arg("tooltip2"),c=t.arg("tooltip1"),u=t.arg("title"),p=t.arg("message");1==r.published?(t.arg("tooltip",i),t.displayVal=t.arg("message"),t.showTitle=!1,a={mode:"grey"}):t.arg("tooltip",t.arg("tooltip1")),t.sparse=!0,t.inherit("button",a),t.on("click",function(t,a){"sheetMode"===t.parent.id&&t.e.stopPropagation();var n=function(a,s){var n=1==r.published?0:1,i=o.markCompleteList(d);s?e.post({url:{nid:d,xds:a||t.arg("xds")},data:{publish:n,snids:i,state:0},success:s}):t.event("post",{nid:d,xds:a||t.arg("xds"),data:{publish:n,snids:i,state:0}}),r.published=n};if(l.graderHost&&1!=r.published){var i=l.graderHost.state.get("globalpublished"),c=l.graderHost.state.get("studentfmap"),u=!1;for(var p in i)if(!i[p]){u=!0;break}if(u){var g={buttons:[{name:"shareall",text:"Share grade and all annotations",callback:function(t){var a=new Set;for(var d in i)i[d]||a.add(c[d]);var u=!0,p=!1,g=s;try{for(var m,v=a[Symbol.iterator]();!(u=(m=v.next()).done);u=!0){var h=m.value;o.setAttr(h,r.nid,"la",4)}}catch(e){p=!0,g=e}finally{try{u||null==v.return||v.return()}finally{if(p)throw g}}e.get("GraderHost").utils.updateStudentStatusList(),n("annotationsPublish",function(){l.graderHost.newEvent("reload")})}},{name:"sharegrade",text:"Share grade only",callback:function(e){n()}},,{name:"cancel",text:"Cancel"}],message:"Some students have unshared annotations."};e.dialog(g)}else n()}else n()}).on("posted",function(t,a){var s=a;l.graderHost&&"footer"!=t.parent.id?s=a.add(t.caller().find("button.xds-bookGrades-types-publish",1)):(l.sheetMode||l.graderHost)&&(s=a.add(t.find("button.xds-bookGrades-types-publish",1))),"sheetModeOLT"==t.parent.id&&(s=a.add(t.caller().parent_xdo().find("button.xds-bookGrades-types-publish"))),1==r.published?s.addClass("xds-button-grey").html(p+e.html.tooltip(i,"xds-tooltip-above")):s.removeClass("xds-button-grey").html(u+e.html.tooltip(c,"xds-tooltip-above"))})}else t.tooltip=!1,t.tag("div"),t.showTitle=!1},gradeLevelPicker:function(t){var a=e.get("gradebook")[t.nid("node")],o=t.state.get("body"),r=new Set,n=[],d=new Set;for(var i in o){var l=o[i].grade;if(a){var c=a.students[o[i].nid]&&a.students[o[i].nid].CourseID;a.CourseID!=c&&c&&d.add(c)}if(!r.has(l)&&l!==s){var u=e.lookup("gradeLevel",l).str();u&&(n.push({display:u,value:l}),r.add(l))}}d.size&&n.push({css:"list-divider",display:a.CourseID,value:a.CourseID});var p=!0,g=!1,m=s;try{for(var v,h=d.values()[Symbol.iterator]();!(p=(v=h.next()).done);p=!0){var f=v.value;n.push({display:f,value:f})}}catch(e){g=!0,m=e}finally{try{p||null==h.return||h.return()}finally{if(g)throw m}}n.push({css:"list-divider",display:"Dropped",value:"showDropped"}),t.inherit("f_str",{choices:n})}},events:{setupChanged:function(t){var a=e.get("gradebook")[t.nid()];for(var s in a.setupSummaryCols(t.state.get("SummaryCols")),a.students){var o=(s=a.students[s]).summaryCols&&JSON.stringify(s.summaryCols);a.calcualteAllSummaryCols(s);var r=JSON.stringify(s.summaryCols);o!==r&&e.post({data:{summaryCols:r,rid:s.rid},url:{command:"putlink",nid:e.gbl.nid,xds:l.xdsSet||t.arg("xdsSet")||"grades"}})}},movePrintHeader:function(e){var t=l.utils.maxCols(),a=e.find(".dataBook-col-break",1);a=a[e.temp.numBreak-1];for(var s=0,o=e.dom();!o.hasClass(e.get_arg("endClass"))&&s<t;){var r=o.next("."+e.selector());o.appendTo(a),o=r,s++}_$('<div class="dataBook-row-break"></div>').appendTo(a)},returnToRegularMode:function(e){l.utils.cancelSheetMode(),delete l.rubricGrading,e.dom().trigger("reload")},sheetMode:function(t){var a=!0;l.rubricGrading&&l.graderHost&&(a=!1),l.sheetMode?l.utils.cancelSheetMode():(l.sheetMode=t.node.item?t.node.item.nid:t.nid(),e.storage("bookGrades-sheetMode-"+e.gbl.nid,l.sheetMode)),a&&t.dom().trigger("reload")},jumpToGradebook:function(t){var a=t.args.xds,s=t.get_val("snid"),o=t.nid(),r=t.nid("node");a==e.links.getxds()?(e.get("lightbox").close(),l.utils.focusCell({assessment:o,student:s},t)):(l.utils.saveFocussedCell({studnet:s,assessment:o}),t.args.nid=r,e.get_func("loadPage")(t,t.id(1)))},refreshHoverInspector:function(){var e=l.hoverInspectorParams,t=l.utils.getCell({assessment:e.anid,student:e.snid,col:"__8"},l.hoverInspector.xdo);t&&t.find(c.discussion).addClass(i.discussionExists),delete l.comments[e.anid],delete l.hoverInspectorFeedFormLoaded,l.utils.showHoverInspector(e.snid,e.anid,e.context,!0)},hoverInspectorShowFeed:function(e){e.dom().show()},hoverInspectorFormLoaded:function(){var e=l.hoverInspectorForm,t=l.hoverInspectorParams;e.find(".xds-form").length&&(e.find('[name="snid"]').val(t.snid),e.find('[name="anid"]').val(t.anid))},loadTeacherFeedPost:function(e){e.newEvent("loadxds",{xds:e.get_arg("xds"),nid:l.hoverInspectorParams.anid,command:e.get_arg("command"),nodetype:e.get_arg("nodetype")})},changeView:function(t,a){l.view=t.val(),t.args={data:{GradebookView:t.val()},xds:l.xdsProps},e.get_func("post")(t,a),a.trigger("reload")},gradeInput:function(t){clearTimeout(t.temp.inputTimer),t.temp.inputTimer=t.setTimeout(function(){var a=t.dom()[0],o=e.caretPos(a),r=t.global("commentNotify")||{},n=l.current&&l.current.node.item&&l.current.node.item.nid,d=l.current&&l.current.data.nid;r&&r[n]&&r[n][d]?t.trigger("change",{suppressNotification:!0}):(r[n]===s&&(r[n]={}),r[n][d]=!0,t.global("commentNotify",r),t.trigger("change")),e.caretPos(a,o)},4802)},setGrade:function(t,a,r,n){if(-1!==t||(t=s,!l.current||9!==l.current.node.type)){var d;t&&t.e;if((a=l.input).length){var i;if(clearTimeout(a.xdo.temp.inputTimer),r&&r.forceSave&&(i=!0,delete r.forceSave),r&&(r.override||""===r.override)){var u=r.override;r=s}var p=!1;"object"!==_typeof(t)&&t!==s?(p=!0,d=t):d=a[0].value;var g=(t=l.current).has_write(l.xdsSet);if(!g&&l.graderHost&&l.input.xdo&&(g=l.input.xdo.has_write(l.xdsSet)),t&&g){var m={},v=t.data.grades,h=t.node.item;if((1===t.node.type||2===t.node.type||9===t.node.type||7===t.node.type)&&(2!==t.node.type&&7!==t.node.type||r||i)){9===t.node.type&&(d=(a=l.commentInput)[0].value,m.notifyComment=!0,r&&r.suppressNotification&&(delete m.notifyComment,delete r.notifyComment),r={attr:"c",val:d});var f=t.node.schemeCol,b=h.nid,k=t.data,y=(v=k.grades[b],k.nid);n=n||l.utils.findImpacted(t);var C=o.normalizedAverage(k,b),x=!1;if(r){if(v[r.attr]==r.val||""==r.val&&v[r.attr]==s)return;if("d"===r.attr&&r.val&&(x=!0),v[r.attr]=r.val,("r"===r.attr||x)&&h.overdue)-1!==(B=e.in_array(y+"",h.overdue))&&(h.overdue[B]=!1)}else{if(h.readonly&&!p)return;if(v.cols||(v.cols={}),!u&&""!==u&&(""===d&&v.cols[f]===s||d==v.cols[f]&&(""+d).length===(""+v.cols[f]).length||(d+"").toUpperCase()==(v.cols[f]+"").toUpperCase()))return;var B;if(v.cols[f]=d,h.esubmit&&(x=!0),h.overdue)-1!==(B=e.in_array(y+"",h.overdue))&&(h.overdue[B]=!1,v.calendarOverdue&&(delete v.r,delete v.calendarOverdue));u||""===u?m.override=u:o.allowOverride(v,f)&&(m.override=o.clearOverride(v,f))}var w=new Date;v.a=e.dateFormat(w,"yyyy-mm-dd HH:MM:ss","",!0);for(var S,_,T,G=!r&&o.setGrade(k,b,f,d),H=o.normalizePercent(o.normalizedCol(k,h,f)),I=o.normalizePercent(o.normalizedAverage(k,b)),A=o.averageColumn(h,f),M=o.averageColumn(h),F=o.overallAverage(k,!0),P=o.averageColumn(),N=[["overallAverage",P],["colAverage",A],["overallGrade"]],D=n.reporting.length;D--;){S=(X=n.reporting[D]).node.item,_=X.dom(),T=S.nodesubtype==e.nt.Document.Unit(!0)?o.unitReportingPeriod(S):S.nid;var O=S.nodesubtype==e.nt.Document.Unit(!0)?S.nid:s;k[l.view][S.nid]=o.aggregateAssessments("overall",k,T,s,O,s,!1),r&&"d"!==r.attr||(N.push([_.find(c.grade)]),N.push([_.parent().find(c.footerAverage),o.averageColumn(S)]))}for(D=n.customSummary.length;D--;)X=n.customSummary[D],r&&"d"!==r.attr||N.push([X.dom()]);if(h.includeTotalColumn&&(N.push(["totalGrade"]),N.push(["totalAverage",M])),l.graderHost){var L=t.global("matrix");L[b][f]&&L[b][f][y].update(),h.includeTotalColumn?L[b][-1]&&L[b][-1][y].update().dom():L[b][0]&&L[b][0][y].update().dom()}N.map(function(e){var t="string"==typeof e[0]?n[e[0]]:e[0];t&&t.length&&t.xdo&&(t=t.xdo.update(e[1]),"1"!=h.summative||v.d||r||l.utils.flashAverage(t))}),h.classAverage=M=o.normalizePercent(M);var R,V,W=!0;if(l.noCurrent=!0,l.current&&l.current.path===t.path&&l.dragHandle.appendTo(l.body).hide(),e.is_obj(r)?(R=r.val,V=r.attr):(R=d,W=!1),n.cell.xdo&&n.cell.xdo.update().dom(),l.graderHost&&l.studentStatusList){var z=!0,j=!1,U=s;try{for(var $,E=l.studentStatusList[Symbol.iterator]();!(z=($=E.next()).done);z=!0){$.value.update()}}catch(e){j=!0,U=e}finally{try{z||null==E.return||E.return()}finally{if(j)throw U}}}if(e.extend(m,{summaryCols:JSON.stringify(k.summaryCols),Average:o.normalizePercent(F),ClassAverage:o.normalizePercent(P),key:f,field:b,rid:k.rid,value:R}),x&&(m.clearOverdue=1),m.AverageName=o.averageName(),"-"===M||isNaN(M)||1==h.graded?isNaN(M)&&h.graded&&(m.graded="",delete h.graded):m.graded=h.graded=1,!W&&!1!==I&&(m.unread=!0),m.published=h.published,W)m.attr=V;else{k.flags||(k.flags={});var K,J={},Y=o.reporting;for(var X in Y){var q=o.normalizePercent(o.aggregateAssessments("overall",y,X,s,s,s,!1));isNaN(q)||"number"!=typeof q||(K=!0,J[X]=q)}K&&(m.rAverages=JSON.stringify(J)),m.l_acount=k.flags.totalCompleted,m.l_zeroProportion=k.flags.percentZero,m.l_missingProportion=k.flags.percentMissing,m.l_weightedStdDev=k.flags.stdDevActual,m.l_trend=k.flags.change,m.l_snid=k.nid,m.l_norm=H,m.l_cnorm=o.normalizePercent(A),m.l_cweight=h.colweights[f],m.l_summative=h.summative,m.l_anorm=I,""===I||isNaN(I)||(m.validGrade=1)}for(var Z in m)"number"==typeof m[Z]&&isNaN(m[Z])&&(m[Z]="");var Q=setTimeout(function(){t.dom().append('<div class="dataBook-cell-loading"></div>')},400);l.lastPost=m,l.saving=!0,C<o.FailThreshold&&G.average>=o.FailThreshold&&1==h.published&&(m.MarkComplete=!0,m.usernt=[+k.nodetype,+k.nodesubtype]),e.post({data:m,url:{command:"putlink",nid:e.gbl.nid,xds:l.xdsSet},errorDialog:!0,error:function(e){delete l.saving;try{JSON.stringify(e)}catch(e){}ee(),t.dom().addClass("dataBook-cell-error")},success:ee}),e.storage("dataBook-nid-version",t.build.version),l.current&&l.current.path===t.path&&!l.filling&&(l.graderHost||l.dragHandle.appendTo(t.dom()).show(),delete l.current,t.newEvent("bookGrades.events.focusCell"))}}}}function ee(){l.saving=!0,clearTimeout(Q),t.dom().find(".dataBook-cell-loading").remove()}},buttonClick:function(t,a,s){var o=$(s&&s.target||t.e.target);if(o.hasClass(i.buttonValue)){var r=o.attr("data-value");if(l.numericKeypad){if(o.hasClass(i.buttonEnter))return l.filling=!0,l.events.setGrade(r),l.filling=!1,l.numericKeypadClicked=!1,void e.document.trigger("keydown",9);l.numericKeypadReset?(l.numericKeypadReset=!1,l.numericKeypadClicked=!0):r=l.input[0].value+""+r,l.input.val(r)}else a.find(c.inspectorSelected).removeClass(i.inspectorSelected),o.addClass(i.inspectorSelected),l.input.val(r),l.events.setGrade(),e.document.trigger("keydown",9)}},closeInvalidClick:function(e,t){e.target("xds-cont").safeRemove(),e.dom().safeRemove()},handleInvalidClick:function(t){var a=e.clone(t.xds_this.fields.invalidGrade);a&&(a.id="dataBook-"+a.id,a.type="bookGrades.types.invalidGrade",t.xdsbuild({slice:{xds:a},func:function(a){t.addClass(i.invalidFocussed),l.invalidFocussed=t,e.hoverboxPosition(t.dom(),t.find(".dataBook-invalidGrade")),t.find(".dataBook-invalidGrade").parent().appendTo(t.target("xds-cont"))},target:t.dom(),append:!0}))},focusCell:function(t,a){var r=t.e;if(r){var n=t.eventSource();n.hasClass(i.statusInvalid)&&t.event(l.events.handleInvalidClick)}if(!(9===t.node.type&&r&&"dblclick"===r.type||t.hasClass(i.cellDisabled))){(l.sheetMode||l.graderHost)&&l.commentInput.hide();l.current;var d,u,p,g,m,v=l.current,h="summary"===t.parent.id;if(l.summaryColumnFocus&&!h&&(l.summaryColumnFocus.removeClass("dataBook-summary-focus"),delete l.summaryColumnFocus),v&&v.node&&v.data&&v.data.grades&&(d=v.node.item)&&(!d.readonly||9===v.node.type)&&(1===v.node.type||9===v.node.type)){u=d.nid,p=v.node.schemeCol,g=v.data.grades[u]||{};var f=l.input[0].value;if(9===v.node.type){f=l.commentInput[0].value;var b=g.c}else b=g.cols&&g.cols[p];if(f!=(b=void 0!==b?b+"":"")||f.length!=b.length){var k=l.filling;l.filling=!0,l.events.setGrade(f),l.filling=k}}var y=!1;if(n&&(n.hasClass(i.esubmit)||n.hasClass(i.received))?(l.current=t,l.statusCodesObj&&l.statusCodesObj.dd.close(),"dblclick"===r.type?l.events.openGraderHost(t,s,{snid:t.nid(),anid:d.nid}):(y=!0,l.utils.addStatusPicker())):l.statusCodesObj&&l.statusCodesObj.dd.close(),!(v&&v.path===t.path||a&&a.hasClass(i.focus))||t.node&&t.node.item&&(t.node.item.rubric||2==t.node.item.esubmit)&&9!==t.node.type){l.noCurrent=!1,l.sheetMode?l.cellFocussed&&l.dataBook.removeClass(i.cellFocussed)&&(l.cellFocussed=!1):!l.cellFocussed&&l.dataBook.addClass(i.cellFocussed)&&(l.cellFocussed=!0),l.numericKeypadClicked&&l.events.setGrade(),l.current=t;var C=t.data;if(C){if((d=t.node.item)&&C&&(u=d.nid,p=t.node.schemeCol,g=C.grades[u]||{},m=t.node.type),1===t.node.type&&d&&(d.rubric||2==d.esubmit)&&r!==s&&r.type&&!y&&!l.rubricGrading){var x={target:t.target("*rubrics"),nid:[e.gbl.nid,d.rid,d.nid].join("/"),student:C.nid,noPath:!0};if(d.rubric){if(x.xds=l.xdsRubricGrade,l.graderHost&&(l.current=t.global("matrix")[u][p][C.nid]),t.newEvent("loadxds",x),l.rubricGrading=t,t.get_xdo("*topleft")&&t.get_xdo("*topleft").update(),l.studentStatusList){var B=!0,w=!1,S=s;try{for(var _,T=l.studentStatusList[Symbol.iterator]();!(B=(_=T.next()).done);B=!0){_.value.update()}}catch(e){w=!0,S=e}finally{try{B||null==T.return||T.return()}finally{if(w)throw S}}}t.target("*return").show()}else 2==d.esubmit&&(x.xds=l.xdsOnlineTestGrade,x.rid=o.getAttr(C.nid,d.nid,"b"),l.events.openGraderHost(t,s,{snid:t.nid(),anid:d.nid}))}l.activeFocus&&l.activeFocus.removeClass(i.focus),a.addClass(i.focus),l.activeFocus=a,l.invalidFocussed&&l.invalidFocussed.removeClass(i.invalidFocussed),delete l.invalidFocussed;var G,H,I=t.parent_xdo(),A=t.get_index(),M=I&&I.get_index()||0,F=l.input,P=1===m||9===m;d&&d.readonly&&1===t.node.type&&(P=!1),l.graderHost||l.utils.studentNameListSetActiveClass(A);var N=h?-1e6:M*l.w+l.offsetLeft;if(h&&(l.summaryColumnFocus&&l.summaryColumnFocus.removeClass("dataBook-summary-focus"),l.summaryColumnFocus=$(l.summaryColumn.find(c.col)[t.node.index]),l.summaryColumnFocus.addClass("dataBook-summary-focus")),l.body[0].style["background-position"]="0 "+(l.headerOffset+A*l.rowHeight)+"px",l.sheetMode?(l.activeColumn&&l.activeColumn.removeClass(i.activeCol),9!==t.node.type&&(l.activeColumn=t.parents(c.col),l.activeColumn.addClass(i.activeCol)),7===m&&(l.utils.hideHoverInspector(),r&&"click"===r.type&&l.utils.addStatusPicker())):l.dataBook.css("background-position",N+"px 0"),G=a.offset(),l.moveScroll(a,G,l.w),P&&d.scheme!==l.noneScheme){var D=!1;if((l.sheetMode||l.graderHost)&&9===t.node.type)F.removeAttr("readonly"),(F=l.commentInput).show(),H=(H=(H=(H=g.c||"").replaceAll("&quot;",'"')).replaceAll("&apos;","'")).replaceAll("&amp;","&"),F.text(H);else{l.commentInput.hide(),l.mobile?(F.attr("readonly","readonly"),D=!0):F.removeAttr("readonly"),(H=g.cols&&g.cols[p])===s&&(H="");var O=C.normalized[u]||{};!1!==O.average&&O.average!==s&&(H=(H+"").toUpperCase())}F[0].value=H,F.appendTo(a).show(),D||y||(F[0].focus(),F[0].select(),9===t.node.type||l.graderHost?l.dragHandle.hide():l.dragHandle.appendTo(a).show())}else F.length&&(F.attr("readonly","readonly"),F[0].value="",l.mobile||l.dragHandle.hide(),F.appendTo(a).show());if(clearTimeout(l.inspectorTimer),l.sheetMode&&8===t.node.type?(t.e&&"click"===t.e.type||l.hoverInspectorVisible)&&l.utils.showHoverInspector(C.nid,u,l.current.dom(),!0):l.utils.hideHoverInspector(),delete t.e,l.utils.saveFocussedCell({student:C.nid,assessment:h?"summary":u,col:p}),l.utils.showGradePicker(),l.noSheetModeInspector[t.node.type]){if(!l.showInspector)return;l.inspectorTimer=setTimeout(l.utils.showInspector,30)}else l.showInspector&&l.events.inspectorHide()}}else 8===v.node.type?l.hoverInspectorVisible?l.utils.hideHoverInspector():l.utils.showHoverInspector(t.data.nid,t.node.item.nid,l.current.dom()):7===v.node.type&&r&&"click"===r.type?l.utils.addStatusPicker():7==v.node.type&&r&&"dblclick"===r.type&&(l.statusCodesObj&&l.statusCodesObj.dd.close(),l.events.openGraderHost(t,s,{snid:t.nid(),anid:d.nid}))}},handleGraderNavigate:function(e,t,a,o){var r,n=e.get_xdo("parent:*cellprep");if(n===s){if(a&&!o)return;n=e.get_xdo("*cellprep"),r=a?1:n.dom().children().length}else r=a?t+1:t-1;if((r>(n=n.dom()).children().length||0==r&&o)&&(n=e.get_xdo("*commentcellprep").dom(),r=1),n)return n.children(":nth-child(".concat(r,")")).find(".xds-bookGrades-cell")},handleTabShiftNavigate:function(e,t,a,s,o,r){var n;if(o&&(1===o.rnode.type||7===o.rnode.type||8===o.rnode.type||9===o.rnode.type||10===o.rnode.type||2==o.rnode.type&&l.sheetMode)&&o.rnode.item===a.item)n=r.children(":nth-child("+t+")");else if(e.prev().length)if(a.item.renderColumns>1){n=function e(t){return($(t.next()).xdo&&$(t.next()).xdo.rnode.item)===a.item?e(t.next()):l.sheetMode?t:t.prev()}(s).children(":nth-child("+(t-1)+")")}else n=e.prev();else o&&2==o.rnode.type&&(r=r.prev()),n=r.children(c.cell),n=$(n[n.length-2]);return n.hasClass(i.cellDisabled)?l.events.handleTabShiftNavigate(n,n.xdo.get_index()+1,n.xdo.node,n.parent(),n.parent().prev().xdo,n.parent().prev()):n},handleTabNavigate:function(e,t,a,s,o,r){var n;if(o&&(1===o.rnode.type||7===o.rnode.type||8===o.rnode.type||9===o.rnode.type||10===o.rnode.type||2==o.rnode.type&&l.sheetMode)&&o.rnode.item===a.item)n=r.children(":nth-child("+t+")");else if(!e.next().length||e.next().hasClass(i.footerAverage))o&&2==o.rnode.type&&(r=r.next()),n=r.children(c.cell),n=$(n[0]);else if(a.item.renderColumns>1){n=function e(t){var s=$(t.prev()).xdo;return(s=s&&s.rnode&&s.rnode.item)===a.item?e(t.prev()):t}(s).children(":nth-child("+(t+1)+")")}else n=e.next();return n.hasClass(i.cellDisabled)?l.events.handleTabNavigate(n,n.xdo.get_index()+1,n.xdo.node,n.parent(),n.parent().next().xdo,n.parent().next()):n},navigate:function(t,a,s){var o=t.e,r=r=s||o.keyCode;if(!$(".lightbox").length){var n=$(":focus");if(!n.length||!(l.inspector.xdo&&n.parents(l.inspector.xdo.id()).length||n.length&&l.graderHost&&"dataBookTeacherFeedPost"==n.xdo.xds_full.id)){var d=l.current;if(d){var u=t.find("#cf-dialog",!0);if(!(l.graderHost&&u&&u.length&&u.children().length)){var p=t.find(".dataBook-footerBar-gradebookTabs-selected",!0).xdo;if(!p||!p.state.get("editTab")){if(27===r){if(l.hoverInspector.is(":visible"))return void l.utils.hideHoverInspector();if(l.current)return void l.inspectorToggle.trigger("click")}var g,m=l.input[0];9===d.node.type&&(m=l.commentInput[0]);var v=d.id(1),h=v.parent(),f=d.get_index()+1,b=d.node,k=h.next(),y=h.prev();k.length||l.summaryColumnFocus||(k=l.summaryColumn.find(c.col).first());var C=$(k).xdo,x=$(y).xdo;switch(r){case 9:if(l.summaryColumnFocus)return;if(l.graderHost){var B=!o.shiftKey;g=l.events.handleGraderNavigate(d,f,B,!0)}else g=o.shiftKey?l.events.handleTabShiftNavigate(v,f,b,h,x,y):l.events.handleTabNavigate(v,f,b,h,C,k);break;case 40:var w=e.getSelectionPositions(m),S=m.value.length;if(w.start===w.end&&w.end!==S&&S)return!0;if(l.graderHost){g=l.events.handleGraderNavigate(d,f,!0);break}for(g=v.next();g.hasClass(i.cellDisabled);)g=g.next();break;case 13:case 32:if(7===d.node.type||2===d.node.type||1===d.node.type&&!d.node.item.includeTotalColumn)t.e.preventDefault(),l.utils.addStatusPicker();else{if(8===d.node.type)return t.e.preventDefault(),t.e.stopPropagation(),void l.utils.showHoverInspector();if(9===d.node.type){if(t.e.shiftKey||32===r)return;g=v.next()}else l.graderHost?g=l.events.handleGraderNavigate(d,f,!0):32!==r&&(g=o.shiftKey?l.events.handleTabShiftNavigate(v,f,b,h,x,y):l.events.handleTabNavigate(v,f,b,h,C,k))}break;case 36:t.e.preventDefault();var _=t.find(c.col,1);g=$(_[0]).children(":nth-child("+f+")");for(var T=1;g.hasClass(i.cellDisabled);)g=$(_[T]).children(":nth-child("+f+")"),T+=1;break;case 35:t.e.preventDefault();var G=t.find(c.col,1);g=$(G[G.length-2]).children(":nth-child("+f+")");for(var H=3;g.hasClass(i.cellDisabled);)g=$(G[G.length-H]).children(":nth-child("+f+")"),H+=1;break;case 38:if(9===d.node.type&&0!==e.caretPos(m))return;if(l.graderHost){g=l.events.handleGraderNavigate(d,f,!1);break}for(g=v.prev();g.hasClass(i.cellDisabled);)g=g.prev();break;case 39:w=e.getSelectionPositions(m),S=m.value.length;if(w.start===w.end&&w.end!==S&&S)return!0;for(g=k.children(":nth-child("+f+")");g.hasClass(i.cellDisabled);)g=g.parent().next().children(":nth-child("+f+")");break;case 37:if(0!==e.caretPos(m))return;if(!(y=h.prev()).length&&!l.summaryColumnFocus)return;for(g=(g=!y.length&&l.summaryColumnFocus?l.body.children(":last-child"):h.prev()).children(":nth-child("+f+")");g.hasClass(i.cellDisabled);)g=g.parent().prev().children(":nth-child("+f+")");break;case 220:t.preventDefault(),7===d.node.type?l.utils.addStatusPicker():l.utils.findImpacted(d).handedIn.trigger("click");break;default:l.statusCodesObj.dd._open&&(t.preventDefault(),l.statusCodesObj.dom().find("u").each(function(){$(this).text()===String.fromCharCode(r)&&$(this).trigger("click")}))}if(g&&g.length&&!g.hasClass(i.footerAverage)){var I=e.get_obj(g);delete I.e,l.events.focusCell(I,g),o.preventDefault()}else g&&g.hasClass(i.footerAverage)&&l.current&&l.events.focusCell(l.current,l.current.id(1))}}}}}},changeFlag:function(t,a,o){var r=t.get_target("*flagActual"),n=r.xdo,d=n.get_val(),i=!1===d||d===s?"4":d,l=t.get_arg("value");if(i!=l){r.removeClass("classStatus-flag-"+i).addClass("classStatus-flag-"+l).html(e.lookup("classStatusCodes",l).str()),n.data=l;var c={field:"flag",rid:n.rid(),value:l};e.post({url:{command:"putlink",nid:t.get_arg("nid")||e.nodePath([t.nid("node")]),xds:t.get_arg("xds")},errorDialog:!0,data:c})}},initFlag:function(t,a){var s=e.picker({choices:"classStatusCodes",obj:t,noInput:!0,noArrow:!0,noDisplayBlock:!0,noDisplay:!0});a.append(s.construct()),s.init().open()},clearGrade:function(e,t){l.input[0].value="",l.events.setGrade()},dropGrade:function(e,t){var a=l.current,s=l.utils.currentGrade().d,o=l.inspectorDrop,r=(i.cmds,l.utils.findImpacted(a));s=s?"":1,l.events.setGrade(a,t,{attr:"d",val:s},r);var n,d=a.global("matrix")[a.node.item.nid],c=a.rnode.nid;for(var u in d)n=d[u][c].id(1),s?(o.addClass(i.buttonSelected),n.addClass(i.dropped)):(o.removeClass(i.buttonSelected),n.removeClass(i.dropped))},handedIn:function(t,a){if(l.statusCodesObj.dom().hide(),-3!=t.get_arg("value"))if(-2!=t.get_arg("value"))if(-1!=t.get_arg("value")){var s,r=t.e&&"xds-picker-picked"===t.e.type,n=l.utils.currentGrade(),d=n.r||0,i=r?t.get_arg("value"):a.attr("data-value");d!=i&&(s=l.utils.findImpacted(l.current),l.events.setGrade(l.current,a,{attr:"r",val:i},s),(8==i&&!n.d||8==d&&n.d)&&l.events.dropGrade())}else{var c=l.current.node.item.nid,u=l.current.data.nid;t.newEvent("bookGrades.events.openGraderHost",{anid:c,snid:u})}else l.events.dropGrade();else t.newEvent("lightbox",{xds:l.xdsESubmit,nodetype:"4.21",command:"create",thread:l.current.data.nid,nid:e.nodePath([o.nid,l.current.node.item.rid,l.current.node.item.nid]),snid:l.current.data.nid,noPath:!0})},highlightFeedComment:function(t,a){var o;if(l.feedFocusId&&(o=t.get_node(l.feedFocusId))&&o.length){var r=o[0].dom();if(!r.length)return;setTimeout(function(){var t=r.position();t&&t.top!==s&&$(".dataBookCommentList").parents(".xds-scroll-content").scrollTop(t.top),r.addClass(e.css.unread)},100),setTimeout(function(){r.removeClass(e.css.unread)},3e3),delete l.feedFocusId}},setOverride:function(e){var t=l.current,a=t.node.item.nid,s=t.node.schemeCol,r=o.setOverride(t.data.grades[a],s);l.events.setGrade(t,t.dom(),{override:r})},setCategoriesOverride:function(e){var t,a=l.current,s=a.node.item.nid,r=a.data.grades[s],n=a.data.normalized[s],d=e.get_arg("clear"),i=[];for(var c in n.cols){if(""==n.cols[c]){var u=l.utils.getCell({student:a.nid(),assessment:a.node.item.nid,col:c},a);i.push(u)}}for(var p in d?(r.o=r.o.replace("total",""),t=r.o||"",l.events.setGrade(a,a.dom(),{override:t,forceSave:!0})):(t=o.setOverride(a.data.grades[s],"total"),l.events.setGrade(a,a.dom(),{override:t,forceSave:!0})),i){var g=i[p];g&&g.update()}},feedToggle:function(t,a){t.args.noAnimate||(l.dataBook.addClass("dataBook-feedAnimate"),setTimeout(function(){l.dataBook.removeClass("dataBook-feedAnimate")},500)),l.utils.hideHoverInspector(),l.activityFeed.css("display",""),l.scrollListen(!0),l.dataBook.hasClass("dataBook-feedHidden")?(t.args.noAnimate||e.storage("dataBook-activityFeed","1","localStorage"),l.feedVisible=!0,l.activityFeedToggle.addClass("dataBook-feedToggle-visible"),l.dataBook.removeClass("dataBook-feedHidden"),l.body.css("padding-right",l.summaryColWidth+l.feedWidth+"px")):(t.args.noAnimate||e.storage("dataBook-activityFeed","0","localStorage"),l.feedVisible=!1,l.activityFeedToggle.addClass("dataBook-feedToggle-hidden"),l.dataBook.addClass("dataBook-feedHidden"),l.body.css("padding-right",l.summaryColWidth+"px")),l.onresize()},inspectorHide:function(){l.showInspector=!1,l.inspector.css({height:0}),l.dataBook.removeClass("dataBook-inspectorOpen")},inspectorToggle:function(e,t){if(l.current){var a=l.current.node.type;if(!l.noSheetModeInspector[a])return l.events.sheetMode(l.current),void delete l.rubricGrading}delete l.rubricGrading;var s=l.showInspector;l.showInspector=!l.showInspector,s?l.events.inspectorHide():(l.inspector.css({height:265}),l.utils.showInspector(),l.dataBook.addClass("dataBook-inspectorOpen")),setTimeout(function(){l.current&&l.events.focusCell(l.current,l.current.id(1))},180)},xprt:function(a){var s=o.xprt(),r=[];for(var n in s)r.push(s[n].join(","));var d=new Blob([r.join("\n")],{type:"text/csv"});e.get("resourceutils").load({name:"file-saver",injectdirect:!0,initTest:function(e){return!!e.loaded||(e.loaded=!0,!1)},loadedTest:function(){return t.FileSaver},main:[e.gbl.lib+"pkg/node_modules/file-saver/dist/FileSaver.min.js"],postFunc:function(){}}).then(function(){saveAs(d,a.get_val("name")+" "+a.get_val("title")+" - Gradebook.csv")})},onSubmissionDelete:function(t,a){var s=t.state.get(t.get_arg("submissionSrc")||"submissions"),o=0;for(var r in s)"".concat(s[r].nodetype,".").concat(s[r].nodesubtype)==e.nt("Message.ESubmission").val()&&s[r].nid!=t.nid()&&(o+=1);if(!o){var n=e.get_resource("bookGrades"),d=n.utils.findImpacted(n.current);n.events.setGrade(n.current,a,{attr:"e",val:null},d),n.events.setGrade(n.current,a,{attr:"r",val:null},d)}},openGraderHost:function(t,a,s){o||(o=e.get("gradebook")[e.gbl.nid]);var r,n=t.get_arg("anid")||s&&s.anid,d=t.get_arg("snid")||s&&s.snid,i=t.get_arg("esnid")||s&&s.esnid;if(r=n?o.assessments[n]:l.current?l.current.node.item:o.assessments[t.nid()]){var c={target:t.get_target(".dataBook-rubrics",!0),nid:[e.gbl.nid,r.rid,r.nid].join("/"),thread:d,noPath:!0,esubmission:i,xds:"GraderHost"};t.newEvent("loadxds",c),t.target("*return").show();try{t.get_xdo("*topleft")?t.get_xdo("*topleft").get_xdo("*menu").hide():l.body.xdo.get_xdo("*topleft").get_xdo("*menu").hide()}catch(e){}l.commentInput.hide(),l.utils.hideHoverInspector()}},setTabLabel:function(e){var t=e.get_setting("tab")||0,a=e.state.top().get("GradebookTabs")||"[]";try{(a=JSON.parse(a))[t].label=e.val(),a=JSON.stringify(a),o.saveCustomFilter(e,a,"GradebookTabs"),e.state.top().set("GradebookTabs",a)}catch(e){}e.state.set("editTab",!1)},addTab:function(e){var t=e.state.get("GradebookTabs")||"[]";try{var a=(t=JSON.parse(t)).length+1;t.push({label:"Tab ".concat(a)}),e.set_setting("tab",a-1);var r=t.map(function(e){return{label:e.label}});t=JSON.stringify(t),o.saveCustomFilter(e,t,"GradebookTabs"),e.state.set("tabs",r),l.sortSettingLoaded=s,e.state.set("sfilters",""),e.state.set("afilters",""),e.global("sfilters",""),e.global("afilters",""),e.state.set("sortReload",!0),e.state.set("GradebookTabs",t)}catch(e){}},deleteTab:function(e){var t=e.state.top().get("GradebookTabs")||"[]";try{t=JSON.parse(t);var a=e.get_index();t.splice(a,1);var r=t.map(function(e){return{label:e.label}});a==e.get_setting("tab")&&e.set_setting("tab",a-1),t=JSON.stringify(t),o.saveCustomFilter(e,t,"GradebookTabs"),e.state.set("tabs",r),l.sortSettingLoaded=s,e.state.top().set("sortReload",!0),e.state.top().set("GradebookTabs",t)}catch(e){}},setActiveTab:function(e){var t=e.get_index();e.set_setting("tab",t);var a=e.find(".dataBook-footerBar-gradebookTabs-selected",!0);a&&a.xdo&&a.xdo==e?!e.state.get("editTab")&&e.state.set("editTab",!0):(a&&a.xdo&&a.xdo.removeClass("dataBook-footerBar-gradebookTabs-selected"),l.sortSettingLoaded=s,e.addClass("dataBook-footerBar-gradebookTabs-selected"),e.state.top().set("sfilters",""),e.state.top().set("afilters",""),e.state.top().set("sortReload",!0),e.global("sfilters",""),e.global("afilters",""),e.get_xdo("*book").get_xdo("parent:*body").update())},activateTabEdit:function(e){e.find(".xdl-forms-input").select(),e.on("focusout",function(){e.state.set("editTab",s)})},showDropped:function(e){e.args={showDropped:!e.get_setting("showDropped")},l.utils.sort(e,s,{update:!0})}},publish:{result:function(t){var a,s=t.get_val("grades");if(!s)return!1;a=s[t.nid()];var o=e.get("gradebook")[t.nid("node")],r=o.assessments[t.nid()],n=o.publishedGrade(r,a);return 1!=r.published&&"teacher"!==t.arg("mode")&&(n.total=!1),n.dropped=a&&a.d,n.summative=r.summative,t.data=n,t.hasData=!0,!!(!1!==n.total||n.status&&1!=n.status&&"0"!=n.status||n.cols)&&void 0},comment:function(e){var t=e.get_val("grades"),a=t&&t[e.nid()];if(a&&(a=a.c),e.data=a,e.inherit("icon"),1!=e.get_val("published")&&"teacher"!==e.arg("mode")||!a)return!1},esubmit:function(e){var t=e.get_val("grades"),a=t&&t[e.nid()];a&&(a=a.e),a&&e.addClass(e.selector()+"-hasSubmission"),e.data={submitted:a,resubmit:!!a,submit:!0},e.hasData=!0},date:function(e){var t=e.get_val("date")||e.get_val("cdate");t&&(e.displayVal=l.utils.assessmentDate(t)),e.sparse=!0},setStudentNid:function(e){var t=e.get_setting("url").split(".json/").pop().split("?").shift().split("/"),a=t[t.length-3];e.node.snid=a},studentView:function(t,a){var s=t.cssClass()+"-open";if(a.hasClass(s)&&!t.args.forceOpen)t.get_target("children:loader").fadeOut(function(){$(this).empty(),a.removeClass(s),$(this).show()});else{a.addClass(s),t.args.target="children:loader";var o=t.get_setting("student");t.args.thread=o,e.get_func("loadxds")(t,a),a.hasClass(e.css.unread)&&t.nt("user")===e.nt.User.Student()&&t.args.xdsClearUnread&&(t.args={xds:t.args.xdsClearUnread,nid:o+"/"+t.get_val("rid")+"/"+t.nid("node"),data:{nid:t.nid()}},e.get_func("post")(t,a))}},total:function(t){if(!t.has_role("Class Owner")&&1!=t.get_val("published"))return!1;var a=t.get_val("norm"),s=t.get_val();if(!1===s)return!1;var r="",n=o||e.get("gradebook")[t.nid("node")];a&&(r='<span class="xds-bookGrades-publish-total-percent">'+("2"!=t.get_val("summative")?n.normalizePercent(a)+"%":s)+"</span>"),t.displayVal=r+'<span class="xds-bookGrades-publish-total-score">'+s+"</span>",t.on("click",function(e){e.e.stopPropagation()})},dropped:function(e){e.data&&(e.displayVal='<span class="xds-bookGrades-publish-dropped">Dropped</span>')},summative:function(t){if(!t.data||"1"==t.data)return!1;var a=e.lookup("AssessmentAverageTypes",t.data).params;t.displayVal="<span>"+(a?a.label:"")+"</span>"},status:function(t){var a=t.get_val();t.addClass("dataBook-received-"+(a||"0")),0!=a&&1!==a?t.arg("title",e.lookup("dataBookStatusCodes",a).str()):(t.addStyle("display","none"),t.arg("title"," ")),t.displayVal="",t.inherit("icon")},assessment:function(t){var a=e.get("gradebook")[t.nid("node")],s=a.assessments[t.nid()]||{},o=s.thread;if(o=a.units[o],t.data.desc={name:s.name,type:s.type,unit:{unitName:o&&o.unitName}},!t.has_role("Class Owner")&&3==t.get_val("state"))return!1;var r=(t.get_val("publishedAssessments")||"").split(","),n=t.nid(),d=t.get_val("grades");d&&d[n]&&(d[n].u&&-1!==e.in_array(n+"",r)||d[n].n)&&t.nt("user")===e.nt.User.Student()&&(t.addClass(e.css.unread),t.ready(function(e,t){t.trigger("click")}))}}},c={};for(var u in i)c[u]="."+i[u];return t.bookGrades=l,l}),cf.resource("dataBook",function(){return cf.get("bookGrades")});

/* resources: dataBookCommentList */

"use strict";cf.resource("dataBookCommentList",function(t,e,a,n){return{init:function(e){e.get_val("historyrecs");var a,n,s=e.get_val("historyrecs")||[];if((a=t.get("gradebook")[t.gbl.nid])&&(n=a.students[e.get_setting("thread")])&&!s.length&&1==e.get_val("published")){var o={},i=n.grades[e.nid()],d=!1;o.t=i.a,i.c&&(o.ct=1,o.c=i.c,d=!0),n.normalized[e.nid()].average&&(o.gt=1,o.g=i.cols,d=!0),d&&(o.profpic=e.get_val("teacherProfpic"),o.name=e.get_val("teacherName"),!o.createid&&e.get_val("teacherNid")&&(o.createid=e.get_val("teacherNid")),s.push(o))}var r=e.get_val("comments")||{};if(s=t.obj_to_arr(r).concat(s),2==e.state.get("esubmit")){var c=e.state.get("TestScores")||[],l=e.state.get("onlineTestNid"),g=e.get_setting("thread");c.map(function(t,e){t.snum=e+1,t.t=t.date,t.createid=g,t.name=t.name||n.name,t.gtotal="".concat(!t.unmarked&&t.TestScore>=0?t.TestScore:"","/").concat(t.TestTotal),t.nodetype="6",t.nodesubtype="56",t.onlinetest=!0}),e.state.set("submissionlist",e.state.get("TestScores")),e.global("student",g),e.global("onlinetest",l),s=s.concat(c)}s=t.sort({sortBy:"t",sortType:"date"},s);var u=0;for(var m in s.map(function(e){e.createid=e.createid||e.a,"".concat(e.nodetype,".").concat(e.nodesubtype)!=t.nt("Message.ESubmission").val()&&"".concat(e.nodetype,".").concat(e.nodesubtype)!=t.nt("Document.OnlineTest").val()||(u+=1,e.subnum=u)}),s){var p=s[m];"".concat(p.nodetype,".").concat(p.nodesubtype)!=t.nt("Message.ESubmission").val()&&"".concat(p.nodetype,".").concat(p.nodesubtype)!=t.nt("Document.OnlineTest").val()||(p.esubtext=1==u?e.arg("titleSubmission"):e.tpl(e.arg("titleSubmissionMulti"),{i:p.subnum,total:u}))}e.state.set("commentListRecs",s),e.data.item=s},recordInit:function(e){e.data;if(e.nt()==t.nt.Document.GradeHistory()||e.nt()==t.nt.Message.GradeStatus())return!1;if(1!=e.get_val("published")&&e.rnode.nodetype===n&&(e.data.g=n,e.data.gt=n,e.data.c=n,e.data.ct=n,e.data.d=n,e.map(),!e.data.r))return!1;if(e.data.g){var a=t.get("gradebook")[t.gbl.nid];if(a){var s=a.publishedGrade(a.assessments[e.nid()],{cols:e.data.g});s.rcols&&s.rcols.length?e.data.gcols=s.rcols:e.get_val("c")?e.data.gtotalwithcomment=s.total:e.data.gtotal=s.total,e.map()}}},openGraderHost:function(t){t.newEvent("bookGrades.events.openGraderHost",{anid:t.data_full.nid,snid:t.get_setting("thread"),esnid:t.nid()})},graderAnnotationIcons:function(t){var e=t.state.get("annotations"),a=t.state.get("Content");e=e?e[t.nid()]:n;var s=t.state.get("apublished");s&&s[t.nid()]?(t.state.set("showMarked",!0),t.state.set("showPublished",!0)):e&&e.length&&t.state.set("showMarked",!0),!a||6!==a.nodetype||99!==a.nodesubtype&&100!==a.nodesubtype||t.state.set("livedoc",!0)}}});

/* resources: dataBookFeed */

"use strict";cf.resource("dataBookFeed",function(e,a,d){var n,t={ids:{},beforeUnload:function(e){bookGrades.hoverInspector.appendTo(e.caller().dom().parent())},height:function(e,a){return $(".dataBook-activityFeed-loader").height()},updateUnread:function(a,d){var t=e.get("dataBook").activityFeedUnread;if(t){var s=n.resolve().find(e.$css.unread).length;s?t.html(s).css("display",""):t.hide().css("display","none")}},init:function(a){var d=a.caller();if(!d)return!1;var s=e.get("gradebook")[d.nid("node")];n=a.ref();var r,o=[];try{r=JSON.parse(a.get_val("body"))}catch(e){r=[]}t.raw=r;for(var i,l,c,v,u=[],g=r.length,p=0;p<g;p++)i=r[p],l=s.assessments[i[2]],c=s.students[i[0]],v=i.length>=7?i[6]:void 0,l&&c&&(u.push(i),o.push({index:p,anid:l.nid,snid:c.nid,pnid:i[3],nid:c.nid,nodetype:e.nt.User(),nodesubtype:e.nt.User.Student(!0),body:{name:v||c.name,activity:i[1],assessment:l.name,student:v?c.name:void 0},unread:!!i[5]||void 0,creator:v}));u.length!==r.length&&(t.raw=u,a.ready(t.save)),o.reverse(),a.node.post=o,a.ready("dataBookFeed.updateUnread"),e.platform.tablet&&a.addStyle({"padding-right":"105px"}),a.inherit("scroll")},post:function(a){var d=a.get_val("snid"),n=a.get_val("anid"),s=e.get("gradebook")[a.caller().nid("node")].assessments[n],r=bookGrades.matrix[n];for(var o in r){if(!r[o]||!r[o][d])return!1;break}a.get_val("unread")&&a.addClass(e.css.unread),t.ids[d+"-"+n+"-"+a.get_val("index")]=a.path,a.tag("div",!1),s.individualAssessment&&!s.studentAssigned[d]&&a.addClass("unassigned"),a.on("click",function(a,s){bookGrades.feedFocusId=a.get_val("pnid");var r={col:"0",student:d,assessment:n},o=bookGrades.utils.getCell(r,a.caller());o||(r.col=void 0,o=bookGrades.utils.getCell(r,a.caller()));var i=bookGrades.matrix[n];for(var l in i){i=i[l][d];break}s.hasClass(e.css.unread)&&delete bookGrades.comments[n],delete bookGrades.prevFeed,o&&2==o.get_val("item-esubmit")?bookGrades.events.openGraderHost(a,s,{anid:n,snid:d,esnid:a.get_val("pnid")}):t.active===a.path?(bookGrades.hoverInspector.hide(),delete t.active):(t.active=a.path,bookGrades.utils.showHoverInspector(d,n,a.dom())),t.updateUnread(a)})},save:function(){var a=$(".dataBookFeed").xdo;if(a){for(var d=0,n=0,s=t.raw,r=s.length,o=0;o<r;o++)s[o][5]&&(1==s[o][1]||2==s[o]?d++:3==s[o][1]&&n++);e.post({xdo:a,data:{nesubmit:n,ncomment:d,body:JSON.stringify(t.raw)},callback:function(){e.notif.versions[a.nid()]++}})}},clearUnread:function(a,d){for(var n,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=t.raw,i=o&&o.length,l=t.ids,c=!1,v=0;v<i;v++)r&&(a=o[v][0],d=o[v][2]),o[v][5]!=s&&o[v][0]==a&&o[v][2]==d&&(o[v][5]=s,n=l[a+"-"+d+"-"+v],c=!0,s?$("#"+n).addClass(e.css.unread):$("#"+n).removeClass(e.css.unread));c&&t.save()},onUnreadPickerPicked:function(e){t.clearUnread(void 0,void 0,e.val(),!0)}};return t});

/* resources: dataBookImport */

"use strict";cf.resource("dataBookImport",function(e,t,s,a){var o=!1;e.resources.load(e.gbl.lib+"pkg/node_modules/jquery-csv/src/jquery.csv.js");var n={},r=[],d=0,i={handleFile:function(e,t){var s,a=t.target.result;if(jQuery.csv){try{a=a.replace(/\r\n|\n|\r/g,"\n"),s=jQuery.csv.toObjects(a)}catch(t){return void e.trigger("csv-error")}e.trigger("csv-success"),e.id(1).html('<span class="dataBookImport-upload-file-name">'+e.temp.file.name+"</span>"),l.results=s,l.utils.updatePickerChoices(s),o=!0,e.get_xdo("*form").dom().css("visibility","visible")}else setTimeout(function(){i.handleFile(e,a)},100)}},u=function(t,s){for(var a,o,n=s.length,r=0,d=0;d<n;d++)a=s[d],e.is_arr(a)?r+=u(t,a):(o=t.indexOf(a.toLowerCase()))>=0&&(r+=1,0!==o&&" "!==t[o-1]||(r+=1),o+a.length!==t.length&&" "!==t[o+a.length]||(r+=1));return r},l={pickers:{},smap:{},students:[],match:{id:"GUID",points:!1,outof:!1},utils:{bestGuess:function(e,t,s){e.init();var a,o,n=0;for(var r in s)(o=u(s[r].toLowerCase(),t))>0&&o>n&&(n=o,a=s[r]);n>0&&(e.set_val(a),e.triggerPicked())},updatePickerChoices:function(t){var s=t[0],a=[],o=[];for(var n in s)o.push(n),a.push({display:n,value:n});for(var r in l.pickers){var d=JSON.parse(JSON.stringify(a)),i=l.pickers[r].picker;"assessmentName"!=r&&"date"!=r&&"outof"!=r||d.push({display:e.lang("This is for one assessment and I will specify it ..."),value:"custom"}),i.get.array.call(i,d)}l.utils.bestGuess(l.pickers.id.picker,["StudentID",["Student",["ID","Number"]],"GUID",["First","Name"]],o),l.utils.bestGuess(l.pickers.last.picker,[["Last","Name"]],o),l.utils.bestGuess(l.pickers.assessmentName.picker,[["Published",["Assignment","Assessment","Test"],"Name"]],o),l.utils.bestGuess(l.pickers.date.picker,["Date",["Date",["Assignment","Assessment","Test"]]],o),l.utils.bestGuess(l.pickers.outof.picker,["Out Of","OutOf",["Points",["Possible","Max","Maximum"]]],o),l.utils.bestGuess(l.pickers.grade.picker,["Result",["Points",["Attained","Scored"]],"Grade"],o)},createNewImportAssessment:function(e,t,s,a){return{name:e,date:t,outof:s,matchedStudents:[],notFoundClassStudents:a,notFoundDataStudents:[],doImport:!0}},getGradeImportList:function(e,t){var s=[];for(var a in t.matchedStudents){var o=t.matchedStudents[a];s.push({snid:o.nid,anid:e,value:o.grade,col:0})}return s},sendServerAssessmentAndGrades:function(t,s,a,o,n,i,u){e.post({url:{nid:t,xds:s,command:"create",nodetype:e.nt.Document.Assignment()},data:{title:a.name,assdate:e.dateFormat(a.date,"iso"),nodetype:e.nt.Document.Assignment(),scheme:"gs_outof",gsData:JSON.stringify({0:a.outof}),summative:1,weighting:JSON.stringify({0:a.outof}),type:e.lookup("assessmentTypes","Assignment").val(),thread:o,state:0,published:0},callback:function(s){var o=s.nid,m=l.utils.getGradeImportList(o,a);e.xdsbuild({nid:t,xds:i,GradebookName:"gradebookImport-"+o,func:function(t){e.get("gradebook")["gradebookImport-"+o].postGrade({grades:m,success:function(t){if(r.push(o),r.length===d){var s=e.get("dataBook");s&&s.studentsOrder&&s.utils.saveFocussedCell({student:s.studentsOrder[0].nid,assessment:o}),e.get("lightbox.close")(),n.trigger("reload")}},xds:u})}})}})},updateSummary:function(e){var t=0,s=0;for(var a in n){var o=n[a];o.doImport&&(s++,t+=Object.keys(o.matchedStudents).length)}e.get_xdo("*footer-summary").dom().html("Will import "+t+" "+(1===t?"grade":"grades")+" in "+s+" "+(1===s?"assessment.":"assessments."))}},types:{upload:function(t){if(FileReader){var s=new FileReader;s.onload=function(e){i.handleFile(t,e)},t.preclosetag('<button class="xds-button">'+e.lang("Browse")+"</button>"),t.preclosetag('<input type="file">'),t.on("change",function(e,t){var a=t.find("input")[0].files;e.temp.file=a[0],s.readAsText(e.temp.file)}),t.ready(l.events.init)}else t.xds.title=e.lang("Sorry, your browser does not support CSV grade imports."),t.inherit("noContent").exit()},student:function(e){var t=e.get_val();return l.smap[t.nid]||(l.smap[t.nid]=t,l.students.push(t)),!1}},events:{init:function(e){var t=l.pickers;t.id=e.get_xdo("*form-id-id"),t.last=e.get_xdo("*form-id-last"),t.assessmentName=e.get_xdo("*form-name-assessment"),t.date=e.get_xdo("*form-date-date"),t.outof=e.get_xdo("*form-outof-outof"),t.grade=e.get_xdo("*form-grade-grade"),l.match.eid=e.get_xdo("*form-id-eid").picker.get_val()},csvError:function(){},changeIDField:function(e,t,s){var a=e.get_target("sibling:last",1);l.match.eid=s.value,"name"===s.value?a.css("display","inline-block"):a.hide(),l.events.process(e,t)},settingChanged:function(e,t,s){var a=l.match,o=e.args.field;if("name"==o||"date"==o||"outof"==o){var n=e.get_xdo("*"+("name"==o?"assessment":o)+"Custom");"custom"==e.picker.get_val()?n.dom().css("display","inline-block"):n.dom().hide()}a[o]=e.picker.get_val(),a.id&&a.grade&&l.events.process(e,t)},importControlChanged:function(e,t,s){var a=e.parent_xdo().parent_xdo().get_xdo("children:details-name").get_val();"noImport"===e.val()?(e.dom().parent().parent().addClass("noimport"),n[a].doImport=!1):(e.dom().parent().parent().removeClass("noimport"),n[a].doImport=!0),l.utils.updateSummary(e.get_target(".dataBookImport-footer",!0).xdo)},process:function(t,s,a){var o=l.match,r=l.students,d=l.results;n={};var i=r.length;if(d&&d.length){if(o.id&&o.grade){for(var u,m,c={},p=[];i--;)u=r[i],c[m="name"===o.eid?u.last.toLowerCase()+","+u.first.toLowerCase():"StudentID"!=o.eid||u[o.eid]?u[o.eid]:u.GUID]?p.push(u):c[m]=u;for(var g=0;g<d.length;g++){var f,v=d[g],h=n[v[o.name]];if(!h){var x=JSON.parse(JSON.stringify(c));h=l.utils.createNewImportAssessment("custom"===o.name?t.get_xdo("*assessmentCustom").val():v[o.name],"custom"===o.date?t.get_xdo("*dateCustom").val():e.dateFormat(e.parseDate(v[o.date])?e.parseDate(v[o.date]):new Date(v[o.date]),"yyyy-mm-dd 04:00:00"),"custom"===o.outof?t.get_xdo("*outofCustom").val():v[o.outof],x),n[v[o.name]]=h}if(f="name"===o.eid?v[o.last].toLowerCase()+","+v[o.id].toLowerCase():v[o.id],h.notFoundClassStudents[f]){var k=h.notFoundClassStudents[f];h.matchedStudents.push({nid:k.nid,name:{first:k.first,last:k.last},grade:v[o.grade]}),delete h.notFoundClassStudents[f]}else h.notFoundDataStudents.push(v)}}var y=[];for(var _ in n)h=n[_],y.push({title:{number:y.length+1+":",found:{found:""+h.matchedStudents.length,of:""+r.length}},details:{name:h.name,date:e.dateFormat(h.date,"M D, Y"),outof:h.outof,notFoundData:h.notFoundDataStudents.length,notFoundClass:Object.keys(h.notFoundClassStudents).length+(p?p.length:0)},students:{student:h.matchedStudents}});var b=t.xds_full.fields.displayAssessments,S=JSON.parse(JSON.stringify(b.fields.assessmentTemplate));S.id=t.xdsid()+"-"+b.id+"-"+S.id,e.xdsbuild({slice:{xds:S,data:{assessments:y},perm:t._perm},target:t.target("*displayAssessments"),transition:!1}),t.get_xdo("*displayAssessments").dom().show(),l.utils.updateSummary(t.get_xdo("*footer"))}},doImport:function(t,s,a){if(o){var r=t.get_xdo("*form");if(e.get_func("validateForm")(r.xdo,r.dom()),!(r.find(".xds-validate-failed").length>0)){for(var i in t.get_xdo("*footer-cancel").dom().hide(),t.get_xdo("*footer-import").dom().hide(),t.get_xdo("*footer-summary").dom().hide(),t.get_xdo("*footer").dom().append(e.html.loading()),n){var u=n[i];u.doImport&&d++}for(i in n)(u=n[i]).doImport&&l.utils.sendServerAssessmentAndGrades(t.nid(),t.global("xdsImport"),u,t.get_xdo("*unitPicker").val(),t.caller(),t.global("xdsGradeBookData"),t.global("xdsGrades"))}}}}};return t.dataBookImport=l,l});
});
